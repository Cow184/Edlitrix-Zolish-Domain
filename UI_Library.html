<style>
/* =========================================
   1. VARIABLES & RESET
   ========================================= */
:root { 
    --ezd-primary: #8B0000; 
    --ezd-primary-text: #8B0000;
    --ezd-primary-light: rgba(139, 0, 0, 0.1); 
    --ezd-primary-shadow: rgba(139, 0, 0, 0.3);
    --ezd-border: #e2e8f0; 
    --ezd-text: #334155; 
    --ezd-text-light: #64748b; 
    --ezd-bg: #ffffff; 
    --ezd-radius: 12px; 
}

[data-ezd-type] { 
    display: block !important; 
    width: 100%; 
    margin-bottom: 15px; 
    box-sizing: border-box !important;
    position: relative !important; /* <--- THE ANCHOR FIX */
    z-index: 1; /* Sets a base layer */
}

/* =========================================
   2. MODAL SYSTEM
   ========================================= */
.ezd-dialog-overlay { 
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); 
    display: none !important; align-items: center; justify-content: center; 
    z-index: 1000000; 
}
.ezd-dialog-overlay.visible { display: flex !important; }

.ezd-dialog-box { 
    background: #ffffff; width: 95%; max-width: 750px; 
    border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
    overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; 
}

.ezd-dialog-content { padding: 25px; overflow-y: auto; }
.ezd-dialog-footer { 
    padding: 20px 25px; border-top: 1px solid #f1f5f9; 
    display: flex; gap: 10px; background: #fff; 
}

/* =========================================
   3. UNIVERSAL INPUTS
   ========================================= */
.ezd-input-group { margin-bottom: 15px; width: 100%; }
.ezd-input-wrapper { position: relative; width: 100%; }

/* Core Input Style */
.ezd-smart-input, .ezd-select-trigger, .multiselect-trigger, .ezd-list-input { 
    width: 100%; height: 48px !important; min-height: 48px !important; 
    padding: 0 16px 0 42px !important; 
    background: #fff !important; 
    border: 1.5px solid #e2e8f0 !important; 
    border-radius: 12px !important; 
    font-size: 14px; color: #334155; 
    display: flex; align-items: center; 
    box-sizing: border-box !important; 
    transition: 0.2s; cursor: pointer; position: relative; font-family: inherit;
}

.ezd-smart-input:focus, .ezd-select-trigger:focus, .multiselect-trigger:focus, .ezd-list-input:focus { 
    border-color: var(--ezd-primary) !important; 
    box-shadow: 0 0 0 4px var(--ezd-primary-light) !important; 
    outline: none; 
}

.ezd-smart-input[readonly] {
    caret-color: transparent; 
    cursor: pointer;
    user-select: none; 
}

.ezd-fixed-icon { 
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%); 
    color: #94a3b8; font-size: 14px; pointer-events: none; 
    z-index: 20 !important; /* <--- Boosted to beat the hover state */
}

.ezd-smart-input::placeholder {
    transition: all 0.3s ease; opacity: 0.5; transform: translateX(0);
}
.ezd-smart-input:focus::placeholder {
    opacity: 0.2; transform: translateX(10px);
}

textarea.ezd-smart-input { 
    height: auto !important; min-height: 100px !important; 
    padding-top: 12px !important; resize: vertical; 
}
.ezd-input-wrapper textarea + .ezd-fixed-icon { top: 24px; transform: none; }

.ezd-pwd-toggle { 
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
    color: #94a3b8; cursor: pointer; transition: 0.2s; font-size: 14px; 
    z-index: 20 !important; /* <--- KEEPS IT ON TOP */
}
.ezd-pwd-toggle:hover { color: #334155; }

.ezd-unit-toggle { 
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
    background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; 
    border-radius: 6px; font-size: 11px; font-weight: 700; padding: 6px 10px; 
    cursor: pointer; transition: 0.2s; z-index: 10; min-width: 35px; text-align: center; 
}
/* TOOLTIP SYSTEM */
.ezd-help-icon {
    display: inline-block; margin-left: 6px; color: #94a3b8; cursor: help; font-size: 11px;
    position: relative; transition: 0.2s;
}
.ezd-help-icon:hover { color: var(--ezd-primary); }
.ezd-unit-toggle:hover { background: #e2e8f0; color: #1e293b; border-color: #94a3b8; }

/* =========================================
   4. DROPDOWNS & LISTS
   ========================================= */
   /* Accessibility Focus for Dropdowns */
.ezd-select-option:focus, .multiselect-option:focus {
    background-color: #f1f5f9;
    outline: none; /* We use background instead */
}
/* Dark Mode support */
body.ezd-dark-mode .ezd-select-option:focus, 
body.ezd-dark-mode .multiselect-option:focus {
    background-color: #334155 !important;
}
.ezd-select-container, .multiselect-wrapper { position: relative; width: 100%; }
.multiselect-wrapper {
    position: relative;
    width: 100%;
    /* FIX: Allow this wrapper to shrink inside a CSS Grid/Flex parent */
    min-width: 0; 
}

.ezd-select-menu, .multiselect-menu { 
    position: absolute !important; 
    left: 0 !important;
    right: 0 !important; /* Forces it to match parent width */
    top: calc(100% + 4px) !important; /* Pushes it just below the input */
    width: auto !important; /* Let left/right handle the width */
    
    background: white !important; 
    border: 1.5px solid var(--ezd-border); 
    border-radius: 12px; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
    z-index: 99999 !important; /* Float above everything */
    display: none; 
    max-height: 300px; 
    overflow-y: auto; 
    opacity: 0;
    transform: translateY(-10px) scale(0.96); /* Start position */
    transform-origin: top center;
    transition: 
        opacity 0.2s ease,
        transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* The Bounce */
    pointer-events: none; /* Can't click while hidden */
    
}
.ezd-select-menu.visible, .multiselect-menu.visible { display: block; }

.ezd-select-option, .multiselect-option { 
    padding: 12px 15px; cursor: pointer; font-size: 13px; color: #334155; 
    border-bottom: 1px solid #f8fafc; 
}
.ezd-select-option:hover, .multiselect-option:hover { background: #fff1f2; color: var(--ezd-primary); }
.ezd-select-option.selected, .multiselect-option.selected { background: #fef2f2; font-weight: 600; color: var(--ezd-primary); }

/* Ensure Icon stays on top */
.ezd-fixed-icon { z-index: 20 !important; }

.multiselect-content {
    /* LOCK HEIGHT */
    height: 38px !important;
    max-height: 38px !important;
    
    /* FLEX LAYOUT */
    display: flex; 
    align-items: center; 
    gap: 4px;
    flex-wrap: nowrap !important; /* No wrapping */
    
    /* FIX: The "Anti-Bully" property */
    flex: 1 1 0%;   /* Grow: 1, Shrink: 1, Basis: 0% (Critical!) */
    min-width: 0;   /* Allow shrinking smaller than children */
    width: 0;       /* Fallback for older browsers to force calculation */
    
    padding: 0 0 0 42px !important; 
    overflow: hidden; 
    position: relative;
}


.selected-tag {
    /* SQUISH: Allow shrinking */
    flex: 0 1 auto; 
    min-width: 0 !important; /* <--- Critical for text-overflow to work */
    max-width: 100%;         /* Don't ever exceed parent */
    
    /* TEXT: Truncate */
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis;
    
    /* SHAPE */
    border-radius: 999px;
    padding: 0 12px; 
    padding-right: 26px; /* Room for X */
    margin: 2px 0;
    height: 28px;
    line-height: 26px;
    
    font-size: 11px; font-weight: 700; text-transform: uppercase; color: #334155;
    background: #e2e8f0; border: 1px solid #cbd5e1;
    position: relative;
    
    will-change: transform, width, opacity;
    /* Use 'all' or list specific props. 'all' is safer for squish physics. */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.selected-tag .tag-remove {
    position: absolute; right: 2px; top: 50%; transform: translateY(-50%);
    width: 20px; height: 100%; /* Full height click area */
    display: flex; align-items: center; justify-content: center;
    border-radius: 0 999px 999px 0; /* Right pill shape */
    background: transparent;
    cursor: pointer; z-index: 10;
}
.selected-tag .tag-remove:hover { background: #ef4444; color: white; }

/* HIDE X BUTTON WHEN SQUISHED */
@container (max-width: 60px) {
    .selected-tag { padding-right: 12px !important; } /* Reclaim padding */
    .selected-tag .tag-remove { display: none; }
}

/* Animations */
.selected-tag.exiting {
    max-width: 0px !important; padding: 0 !important; margin: 0 !important; border: 0 !important;
    opacity: 0; transform: translateX(-50px); pointer-events: none;
}
.selected-tag.entering {
    animation: tagEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}
@keyframes tagEnter {
    0% { opacity: 0; transform: translateX(50px); max-width: 0; }
    40% { opacity: 1; transform: translateX(-5px); max-width: 200px; }
    100% { transform: translateX(0); }
}

@keyframes tagExit {
    0% { opacity: 1; transform: translateX(0); max-width: 200px; margin: 2px 0; padding: 0 12px; }
    100% { opacity: 0; transform: translateX(-100px); max-width: 0; margin: 0; padding: 0; border: 0; }
}

.selected-tag .tag-remove {
    position: absolute; 
    right: 4px; 
    top: 50%; 
    transform: translateY(-50%);
    
    cursor: pointer; font-size: 10px; opacity: 0.6;
    width: 16px; height: 16px; 
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%; transition: 0.2s; z-index: 5;
    background: rgba(255,255,255,0.7); /* Semi-transparent bg for readability */
    z-index: 10;
}
.selected-tag .tag-remove:hover { background: #ef4444; color: white; opacity: 1; }

body.ezd-dark-mode .selected-tag {
    background-color: #334155 !important; border-color: #475569 !important; color: #f1f5f9 !important;
}
body.ezd-dark-mode .selected-tag .tag-remove:hover { background: #ef4444; }

/* =========================================
   5. LIST MANAGER (v25 - Search Bar & 102% Width)
   ========================================= */

/* Main Container */
.ezd-list-manager { 
    width: 100%; display: block; 
    background: #ffffff; border: 1px solid #e2e8f0; 
    border-radius: 12px; 
    /* WAS: overflow: hidden; */
    overflow: visible; /* <--- CHANGED: Allows dropdowns to spill out */
}

/* --- SEARCH TOOLBAR (Updated for Title) --- */
.ezd-list-toolbar {
    padding: 10px 16px; 
    border-bottom: 1px solid #e2e8f0; 
    background: #ffffff;
    display: flex; 
    align-items: center; /* Vertically center title and search */
}

.ezd-list-title {
    font-size: 14px; 
    font-weight: 700; 
    color: #1e293b; 
    letter-spacing: 0.5px;
}

.ezd-list-search-wrapper { 
    margin-left: auto; /* <--- MAGIC: Pushes search to the far right */
    position: relative; 
    width: 220px; 
}

.ezd-list-search-wrapper i {
    position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
    color: var(--ezd-text-light); font-size: 12px; pointer-events: none;
}
.ezd-list-search-input {
    width: 100%; height: 32px; padding: 0 10px 0 30px; 
    border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; color: #334155;
    background: #f8fafc; transition: 0.2s; outline: none; box-sizing: border-box;
}
.ezd-list-search-input:focus {
    background: #ffffff; border-color: var(--ezd-primary);
    box-shadow: 0 0 0 3px var(--ezd-primary-light);
}

/* --- LAYOUTS --- */

/* Allows list inputs to shake and turn red when duplicate/invalid */
.ezd-list-item input.invalid,
.ezd-add-grid input.invalid {
    animation: shakeHead 0.4s ease-in-out;
    border-color: #ef4444 !important;
    background-color: #fff5f5 !important;
}

.ezd-grid-layout-data {
    display: grid;
    grid-template-columns: repeat(var(--col-count, 1), 1fr) 60px;
    gap: 12px; width: 100%; align-items: center;
    padding: 10px 16px; box-sizing: border-box;
}

.ezd-grid-layout-footer {
    display: grid;
    grid-template-columns: repeat(var(--col-count, 1), 1fr) 0px;
    gap: 12px; width: 100%; align-items: center;
    padding: 10px 16px; box-sizing: border-box;
}

/* Danger Mode Override */
.ezd-list-item.danger-mode {
    grid-template-columns: repeat(var(--col-count, 1), 1fr) 140px !important;
}

/* Header */
.ezd-list-header-row { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
.ezd-col-header {
    font-size: 11px; color: var(--ezd-text-light); 
    font-weight: 800;
    text-transform: uppercase; letter-spacing: 0.05em;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* Data Rows */
.ezd-list-item { 
    background: white; 
    border-bottom: 1px solid #f1f5f9; 
    transition: 0.2s;
    
    /* NEW ANIMATION: Slide Down & Fade In */
    animation: slideInRow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    transform-origin: top center;
}
.ezd-list-item:hover { background: #f8fafc; }

@keyframes slideInRow {
    0% {
        opacity: 0;
        transform: translateY(-20px) scale(0.98);
        max-height: 0; /* Helps push content down */
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
        max-height: 100px; /* Arbitrary limit, ensures flow */
    }
}

@keyframes slideOutCollapse {
    0% { 
        opacity: 1; 
        transform: translateX(0); 
        max-height: 50px; /* Approx height of a row */
        margin-bottom: 0;
        padding: 6px 8px; /* Maintain padding start */
    }
    40% { 
        opacity: 0; 
        transform: translateX(20px); /* Swipe Right */
        max-height: 50px; 
        padding: 6px 8px;
    }
    100% { 
        opacity: 0; 
        transform: translateX(20px); 
        max-height: 0; /* Collapse Space */
        margin-bottom: 0;
        padding-top: 0; 
        padding-bottom: 0; 
        border-bottom: none;
    }
}

.ezd-list-item.deleting {
    animation: slideOutCollapse 0.4s ease-in-out forwards;
    pointer-events: none; /* Prevent clicking while dying */
    z-index: 0 !important; /* Ensure it stays behind neighbors */
}

/* Find this existing rule and update it: */
.ezd-list-item input {
    width: calc(102% - 20px); 
    min-width: 0; display: block;        
    background: transparent; 
    border: 1px solid transparent; 
    
    /* --- ADD THIS LINE --- */
    border-right: 2px solid #e2e8f0; 
    /* --------------------- */

    padding: 6px 8px; font-size: 13px; color: #334155;
    transition: 0.2s; border-radius: 6px; height: 32px;
}

/* --- ADD THIS NEW RULE RIGHT AFTER IT --- */
.ezd-list-item input:last-of-type { 
    border-right: 1px solid transparent; 
}

.ezd-list-item input:focus, .ezd-list-item input:hover {
    background: white; border-color: #cbd5e1;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); outline: none;
}

/* Footer Section */
.ezd-add-section { background: #f1f5f9; border-top: 1px solid #e2e8f0; width: 100%; }
.ezd-add-grid { border-bottom: none; padding-bottom: 0; }

.ezd-add-grid input {
    width: calc(102% - 20px); /* <--- AND HERE */
    min-width: 0; height: 38px; padding: 0 10px;
    background: white; border: 1px solid #cbd5e1; border-radius: 6px;
    font-size: 13px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.ezd-add-grid input:focus { border-color: var(--ezd-primary); outline: none; }

/* Actions */
.ezd-action-col { display: flex; gap: 8px; justify-content: flex-end; align-items: center; }

/* Icons */
.ezd-icon-btn { 
    width: 28px; height: 28px; border-radius: 4px; 
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 13px; color: #94a3b8; transition: 0.2s; 
}
.ezd-icon-btn:hover { background: #e2e8f0; color: var(--ezd-primary); }
.ezd-icon-btn.save { color: #10b981; } .ezd-icon-btn.cancel { color: #ef4444; }

/* Text Buttons */
.ezd-btn-confirm { 
    background: #ef4444; color: white; border: none; padding: 0 12px; height: 28px; 
    border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; 
}
.ezd-btn-cancel { 
    background: white; color: #64748b; border: 1px solid #cbd5e1; padding: 0 12px; height: 28px; 
    border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; 
}

/* Add Button */
.ezd-add-btn-large {
    width: calc(100% - 32px); margin: 8px 16px 16px 16px; padding: 10px;
    background: var(--ezd-primary); color: white; border: none; border-radius: 8px;
    font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: 0.2s; box-shadow: 0 4px 6px rgba(139, 0, 0, 0.2);
}
.ezd-add-btn-large:hover { background: #7f1d1d; transform: translateY(-1px); }
/* =========================================
   6. COLORS, BUTTONS, LABELS
   ========================================= */
.ezd-color-picker-wrapper { display: flex; gap: 8px; flex-wrap: wrap; padding: 5px 0; }
.color-dot { 
    width: 32px; height: 32px; border-radius: 50%; cursor: pointer; 
    border: 3px solid transparent; transition: 0.2s; 
}
.color-dot.active { border-color: #cbd5e1; transform: scale(1.1); }

.ezd-save-btn.idle { background: #f1f5f9; color: #94a3b8; cursor: default; }
.ezd-save-btn.saving { background: #f59e0b; color: white; cursor: wait; }
.ezd-save-btn.success { background: #10b981; color: white; }

.ezd-label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 6px; margin-left: 2px; }

.ezd-input-group:focus-within .ezd-label {
    color: var(--ezd-primary-text) !important;
    text-shadow: 0 0 15px rgba(255,255,255,0.1);
    transition: all 0.3s ease;
}

/* =========================================
   7. SLIDERS & SEGMENTED
   ========================================= */
.ezd-slider-container { padding: 5px 0 15px 0; width: 100%; user-select: none; font-family: inherit; }
.ezd-slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 13px; color: var(--ezd-text-light); }
.ezd-slider-display input { 
    /* Remove default ugly borders */
    border: none; background: transparent;
    
    /* Typography */
    font-weight: 700; color: var(--ezd-text); 
    font-family: monospace; font-size: 14px; 
    text-align: right; width: 60px;
    
    /* subtle focus state */
    outline: none; border-bottom: 1px solid transparent;
    transition: 0.2s;
}
.ezd-slider-display input:focus {
    border-bottom-color: var(--ezd-primary);
}

.ezd-track-wrap { position: relative; height: 28px; display: flex; align-items: center; cursor: pointer; touch-action: none; }
.ezd-track { width: 100%; height: 6px; background: #e2e8f0; border-radius: 4px; position: relative; overflow: visible; }
.ezd-track-fill { position: absolute; height: 100%; background: var(--ezd-primary); border-radius: 4px; top: 0; pointer-events: none; z-index: 1; }

.ezd-handle { 
    width: 18px; height: 18px; background: #ffffff; border: 2px solid var(--ezd-primary); 
    border-radius: 50%; position: absolute; top: 50%; transform: translate(-50%, -50%); 
    cursor: grab; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: box-shadow 0.1s, transform 0.1s; 
    z-index: 3; outline: none; 
}
.ezd-handle:hover { transform: translate(-50%, -50%) scale(1.1); }
.ezd-handle:focus { box-shadow: 0 0 0 4px var(--ezd-primary-light); border-color: var(--ezd-primary); }
.ezd-handle:active { cursor: grabbing; transform: translate(-50%, -50%) scale(0.95); background: var(--ezd-primary); }

.ezd-seg-wrapper { margin-bottom: 15px; }
.ezd-seg-container { display: flex; position: relative; background: #f1f5f9; border-radius: 10px; padding: 4px; border: 1px solid #e2e8f0; user-select: none; overflow: hidden; }

.ezd-seg-glider { 
    position: absolute; top: 4px; bottom: 4px; left: 4px; 
    background: #ffffff; border-radius: 8px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    transition: transform 0.25s cubic-bezier(0.2, 0.0, 0.2, 1); 
    z-index: 1; pointer-events: none; 
}
.ezd-seg-option { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 8px; font-size: 13px; font-weight: 500; color: #64748b; cursor: pointer; position: relative; z-index: 2; transition: color 0.2s; text-align: center; border-radius: 8px; }
.ezd-seg-option:hover { color: #334155; }
.ezd-seg-option.active { color: var(--ezd-primary); font-weight: 600; }
/* =========================================
   8. TABS SYSTEM
   ========================================= */
.ezd-tabs-root { display: flex; flex-direction: column; width: 100%; font-family: inherit; }
.ezd-tab-list { display: flex; border-bottom: 2px solid #e2e8f0; position: relative; overflow-x: auto; scrollbar-width: none; gap: 2px; }

.ezd-tab-btn { 
    padding: 12px 16px; cursor: pointer; color: #64748b; font-weight: 500; font-size: 14px; 
    display: flex; align-items: center; gap: 8px; position: relative; transition: all 0.2s; 
    white-space: nowrap; background: none; border: none; outline: none; user-select: none; 
}
.ezd-tab-btn:hover { color: #334155; background: #f8fafc; }
.ezd-tab-btn.active { color: var(--ezd-primary-text) !important; font-weight: 600; }
.ezd-tab-btn::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: transparent; transition: 0.2s; }
.ezd-tab-btn.active::after { background: var(--ezd-primary-text) !important; }

.ezd-tab-panel { display: none; animation: fadeIn 0.3s ease; padding: 15px 5px; }
.ezd-tab-panel.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* =========================================
   9. SPECIALTY (Phone, Search, Units)
   ========================================= */
   /* LIGHTER PHONE PLACEHOLDERS */
.ezd-phone-number::placeholder,
.ezd-phone-code::placeholder {
    color: #cbd5e1 !important; /* Much lighter grey */
    opacity: 1;
}
.ezd-phone-wrapper { display: flex; border: 1.5px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: 0.2s; background: #fff; align-items: center; height: 48px; box-sizing: border-box; }
.ezd-phone-wrapper:focus-within { border-color: var(--ezd-primary); box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); }
.ezd-phone-code { width: 60px; border: none; background: #f8fafc; border-right: 1px solid #e2e8f0; text-align: center; font-weight: 600; color: #64748b; outline: none; height: 100%; margin: 0; }
.ezd-phone-number { flex: 1; border: none; padding-left: 15px; outline: none; height: 100%; font-size: 14px; }

/* --- SEARCH DROPDOWN STYLING --- */
.ezd-search-results { 
    position: absolute; 
    top: 100%; left: 0; right: 0; 
    background: white; 
    border: 1px solid #e2e8f0; 
    border-radius: 12px; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
    z-index: 9999999; /* Nuclear Z-Index option */
    margin-top: 5px; 
    max-height: 300px; 
    overflow-y: auto; 
    display: none; 
}

.ezd-search-item { 
    padding: 12px 15px; 
    cursor: pointer; 
    font-size: 13px; 
    border-bottom: 1px solid #f8fafc; 
    display: flex; align-items: center; gap: 10px; 
    color: #334155; 
}

.ezd-search-item:hover { 
    background: #fff1f2; 
    color: var(--ezd-primary); 
}

/* --- SEARCH DROPDOWN DARK MODE --- */
body.ezd-dark-mode .ezd-search-results {
    background-color: #1e293b !important;
    border-color: #334155 !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important;
}

body.ezd-dark-mode .ezd-search-item {
    color: #f1f5f9 !important;
    border-bottom: 1px solid #334155 !important;
}

body.ezd-dark-mode .ezd-search-item:hover {
    background-color: #334155 !important;
    color: var(--ezd-primary-text) !important;
}

/* Fix Icon Color in Dark Mode */
body.ezd-dark-mode .ezd-search-item i {
    color: #94a3b8 !important;
}

.ezd-hugging-container { position: absolute; left: 42px; top: 0; bottom: 0; right: 60px; display: flex; align-items: center; pointer-events: none; }
.ezd-ghost-span { visibility: hidden; white-space: pre; font-family: inherit; font-size: 14px; }
.ezd-unit-suffix { color: #94a3b8; font-weight: 500; margin-left: 2px; font-size: 14px; }

.ezd-action-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #64748b; cursor: pointer; padding: 8px; transition: 0.2s; }
.ezd-action-btn:hover { color: var(--ezd-primary); }

/* =========================================
   10. SYSTEM POLISH (Neon, Liquid, Animations)
   ========================================= */

/* A. Neon Selection */
::selection { background: rgba(139, 0, 0, 0.9); color: #ffffff; text-shadow: 0 0 5px rgba(255, 255, 255, 0.8); }

/* B. Liquid Scrollbar */
::-webkit-scrollbar { width: 14px; height: 14px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { 
    background-color: #cbd5e1; border: 5px solid transparent; 
    background-clip: content-box; border-radius: 99px; 
    transition: background-color 0.3s ease, border-width 0.3s ease; 
}
::-webkit-scrollbar-thumb:hover { background-color: var(--ezd-primary); border: 3px solid transparent; }

/* C. Green Pulse (Outward Sonar) */
@keyframes pulseOutGreen {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); border-color: #10b981; }
    70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); border-color: #10b981; }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); border-color: #e2e8f0; }
}
.ezd-smart-input.valid { animation: pulseOutGreen 0.4s ease-out !important; background: #fff !important; }

/* D. Grey Ripple (Ghost Impact - 4px) */
@keyframes rippleInGrey {
    0% { box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1), inset 0 0 0 0px rgba(100, 116, 139, 0.2); border-color: var(--ezd-primary); }
    100% { box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1), inset 0 0 0 6px rgba(100, 116, 139, 0); border-color: var(--ezd-primary); }
}
.ezd-smart-input.typing { animation: rippleInGrey 0.15s ease-out forwards; }

/* E. Icon Physics (Drift + Pop - Fixed Center) */
@keyframes drift {
    0% { transform: translateY(-50%); } 
    50% { transform: translateY(-65%); } 
    100% { transform: translateY(-50%); } 
}
@keyframes popEffect {
    0% { scale: 1; rotate: 0deg; }
    50% { scale: 1.2; rotate: -10deg; } 
    100% { scale: 1; rotate: 0deg; }
}
.ezd-input-wrapper:focus-within .ezd-fixed-icon {
    color: var(--ezd-primary-text) !important;
    animation: drift 3s ease-in-out infinite, popEffect 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* F. The "Nope" Shake (Lateral Only - Safe for Wide Inputs) */
@keyframes shakeHead {
    0%, 100% { transform: translateX(0); }
    15% { transform: translateX(-6px); } 
    30% { transform: translateX(6px); }
    45% { transform: translateX(-4px); }
    60% { transform: translateX(4px); }
    75% { transform: translateX(-2px); }
}
.ezd-smart-input.invalid { animation: shakeHead 0.4s ease-in-out !important; border-color: #ef4444 !important; background: #fff5f5 !important; }

/* G. Hover Lift */
.ezd-smart-input:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px rgba(0,0,0,0.03); }

/* --- THE "FROZEN" STATE (Disabled Inputs) --- */

/* 1. The Container: Looks etched/frosted */
.ezd-smart-input:disabled, 
.ezd-select-trigger.disabled {
    background-color: #f1f5f9 !important; /* Ice Grey */
    color: #94a3b8 !important; /* Muted Text */
    cursor: not-allowed;
    border-color: #e2e8f0 !important;
    box-shadow: none !important;
    
    /* The "Frost" Effect */
    background-image: linear-gradient(135deg, #f1f5f9 25%, #f8fafc 25%, #f8fafc 50%, #f1f5f9 50%, #f1f5f9 75%, #f8fafc 75%, #f8fafc 100%);
    background-size: 20px 20px;
    opacity: 0.8;
}

/* 2. The Icon: Goes to sleep (Greyscale) */
.ezd-input-wrapper:has(input:disabled) .ezd-fixed-icon {
    color: #cbd5e1 !important; /* Sleep Grey */
    animation: none !important; /* Stop floating/bouncing */
    transform: translateY(-50%) scale(0.9); /* Shrink slightly */
}

/* 3. No Hover Effects */
.ezd-smart-input:disabled:hover {
    border-color: #e2e8f0;
    box-shadow: none;
}
/* =========================================
   11. GLOBAL HOVER ENGINE (New)
   ========================================= */
/* This forces a unified hover style across the entire system */

.ezd-smart-input:hover, 
.ezd-select-trigger:hover, 
.multiselect-trigger:hover,
.ezd-list-item input:hover,
.ezd-add-grid input:hover {
    /* 1. Stronger Border (High Contrast) */
    border-color: #64748b !important; 
    
    /* 2. The "Lift" Effect (Soft Shadow) */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08) !important; 
    
    /* 3. Pure White Background */
    background-color: #ffffff !important;
    
    /* 4. Layering (Pops it on top of neighbors) */
    z-index: 10; 
    
    /* Smooth Transition */
    transition: all 0.2s ease-in-out;
}

/* Ensure the cursor indicates text editing for inputs */
.ezd-smart-input:hover, .ezd-list-item input:hover {
    cursor: text;
}
/* Ensure the cursor indicates pointing for dropdowns */
.ezd-select-trigger:hover, .multiselect-trigger:hover {
    cursor: pointer;
}
/* =========================================
   15. EMPTY STATE (New)
   ========================================= */
.ezd-empty-state {
    padding: 30px;
    text-align: center;
    color: #94a3b8;
    font-size: 13px;
    font-weight: 500;
    font-style: italic;
    background: #ffffff;
    display: none; /* Hidden by default */
}
/* =========================================
   16. UNIVERSAL FROST (Disabled States)
   ========================================= */

/* Frozen Sliders */
.ezd-slider-container.disabled {
    opacity: 0.6; pointer-events: none; filter: grayscale(100%);
}
.ezd-slider-container.disabled .ezd-track-fill,
.ezd-slider-container.disabled .ezd-handle {
    background: #cbd5e1 !important; border-color: #94a3b8 !important;
}

/* Frozen Segmented Controls */
.ezd-seg-container.disabled {
    opacity: 0.6; pointer-events: none; background: #f1f5f9;
}
.ezd-seg-container.disabled .ezd-seg-option {
    color: #94a3b8 !important;
}

/* Frozen Tabs */
.ezd-tab-btn.disabled {
    color: #cbd5e1 !important; cursor: not-allowed;
}

/* Frozen Save Buttons */
.ezd-save-btn:disabled {
    background-color: #e2e8f0 !important; color: #94a3b8 !important;
    box-shadow: none !important; cursor: not-allowed;
}
/* Mobile Responsiveness */
    @media (max-width: 768px) {
        .ui-grid-2, .ui-grid-3, .ui-grid-4 { 
            grid-template-columns: 1fr !important; 
            gap: 15px;
        }
        .ui-section { padding: 15px; }
        .ui-header { flex-direction: column; gap: 15px; align-items: flex-start; }
        .ui-header > div:last-child { width: 100%; justify-content: space-between; }
        .ezd-add-btn-large { width: 100%; margin: 10px 0 0 0; }
        
        /* List Manager Mobile Adjustment */
        .ezd-list-manager { overflow-x: auto; }
        .ezd-grid-layout-data, .ezd-grid-layout-footer { min-width: 600px; } /* Force scroll instead of squish */
    }
/* --- ACCORDION (The "Pod" Style) --- */
.ezd-accordion {
    width: 100%;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    transition: 0.2s border-color, 0.2s box-shadow;
}

/* Hovering the whole pod highlights it slightly */
.ezd-accordion:hover {
    border-color: #cbd5e1;
}

.ezd-accordion-header {
    width: 100%;
    padding: 16px 20px;
    background: #f8fafc; /* Subtle header bg */
    border-bottom: 1px solid transparent; /* Hidden by default */
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: background 0.2s;
}

.ezd-accordion-header span {
    font-size: 14px;
    font-weight: 600;
    color: #334155;
}

.ezd-accordion-header i {
    color: #94a3b8;
    font-size: 12px;
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}

.ezd-accordion-header:hover {
    background: #f1f5f9;
}
.ezd-accordion-header:hover span {
    color: #1e293b;
}

/* --- THE SLIDE ANIMATION --- */
.ezd-accordion-body {
    max-height: 0;
    overflow: hidden;
    background: #ffffff;
    opacity: 0;
    /* Smooth slide using max-height and opacity fade */
    transition: 
        max-height 0.35s cubic-bezier(0.4, 0.0, 0.2, 1), 
        opacity 0.35s ease-out;
}

.ezd-accordion-content {
    padding: 20px;
}

/* --- OPEN STATE --- */
.ezd-accordion.open {
    border-color: #cbd5e1;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

.ezd-accordion.open .ezd-accordion-header {
    background: #ffffff;
    border-bottom: 1px solid #f1f5f9; /* Separator appears */
}

.ezd-accordion.open .ezd-accordion-header i {
    transform: rotate(180deg);
    color: var(--ezd-primary);
}

.ezd-accordion.open .ezd-accordion-body {
    max-height: 500px; /* Arbitrary large number (JS will fix this) */
    opacity: 1;
}

/* Dark Mode Support */
body.ezd-dark-mode .ezd-accordion {
    background-color: #1e293b !important;
    border-color: #334155 !important;
}
body.ezd-dark-mode .ezd-accordion-header {
    background-color: #334155 !important; /* Slightly lighter than body */
    border-bottom-color: transparent;
}
body.ezd-dark-mode .ezd-accordion.open .ezd-accordion-header {
    border-bottom-color: #475569 !important;
}
body.ezd-dark-mode .ezd-accordion-body {
    background-color: #0f172a !important; /* Darker inside */
}
/* --- ACCORDION DARK MODE FIXES --- */
body.ezd-dark-mode .ezd-accordion-header span {
    color: #f1f5f9 !important; /* White text */
}

body.ezd-dark-mode .ezd-accordion-header i {
    color: #cbd5e1 !important; /* Lighter icon */
}

/* Optional: Make the active/open icon use your Theme Color (Brand) */
body.ezd-dark-mode .ezd-accordion.open .ezd-accordion-header i {
    color: var(--ezd-primary-text) !important; 
}

/* Hover state in Dark Mode */
body.ezd-dark-mode .ezd-accordion-header:hover {
    background-color: #475569 !important; /* Slightly lighter grey on hover */
}

/* Error State */
.ezd-file-zone.error { border-color: #ef4444; background: #fff5f5; animation: shakeHead 0.4s; }

/* A. TOGGLE SWITCH (Boxed Style) */
.ezd-toggle-wrapper {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px; cursor: pointer; user-select: none;
    background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px;
    transition: 0.2s; margin-bottom: 10px;
}
/* Stronger Hover to indicate "I am clickable" */
.ezd-toggle-wrapper:hover { 
    border-color: #94a3b8; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    transform: translateY(-1px);
}

.ezd-toggle-wrapper span.ezd-label {
    font-size: 13px; font-weight: 600; color: #334155; 
    margin: 0; pointer-events: none;
}

.ezd-toggle-track {
    width: 44px; height: 24px; background: #cbd5e1; border-radius: 99px; /* Grey default */
    position: relative; transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}
.ezd-toggle-knob {
    width: 20px; height: 20px; background: white; border-radius: 50%;
    position: absolute; top: 2px; left: 2px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}
/* --- TOGGLE ACTIVE STATE (The Missing Piece) --- */
.ezd-toggle-wrapper.active .ezd-toggle-track {
    background-color: var(--ezd-primary); /* Turn Red (or brand color) */
}

.ezd-toggle-wrapper.active .ezd-toggle-knob {
    transform: translateX(20px); /* Move the knob */
    box-shadow: -2px 2px 5px rgba(0,0,0,0.2); /* Switch shadow direction slightly */
}

.ezd-toggle-wrapper.active {
    border-color: var(--ezd-primary);
    background-color: var(--ezd-primary-light); /* Faint background tint */
}

/* B. FILE DROP ZONE (Funky Lava Lamp Edition) */
.ezd-file-zone {
    /* Dynamic variables managed by JS */
    --dynamic-bg: #f8fafc; 
    --dynamic-text: var(--ezd-primary);
    
    /* WIDTH FIX: Shave off 10px and center it */
    width: calc(100% - 10px); 
    margin: 0 auto; /* Centers the slightly smaller box */
    
    border: 2px dashed #cbd5e1; 
    border-radius: 12px;
    padding: 20px; 
    text-align: center; 
    transition: border-color 0.3s, background 1s ease; 
    background: var(--dynamic-bg); 
    position: relative; 
    overflow: hidden;
    min-height: 120px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    z-index: 1; 
    box-sizing: border-box; /* Ensures padding doesn't expand width further */
}
.ezd-file-zone:hover, .ezd-file-zone.dragover { 
    border-color: var(--ezd-primary-text); transform: scale(1.01);
}
.ezd-file-content i {
    /* WAS: color: #cbd5e1; */
    color: var(--ezd-border); /* Will be grey in light, dark grey in dark */
    transition: color 0.3s;
}

/* STATES */
.ezd-file-zone.scanning { border-color: #cbd5e1; cursor: wait; }
/* Laser Scanner Effect */
.ezd-file-zone.scanning::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.2), transparent);
    transform: translateX(-100%); animation: scanSweep 1.5s infinite linear; z-index: 2;
}
@keyframes scanSweep { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

.ezd-file-zone.uploading {
    border-color: #f59e0b; animation: pulseBorder 2s infinite;
}
@keyframes pulseBorder {
    0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
    100% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
}

.ezd-file-zone.success {
    border-style: solid; border-color: transparent; /* Border disappears into bg */
}

/* --- THE FUNKY BUBBLES --- */
.ezd-bubble-container {
    position: absolute; top:0; left:0; width:100%; height:100%;
    overflow: hidden; pointer-events: none; z-index: 0; /* Behind content */
    opacity: 0; transition: opacity 0.5s;
}
.ezd-file-zone.success .ezd-bubble-container { opacity: 1; }

.ezd-bubble {
    position: absolute;
    border-radius: 50%;
    background: var(--bubble-color);
    width: var(--size); height: var(--size);
    /* Randomize starting position slightly */
    top: calc(50% - var(--size)/2); left: calc(50% - var(--size)/2);
    opacity: 0.7;
    /* Mix blend mode makes overlapping colors blend funkily */
    mix-blend-mode: screen; 
    animation: floatAround 8s ease-in-out infinite alternate;
    animation-delay: var(--delay);
}

/* The bubbles just wander around aimlessly */
@keyframes floatAround {
    0% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(var(--dx1), var(--dy1)) scale(1.1); }
    66% { transform: translate(var(--dx2), var(--dy2)) scale(0.9); }
    100% { transform: translate(var(--dx3), var(--dy3)) scale(1); }
}

/* CONTENT & PREVIEW (Z-Index boosted to sit over bubbles) */
.ezd-file-content { pointer-events: none; transition: 0.2s; position: relative; z-index: 5; }
.ezd-file-preview { 
    display: none; flex-direction: column; align-items: center; gap: 10px; width: 100%; 
    position: relative; z-index: 5;
}
.ezd-file-preview img {
    width: 64px; height: 64px; object-fit: cover; border-radius: 12px; 
    border: 3px solid white; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.3);
    transition: 0.5s; z-index: 6;
}
.ezd-file-zone.success img { transform: scale(1.15) rotate(-2deg); }

/* The Text */
.fname {
    font-size: 14px; font-weight: 800; color: #334155; 
    transition: color 0.5s ease; text-shadow: 0 1px 2px rgba(255,255,255,0.5);
}

/* The Remove Button */
.ezd-file-remove {
    position: absolute; top: 8px; right: 8px;
    width: 24px; height: 24px; border-radius: 50%;
    background: white; color: #64748b; border: 1px solid #e2e8f0;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; cursor: pointer; transition: 0.2s; z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.ezd-file-remove:hover { background: #ef4444; color: white; border-color: #ef4444; }
/* =========================================
   17. ROLE-BASED ACCESS CONTROL (RBAC)
   ========================================= */

/* --- VIEWER ROLE (Read Only) --- */

/* 1. Hide "Write" Actions */
.ezd-mode-viewer .ezd-add-section,
.ezd-mode-viewer .ezd-action-col,
.ezd-mode-viewer .ezd-save-btn,
.ezd-mode-viewer .ezd-pwd-toggle,
.ezd-mode-viewer .ezd-unit-toggle,
.ezd-mode-viewer .ezd-color-picker-wrapper {
    display: none !important;
}

/* 2. Freeze Inputs (Visuals) */
.ezd-mode-viewer .ezd-smart-input,
.ezd-mode-viewer .ezd-select-trigger,
.ezd-mode-viewer .ezd-list-item input,
.ezd-mode-viewer .ezd-phone-wrapper,
.ezd-mode-viewer .ezd-phone-code,
.ezd-mode-viewer .ezd-phone-number,
.ezd-mode-viewer .ezd-slider-display input /* <--- Added Slider Input */
{
    background-color: #f8fafc !important;
    color: #64748b !important;
    border-color: transparent !important;
    box-shadow: none !important;
    pointer-events: none;
    user-select: text;
}

/* 3. Handle Special Wrappers */
.ezd-mode-viewer .ezd-input-wrapper i.ezd-fixed-icon {
    color: #cbd5e1 !important;
}

/* 4. Lists Table View */
.ezd-mode-viewer .ezd-list-item input { border-right: none !important; }

/* 5. Freeze Sliders */
.ezd-mode-viewer .ezd-slider-container { pointer-events: none; opacity: 0.8; }
.ezd-mode-viewer .ezd-handle {
    background: #cbd5e1 !important; border-color: #cbd5e1 !important;
    box-shadow: none !important; transform: translate(-50%, -50%) scale(0.6) !important;
}
.ezd-mode-viewer .ezd-track-fill { background: #cbd5e1 !important; }

/* 6. Freeze Segmented (Block Slider) */
.ezd-mode-viewer .ezd-seg-container {
    pointer-events: none; background: transparent !important; padding: 0;
}
.ezd-mode-viewer .ezd-seg-glider { display: none !important; }
.ezd-mode-viewer .ezd-seg-option { color: #cbd5e1 !important; }
.ezd-mode-viewer .ezd-seg-option.active {
    /* VISIBLE UNDERLINE FIX */
    color: #64748b !important;
    font-weight: 800;
    border-bottom: 3px solid #64748b; /* <--- Thick, apparent line */
    background: transparent;
    border-radius: 0;
}

/* 7. Freeze Tabs (NEW) */
/* We keep them clickable for navigation, but remove "Active" colors */
.ezd-mode-viewer .ezd-tab-btn:hover { background: transparent !important; }
.ezd-mode-viewer .ezd-tab-btn { color: #94a3b8 !important; }
.ezd-mode-viewer .ezd-tab-btn.active {
    color: #475569 !important; /* Dark Slate instead of Red */
    font-weight: 700;
}
.ezd-mode-viewer .ezd-tab-btn.active::after {
    background: #475569 !important; /* Slate underline */
}
/* Hide badges in viewer mode if they imply "Alerts" */
.ezd-mode-viewer .ezd-tab-badge { background: #cbd5e1 !important; color: #fff; }
/* 8. Freeze Toggles */
.ezd-mode-viewer .ezd-toggle-wrapper { pointer-events: none; opacity: 0.7; }
.ezd-mode-viewer .ezd-toggle-wrapper.active .ezd-toggle-track { 
    background: #cbd5e1; /* Grey when frozen, even if "on" */
}
.ezd-mode-viewer .ezd-toggle-wrapper.active .ezd-toggle-knob {
    background: #64748b; /* Dark grey knob to show state */
}

/* 9. Freeze File Upload */
.ezd-mode-viewer .ezd-file-zone {
    border-style: solid; border-color: #e2e8f0; background: #f8fafc; pointer-events: none;
}
/* Hide the helper text and the remove button */
.ezd-mode-viewer .ezd-file-content, 
.ezd-mode-viewer .ezd-file-remove { 
    display: none !important; 
}
/* =========================================
   18. DARK MODE OVERRIDES (The "Blackout" Fix v2)
   ========================================= */
body.ezd-dark-mode {
    background-color: #020617 !important; 
    color: #f1f5f9 !important;
}

/* --- 1. CONTAINERS --- */
body.ezd-dark-mode .ui-section,
body.ezd-dark-mode .ezd-dialog-box {
    background-color: #1e293b !important; 
    border-color: #334155 !important;
    box-shadow: none !important;
}

/* --- 2. INPUTS (Universal Fix) --- */
body.ezd-dark-mode .ezd-smart-input,
body.ezd-dark-mode .ezd-select-trigger,
body.ezd-dark-mode .multiselect-trigger {
    background-color: #0f172a !important; 
    border-color: #334155 !important;
    color: #f1f5f9 !important;
}
body.ezd-dark-mode .ezd-fixed-icon { color: #94a3b8 !important; }

/* --- FIX: Icon Spacing (Prevent Clipping) --- */

.multiselect-trigger {
    padding: 0 !important;
    padding-right: 30px !important;
    display: flex;
    align-items: center;
    
    /* FIX: Force width compliance */
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
}

/* 2. Single-Select (Ensuring it matches) */
.ezd-select-trigger {
    padding-left: 42px !important; /* Ensures text clears the icon */
}

/* Focus Glow */
body.ezd-dark-mode .ezd-smart-input:focus,
body.ezd-dark-mode .ezd-select-trigger:focus,
body.ezd-dark-mode .multiselect-trigger:focus {
    border-color: var(--ezd-primary-text) !important;
    box-shadow: 0 0 0 1px var(--ezd-primary-text) !important;
}

/* --- 3. PLACEHOLDERS (The Fade Fix) --- */
/* Makes placeholders darker so they don't look like typed text */
body.ezd-dark-mode ::placeholder,
body.ezd-dark-mode .ezd-phone-number::placeholder { 
    color: #475569 !important; /* Much Darker Grey */
    opacity: 1 !important; 
}

/* --- 4. PHONE INPUT (The Split Fix) --- */
body.ezd-dark-mode .ezd-phone-wrapper {
    background-color: #0f172a !important; 
    border-color: #334155 !important;
}
body.ezd-dark-mode .ezd-phone-wrapper:focus-within {
    border-color: var(--ezd-primary-text) !important;
    box-shadow: 0 0 0 1px var(--ezd-primary-text) !important;
}
body.ezd-dark-mode .ezd-phone-code {
    background-color: #1e293b !important; 
    border-right: 1px solid #334155 !important;
    color: #f1f5f9 !important;
}
body.ezd-dark-mode .ezd-phone-number {
    background-color: transparent !important;
    color: #f1f5f9 !important;
}

/* --- 5. LIST MANAGER (The White Stripe Killer) --- */
body.ezd-dark-mode .ezd-list-manager {
    background-color: #1e293b !important;
    border-color: #334155 !important;
}
/* Toolbar & Search */
body.ezd-dark-mode .ezd-list-toolbar {
    background-color: #1e293b !important;
    border-bottom: 1px solid #334155 !important;
}
body.ezd-dark-mode .ezd-list-title { color: var(--ezd-primary-text) !important; }

body.ezd-dark-mode .ezd-list-search-input {
    background-color: #0f172a !important;
    border-color: #334155 !important;
    color: #f1f5f9 !important;
}
body.ezd-dark-mode .ezd-list-search-input:focus {
    border-color: var(--ezd-primary-text) !important;
}

/* Header Row */
body.ezd-dark-mode .ezd-list-header-row {
    background-color: #0f172a !important;
    border-bottom: 2px solid #334155 !important;
}
body.ezd-dark-mode .ezd-col-header {
    color: var(--ezd-primary-text) !important;
    opacity: 1 !important;
}

/* Data Rows (The Fix) */
body.ezd-dark-mode .ezd-list-items {
    background-color: #1e293b !important; 
}
body.ezd-dark-mode .ezd-list-item {
    background-color: #1e293b !important; /* Force Dark Row */
    border-bottom: 1px solid #334155 !important;
    color: #f1f5f9 !important;
}
body.ezd-dark-mode .ezd-list-item:hover {
    background-color: #334155 !important; /* Lighter on hover */
}
/* The text inputs inside the row */
body.ezd-dark-mode .ezd-list-item input {
    color: #f1f5f9 !important; 
    border-right-color: #334155 !important;
}

/* Empty State */
body.ezd-dark-mode .ezd-empty-state {
    background-color: #1e293b !important;
    color: #64748b !important;
}

/* Footer */
body.ezd-dark-mode .ezd-add-section {
    background-color: #1e293b !important;
    border-top: 1px solid #334155 !important;
}
body.ezd-dark-mode .ezd-add-grid input {
    background-color: #1e293b !important;
    border-color: #475569 !important;
    color: #fff !important;
}

/* --- 6. UNIT BUTTONS --- */
body.ezd-dark-mode .ezd-unit-toggle {
    background-color: #334155 !important;
    border-color: #475569 !important;
    color: #cbd5e1 !important;
}
body.ezd-dark-mode .ezd-unit-toggle:hover {
    border-color: var(--ezd-primary-text) !important;
    color: var(--ezd-primary-text) !important;
}

/* --- 7. TOGGLE SWITCH --- */
body.ezd-dark-mode .ezd-toggle-wrapper {
    background-color: #0f172a !important;
    border-color: #334155 !important;
    transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
}
body.ezd-dark-mode .ezd-toggle-track {
    background-color: #475569 !important; 
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3) !important;
    transition: background-color 0.3s ease, box-shadow 0.3s ease !important;
}
body.ezd-dark-mode .ezd-toggle-knob {
    background-color: #ffffff !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5) !important;
    z-index: 5;
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1) !important;
}
/* Active State */
body.ezd-dark-mode .ezd-toggle-wrapper.active {
    border-color: var(--ezd-primary-text) !important;
}
body.ezd-dark-mode .ezd-toggle-wrapper.active .ezd-toggle-track {
    background-color: var(--ezd-primary-text) !important;
    box-shadow: 0 0 10px var(--ezd-primary-text) !important;
}
body.ezd-dark-mode .ezd-toggle-wrapper.active .ezd-toggle-knob {
    transform: translateX(20px) !important;
}

/* --- 8. SEGMENTED & UPLOAD --- */
body.ezd-dark-mode .ezd-seg-container { background-color: #0f172a !important; border-color: #334155 !important; }
body.ezd-dark-mode .ezd-seg-option { color: #64748b !important; }
body.ezd-dark-mode .ezd-seg-option.active { color: var(--ezd-primary-text) !important; }
body.ezd-dark-mode .ezd-seg-glider { background-color: #334155 !important; }

body.ezd-dark-mode .ezd-file-zone { background-color: #0f172a !important; border-color: #334155 !important; }
body.ezd-dark-mode .ezd-file-zone:hover { border-color: var(--ezd-primary-text) !important; background-color: #1e293b !important; }
body.ezd-dark-mode .ezd-file-content div { color: #94a3b8 !important; }
/* --- 9. DROPDOWN MENUS (The Fix) --- */
body.ezd-dark-mode .ezd-select-menu,
body.ezd-dark-mode .multiselect-menu {
    background-color: #1e293b !important; /* Card Color */
    border-color: #334155 !important;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important;
}

/* The Search Bar inside the menu */
body.ezd-dark-mode .ezd-select-menu input,
body.ezd-dark-mode .multiselect-menu input {
    background-color: #0f172a !important;
    border-color: #334155 !important;
    color: #fff !important;
}

/* The Options */
body.ezd-dark-mode .ezd-select-option,
body.ezd-dark-mode .multiselect-option {
    color: #cbd5e1 !important;
    border-bottom: 1px solid #334155 !important;
}

/* Hover/Focus State (Bright Brand Color) */
body.ezd-dark-mode .ezd-select-option:hover,
body.ezd-dark-mode .ezd-select-option:focus,
body.ezd-dark-mode .multiselect-option:hover,
body.ezd-dark-mode .multiselect-option:focus {
    background-color: #334155 !important;
    color: var(--ezd-primary-text) !important;
}

/* Selected State */
body.ezd-dark-mode .ezd-select-option.selected,
body.ezd-dark-mode .multiselect-option.selected {
    background-color: rgba(255,255,255,0.05) !important;
    color: var(--ezd-primary-text) !important;
    font-weight: 800 !important;
}
/* =========================================
   20. EDIT MODE & PHONE FIXES (The Final Polish)
   ========================================= */

/* --- 1. FIX LIST MANAGER EDITING (Kill the White Box) --- */
/* Override the default "Turn white on focus" rule */
body.ezd-dark-mode .ezd-list-item input:focus,
body.ezd-dark-mode .ezd-list-item input:hover {
    background-color: #0f172a !important; /* Dark Blue instead of White */
    color: #ffffff !important;
    border: 1px solid var(--ezd-primary-text) !important;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.2) !important;
}

/* Ensure the text stays white when just sitting there */
body.ezd-dark-mode .ezd-list-item input {
    color: #f1f5f9 !important;
    caret-color: var(--ezd-primary-text) !important; /* Cursor color */
}

/* --- 2. FIX PHONE PLACEHOLDER (Make it Ghostly) --- */
/* The previous grey was too bright. This forces a dark slate. */
body.ezd-dark-mode .ezd-phone-number::placeholder {
    color: #334155 !important; /* Deep Slate (Invisible-ish) */
    opacity: 1 !important;     /* Force browser to respect color */
    -webkit-text-fill-color: #334155 !important; /* Safari/Chrome Force */
}

/* --- 3. FIX PHONE SPLIT (Ensure Transparent Background) --- */
/* Forces the input to be clear so the dark wrapper shows through */
body.ezd-dark-mode .ezd-phone-number {
    background-color: transparent !important;
    background-image: none !important;
    border: none !important;
}
/* Color Picker Focus */
.color-dot:focus {
    outline: 2px solid var(--ezd-primary-text);
    outline-offset: 2px;
}
.ezd-seg-option:focus {
    background-color: rgba(0,0,0,0.05); /* Ghost Box */
    outline: none;
    border-radius: 8px;
}
/* Dark Mode Ghost */
body.ezd-dark-mode .ezd-seg-option:focus {
    background-color: rgba(255,255,255,0.1);
}
/* --- FIX: List Manager Bottom Seam --- */
.ezd-add-section {
    /* Move spacing from button margin to container padding so background fills corners */
    padding-bottom: 16px; 
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
}
.ezd-add-btn-large {
    /* Remove bottom margin to prevent "lip" glitch */
    margin-bottom: 0 !important; 
}

/* Dark Mode Override */
body.ezd-dark-mode .selected-tag {
    color: #f1f5f9 !important; /* White (Dark Mode) */
    background-color: #334155 !important;
    border-color: #475569 !important;
}
/* --- FIX: Z-Index Breakout (Nuclear Option v2) --- */

/* 1. The Lift Class */
.ezd-lift-layer {
    z-index: 10000 !important; 
    position: relative !important;
    /* Ensure the browser knows this is a high-priority layer */
    transform: translate3d(0,0,10px); 
}

/* 2. Force the dropdowns to flow out */
.ezd-select-container, .multiselect-wrapper, [data-ezd-type] {
    overflow: visible !important;
}

/* 3. Grid Container Overflow Fix */
/* If the parent grid clips, nothing can escape. We relax it. */
.ezd-list-container {
    overflow: visible !important; 
    /* Only the table wrapper inside needs scroll, not the filter bar */
}

/* 2. CRITICAL: Lift all ancestors to prevent trapping */
/* --- FIX: Z-Index Breakout (CSS Backup) --- */
.ui-section:has(.ezd-lift-layer),
.ui-grid-2:has(.ezd-lift-layer),
.ui-grid-3:has(.ezd-lift-layer),
.ui-grid-4:has(.ezd-lift-layer) {
    z-index: 1000 !important;
    position: relative !important;
    overflow: visible !important;
}

/* OPEN STATE */
.ezd-select-menu.visible, .multiselect-menu.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

/* CLOSING STATE (Slide Up) */
.ezd-select-menu.closing, .multiselect-menu.closing {
    opacity: 0;
    transform: translateY(-8px) scale(0.98); /* Slides UP while fading */
    transition: all 0.15s ease-in; /* Quick exit, no bounce */
    pointer-events: none;
}

/* --- 2. MULTI-SELECT TAGS (Slide from Left) --- */
@keyframes tagSlideIn {
    0% { opacity: 0; transform: translateX(-15px) scale(0.8); }
    60% { transform: translateX(5px) scale(1.05); } /* Overshoot */
    100% { opacity: 1; transform: translateX(0) scale(1); }
}

/* --- 3. LIQUID TEXT (The "Shift Up" Effect) --- */
@keyframes textPopUp {
    0% { opacity: 0; transform: translateY(10px) scale(0.9); filter: blur(4px); }
    100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
}
.ezd-select-text.liquid-enter {
    animation: textPopUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    display: inline-block; /* Required for transform to work */
}
/* --- MULTI-SELECT EXIT ANIMATION --- */
/* The reverse of the slide-in */
@keyframes tagSlideOut {
    0% { opacity: 1; transform: translateX(0) scale(1); }
    100% { opacity: 0; transform: translateX(-15px) scale(0.5); }
}
/* --- UPDATED: COLLAPSING SLIDE ANIMATION --- */
.selected-tag.removing {
    /* Use transition for smooth layout collapsing */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* The Collapse Properties */
    max-width: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    border: 0 !important;
    
    /* Visual Fade */
    opacity: 0;
    transform: scale(0.8);
    overflow: hidden; /* Hides text as box shrinks */
    pointer-events: none;
}
/* --- GHOST PARTICLE (For Physics) --- */
.selected-tag.ghost {
    position: absolute;
    pointer-events: none;
    z-index: 0; /* Fall behind the living tags */
    /* Reuse the slide-out animation */
    animation: tagSlideOut 0.2s cubic-bezier(0.36, 0, 0.66, -0.56) forwards;
}
/* --- FIX: Z-Index Breakout (CSS Backup) --- */
.ui-section:has(.ezd-lift-layer),
.ui-grid-2:has(.ezd-lift-layer) {
    z-index: 1000 !important;
    position: relative !important;
    overflow: visible !important;
}
/* =========================================
   19. NEWTONIAN NOTIFICATIONS (Toasts)
   ========================================= */
.ezd-toast-container {
    position: fixed; top: 20px; right: 20px;
    width: 320px; z-index: 999999;
    display: flex; flex-direction: column; gap: 10px;
    pointer-events: none; /* Let clicks pass through gaps */
}

.ezd-toast {
    background: #ffffff;
    border-left: 4px solid var(--ezd-primary);
    border-radius: 8px;
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
    padding: 16px;
    position: relative;
    pointer-events: auto; /* Re-enable clicks */
    overflow: hidden;
    transform-origin: top center;
    /* Glass Effect */
    backdrop-filter: blur(8px);
    border-right: 1px solid rgba(255,255,255,0.5);
}

/* Toast Types */
.ezd-toast.success { border-color: #10b981; }
.ezd-toast.error { border-color: #ef4444; }
.ezd-toast.info { border-color: #3b82f6; }
.ezd-toast.warning { border-color: #f59e0b; }

.ezd-toast-content { display: flex; gap: 12px; align-items: flex-start; }
.ezd-toast-icon { font-size: 18px; margin-top: 2px; }
.ezd-toast.success .ezd-toast-icon { color: #10b981; }
.ezd-toast.error .ezd-toast-icon { color: #ef4444; }
.ezd-toast.info .ezd-toast-icon { color: #3b82f6; }
.ezd-toast.warning .ezd-toast-icon { color: #f59e0b; }

.ezd-toast-text { display: flex; flex-direction: column; gap: 4px; }
.ezd-toast-title { font-weight: 700; font-size: 13px; color: #1e293b; }
.ezd-toast-msg { font-size: 12px; color: #64748b; line-height: 1.4; }

/* The "Fuse" Timer */
.ezd-toast-progress {
    position: absolute; bottom: 0; left: 0; height: 3px;
    background: currentColor; opacity: 0.2; width: 100%;
    transform-origin: left;
}

/* Close Button */
.ezd-toast-close {
    position: absolute; top: 8px; right: 8px;
    color: #94a3b8; cursor: pointer; font-size: 12px;
    padding: 4px; transition: 0.2s;
}
.ezd-toast-close:hover { color: #334155; background: rgba(0,0,0,0.05); border-radius: 4px; }

/* Dark Mode */
body.ezd-dark-mode .ezd-toast { background: #1e293b; border-right: 1px solid #334155; }
body.ezd-dark-mode .ezd-toast-title { color: #f1f5f9; }
body.ezd-dark-mode .ezd-toast-msg { color: #94a3b8; }
/* =========================================
   20. MODAL SYSTEM (Promise-Based)
   ========================================= */
.ezd-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(15, 23, 42, 0.6); 
    backdrop-filter: blur(4px); /* The "Frosted Glass" focus effect */
    display: none; align-items: center; justify-content: center;
    z-index: 10000000; opacity: 0;
}

.ezd-modal-box {
    background: #ffffff;
    width: 90%; max-width: 400px;
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    /* Transform removed so it defaults to scale(1) */
    overflow: hidden;
    display: flex; flex-direction: column;
}

.ezd-modal-header {
    padding: 20px 24px 0 24px;
    display: flex; gap: 12px; align-items: center;
}

.ezd-modal-icon {
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
}
/* Variants */
.ezd-modal-icon.danger  { background: #fef2f2; color: #ef4444; }
.ezd-modal-icon.warning { background: #fffbeb; color: #f59e0b; }
.ezd-modal-icon.info    { background: #eff6ff; color: #3b82f6; }

.ezd-modal-title { font-size: 16px; font-weight: 700; color: #1e293b; }

.ezd-modal-body {
    padding: 10px 24px 20px 76px; /* Indented to align with title text, not icon */
    color: #64748b; font-size: 14px; line-height: 1.5;
}

.ezd-modal-footer {
    padding: 16px 24px;
    background: #f8fafc;
    display: flex; justify-content: flex-end; gap: 10px;
    border-top: 1px solid #e2e8f0;
}

/* Dark Mode */
body.ezd-dark-mode .ezd-modal-box { background: #1e293b; border: 1px solid #334155; }
body.ezd-dark-mode .ezd-modal-header { color: #f1f5f9; }
body.ezd-dark-mode .ezd-modal-title { color: #f1f5f9; }
body.ezd-dark-mode .ezd-modal-body { color: #94a3b8; }
body.ezd-dark-mode .ezd-modal-footer { background: #0f172a; border-top-color: #334155; }
body.ezd-dark-mode .ezd-modal-icon.danger { background: rgba(239, 68, 68, 0.2); }
body.ezd-dark-mode .ezd-modal-icon.warning { background: rgba(245, 158, 11, 0.2); }
body.ezd-dark-mode .ezd-modal-icon.info { background: rgba(59, 130, 246, 0.2); }
/* =========================================
   21. THE DREAM DRUM (Final Polish & Physics)
   ========================================= */
.ezd-drum-wrapper {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--ezd-bg); 
    z-index: 10000; margin-top: 10px;
    border: 1px solid var(--ezd-border); border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    display: none; overflow: hidden;
    user-select: none; -webkit-user-select: none;
}

.ezd-drum-stage {
    display: flex; height: 100%; background: transparent;
}

/* THE SELECTION ZONE (Ghost Tint) */
.ezd-drum-highlight {
    position: absolute; top: 50%; left: 0; right: 0; height: 50px;
    margin-top: -25px; z-index: 1; pointer-events: none;
    background: var(--ezd-primary-light); 
    border-top: 1.5px solid var(--ezd-primary);
    border-bottom: 1.5px solid var(--ezd-primary);
}

.ezd-drum-col {
    flex: 1; height: 100%; position: relative;
    overflow-y: scroll; 
    /* CRITICAL FIX: Removed scroll-snap-type to allow perfect JS alignment */
    scrollbar-width: none;
    cursor: grab;
}
.ezd-drum-col::-webkit-scrollbar { display: none; }

.ezd-drum-strip {
    /* (250px container / 2) - (50px item / 2) = 100px padding */
    /* This ensures the first item sits perfectly in the center */
    padding: 100px 0; 
}

.ezd-drum-item {
    height: 50px; 
    display: flex; align-items: center; justify-content: center;
    font-family: 'JetBrains Mono', monospace; font-size: 19px;
    font-weight: 700; 
    color: var(--ezd-text); /* Solid text color */
    scroll-snap-align: center; 
    transition: color 0.1s, transform 0.1s, opacity 0.1s;
    opacity: 1; /* 100% Solid, no transparency */
}

.ezd-drum-item.active {
    color: var(--ezd-primary-text);
    transform: scale(1.2);
    opacity: 1; /* Solid only in the center */
}

/* DARK MODE OVERRIDES */
body.ezd-dark-mode .ezd-drum-wrapper {
    background: #1e293b;
    border-color: #334155;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
}
/* =========================================
   CASINO TOGGLE VISIBILITY FIX (Updated)
   Target: The "Start/End" or "12H/24H" switch inside Drums
   ========================================= */

/* 1. The Container (The grey track) */
.ezd-mode-toggle {
    background-color: var(--ezd-border) !important; 
    border: 1px solid var(--ezd-border);
    opacity: 1 !important;
}

/* 2. The Text Labels */
.ezd-mode-toggle span, 
.ezd-mode-toggle .ezd-mode-label {
    opacity: 1 !important; 
    font-weight: 800;
    transition: color 0.2s ease-in-out;
    z-index: 2;
    color: var(--ezd-text); /* Solid text */
}

/* 3. Dark Mode Overrides (THE FIX) */
body.ezd-dark-mode .ezd-mode-toggle {
    background-color: rgba(255, 255, 255, 0.1) !important; 
    border-color: rgba(255, 255, 255, 0.1) !important;
}

body.ezd-dark-mode .ezd-mode-toggle span,
body.ezd-dark-mode .ezd-mode-toggle .ezd-mode-label {
    color: var(--ezd-text); /* Forces solid white in dark mode */
}

/* 4. Hover State */
.ezd-mode-toggle:hover span,
.ezd-mode-toggle:hover .ezd-mode-label {
    /* On hover, make inactive text almost pure black/white */
    color: var(--ezd-text); 
}
body.ezd-dark-mode .ezd-mode-toggle:hover span,
body.ezd-dark-mode .ezd-mode-toggle:hover .ezd-mode-label {
    color: #ffffff; 
}
/* =========================================
   24. HAPTIC BUTTONS
   ========================================= */
.ezd-btn {
    position: relative;
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px 20px;
    font-family: 'Poppins', sans-serif; font-size: 13px; font-weight: 600; letter-spacing: 0.5px;
    border: none; border-radius: 8px; cursor: pointer;
    background: var(--ezd-primary); color: white;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    overflow: hidden; /* Contains the ripple */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none; -webkit-tap-highlight-color: transparent;
}

/* Hover State */
.ezd-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
}

/* Active / Press State (The "Dip") */
.ezd-btn:active, .ezd-btn.pressing {
    transform: scale(0.96);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Secondary Style (Outline) */
.ezd-btn.secondary {
    background: transparent;
    border: 1px solid var(--ezd-border);
    color: var(--ezd-text);
    box-shadow: none;
}
.ezd-btn.secondary:hover { background: var(--ezd-bg); border-color: var(--ezd-text-light); }

/* Ripple Animation Element */
.ezd-ripple {
    position: absolute; border-radius: 50%;
    transform: scale(0);
    animation: ripple 0.6s linear;
    background-color: rgba(255, 255, 255, 0.3);
    pointer-events: none;
}
.ezd-btn.secondary .ezd-ripple { background-color: rgba(0, 0, 0, 0.1); }

@keyframes ripple {
    to { transform: scale(4); opacity: 0; }
}
/* =========================================
   25. ULTIMATE SAVE BUTTON (Updated)
   ========================================= */
.ezd-save-btn {
    /* MATCH STANDARD BUTTON SIZE EXACTLY */
    height: 38px; /* Fixed height matches standard inputs/buttons */
    padding: 0 24px; /* Use horizontal padding only, let Flex center the text */
    
    border-radius: 8px; font-weight: 600; font-size: 13px;
    cursor: pointer; border: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex; align-items: center; gap: 8px; justify-content: center;
    min-width: 140px; text-transform: uppercase; letter-spacing: 0.5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* 1. IDLE (Ghost) */
.ezd-save-btn.idle { 
    background: #f1f5f9; color: #94a3b8; 
    box-shadow: none; cursor: default;
}

/* 2. DIRTY (Active/Pulse) */
.ezd-save-btn.dirty { 
    background: var(--ezd-primary); color: white;
    box-shadow: 0 4px 12px var(--ezd-primary-shadow); 
    animation: dirtyPulse 2s infinite;
    cursor: pointer;
}
@keyframes dirtyPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); box-shadow: 0 8px 16px var(--ezd-primary-shadow); }
    100% { transform: scale(1); }
}

/* 3. SAVING (Orange/Wait) */
.ezd-save-btn.saving { 
    background: #f59e0b; color: white; cursor: wait;
    pointer-events: none; /* Lock clicks */
}

/* 4. SUCCESS (Green/Done) */
.ezd-save-btn.success { 
    background: #10b981; color: white; 
    transform: scale(1.05);
}

/* 5. ERROR (Red/Shake) */
.ezd-save-btn.error { 
    background: #ef4444; color: white;
    animation: shakeError 0.4s ease-in-out;
}
@keyframes shakeError {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
}

/* =========================================
   SLIDER OVERSHOOT FIX (Intercepts JS Math)
   ========================================= */

/* 1. Main Segmented Slider (Subtracts 8px total padding) */
.ezd-seg-glider[style*="100% / 2"] { width: calc((100% - 8px) / 2) !important; }
.ezd-seg-glider[style*="100% / 3"] { width: calc((100% - 8px) / 3) !important; }
.ezd-seg-glider[style*="100% / 4"] { width: calc((100% - 8px) / 4) !important; }
.ezd-seg-glider[style*="100% / 5"] { width: calc((100% - 8px) / 5) !important; }
.ezd-seg-glider[style*="100% / 6"] { width: calc((100% - 8px) / 6) !important; }

/* 2. Drum Range Switch (Subtracts 6px padding & fixes position) */
.range-switch .ezd-seg-glider { width: calc((100% - 8px) / 2) !important; }

/* 3. Drum Format Switch (Subtracts 4px padding & fixes position) */
.format-switch .ezd-seg-glider { 
    width: calc((100% - 4px) / 2) !important; 
    top: 2px !important; bottom: 2px !important; left: 2px !important; 
}
</style>
<script>
window.EZD_UI = (function() {
  let CONFIG = {
        currency: 'USD',
        dateFormat: 'YYYY-MM-DD',
        animationSpeed: 300
    };
    'use strict';
    const utils = {
        safeParse: (str) => { try { return JSON.parse(str || '[]'); } catch(e) { return []; } },
        cleanZombies: (id) => { const old = document.getElementById('menu-'+id); if(old) old.remove(); },
        closeAllMenus: (exceptMenuId) => {
            // 1. Hide all menus (Selects, Multis, Search, AND DRUMS)
            document.querySelectorAll('.ezd-select-menu, .multiselect-menu, .ezd-search-results, .ezd-drum-wrapper').forEach(menu => {
                // If this is the one we just clicked, ignore it (toggle logic handles it)
                // For drums, we check closest ID wrapper
                if(exceptMenuId && menu.id === exceptMenuId) return;
                
                if (menu.style.display === 'none' || menu.style.display === '') return;

                // Animate Out
                menu.classList.add('closing');
                
                // Specific animation for Drum (Slide Up) vs Dropdown (Fade)
                if(menu.classList.contains('ezd-drum-wrapper')) {
                     menu.animate([
                        { opacity: 1, transform: 'translateY(0) scale(1)' },
                        { opacity: 0, transform: 'translateY(-10px) scale(0.95)' }
                     ], { duration: 150 }).onfinish = () => {
                         menu.style.display = 'none';
                         menu.classList.remove('closing');
                     };
                } else {
                    // Standard Dropdown Fade
                    setTimeout(() => {
                        if (menu.classList.contains('closing')) {
                            menu.style.display = 'none';
                            menu.classList.remove('closing');
                        }
                    }, 200);
                }
            });
            
            // 2. DROP THE ELEVATOR (Reset Z-Indexes)
            document.querySelectorAll('.ezd-lift-layer').forEach(el => {
                // Don't drop if we are just opening THIS specific element's menu
                // (This check prevents flickering if you click the same one twice)
                if(exceptMenuId) {
                    const menuInside = el.querySelector('#' + exceptMenuId);
                    if(menuInside) return;
                }
                el.classList.remove('ezd-lift-layer');
                
                // Clean up the translate hack we added in CSS
                el.style.transform = ""; 
            });

            // 3. Reset Section Z-Index
            document.querySelectorAll('.ui-section, .ezd-dialog-content').forEach(sec => {
                sec.style.zIndex = ""; 
            });

            // 4. Reset Aria
            document.querySelectorAll('.ezd-select-trigger, .multiselect-trigger').forEach(t => {
                t.setAttribute('aria-expanded', 'false');
            });
        },
        dispatchChange: (el) => { if(el) el.dispatchEvent(new Event('change', { bubbles: true })); },
        // --- UPDATED: Flash Helper (Matches Animation Timing) ---
        flashInput: function(el, type) {
            // Remove class first to reset animation if user clicks rapidly
            el.classList.remove(type);
            
            // Force a reflow (browser hack to restart CSS animation)
            void el.offsetWidth; 
            
            el.classList.add(type);
            
            // Clear previous timer
            if (el.flashTimer) clearTimeout(el.flashTimer);
            
            // Remove class after animation (400ms for valid, 300ms for typing)
            el.flashTimer = setTimeout(function() {
                el.classList.remove(type);
            }, type === 'valid' ? 400 : 300);
        },
        // Paste this inside 'const utils = {'
        hexToRgba: (hex, alpha) => {
            let c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c = hex.substring(1).split('');
                if(c.length === 3){ c = [c[0], c[0], c[1], c[1], c[2], c[2]]; }
                c = '0x'+c.join('');
                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
            }
            return hex; 
        },
        smartPaste: (e, type, updateCallback) => {
            e.preventDefault();
            let text = "";
            if (e.clipboardData) text = e.clipboardData.getData('text');
            else if (window.clipboardData) text = window.clipboardData.getData('Text');
            
            text = (text || "").trim();
            if (!text) return;

            const now = Date.now();
            const el = e.target;
            
            // 2. STATE ROTATION
            if (!el._pasteState || el._pasteState.text !== text || (now - el._pasteState.time > 2000)) {
                el._pasteState = { text: text, index: 0, time: now };
            } else {
                el._pasteState.index++; 
                el._pasteState.time = now;
            }
            const rotation = el._pasteState.index;

            // 3. DATE LOGIC (Unchanged)
            if (type === 'date') {
                const nums = text.match(/\d+/g);
                if (!nums || nums.length < 2) return;
                
                let p1 = parseInt(nums[0]), p2 = parseInt(nums[1]);
                let p3 = nums.length > 2 ? parseInt(nums[2]) : new Date().getFullYear();
                if (p3 < 100) p3 += (p3 > 50 ? 1900 : 2000);

                let d, m, y;
                if (rotation % 3 === 0) {
                    m = p1; d = p2; y = p3;
                    window.EZD_UI.notify('info', 'Paste: US Format', 'Month / Day / Year');
                } else if (rotation % 3 === 1) {
                    d = p1; m = p2; y = p3;
                    window.EZD_UI.notify('info', 'Paste: Intl Format', 'Day / Month / Year');
                } else {
                    y = (p1 < 100) ? p1 + 2000 : p1; m = p2; d = (p3 > 31) ? 1 : p3;
                    window.EZD_UI.notify('warning', 'Paste: Rotation', 'Year / Month / Day');
                }
                updateCallback({ d: d, m: m, y: y });
            }

            // 4. TIME LOGIC (FIXED)
            else if (type === 'time') {
                const nums = text.match(/\d+/g);
                if (!nums || nums.length < 2) return;
                
                let h = parseInt(nums[0]);
                let m = parseInt(nums[1]);
                
                // Parse AM/PM from text
                let isPM = text.toUpperCase().includes('PM');
                let isAM = text.toUpperCase().includes('AM');
                
                if (isPM && h < 12) h += 12;
                if (isAM && h === 12) h = 0;

                // NOTIFICATION LOGIC
                if (rotation > 0) {
                    // If rotating, we are just flipping the view, not the value.
                    window.EZD_UI.notify('info', 'Format Switched', '12H  24H');
                } else {
                    window.EZD_UI.notify('success', 'Pasted Time', `${h}:${m < 10 ? '0'+m : m}`);
                }

                // Return the CLEAN time. Do not modify h/m based on rotation.
                // The UI builder's paste listener handles the is24h toggle.
                updateCallback(`${h}:${m}`); 
            }
        },
        // Paste inside 'const utils = {'
        getContrastColor: (hex) => {
            // Remove hash if present
            hex = hex.replace('#', '');
            // Convert to RGB
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            // Calculate brightness
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            // Return Dark Slate for light backgrounds, White for dark backgrounds
            return (yiq >= 128) ? '#1e293b' : '#ffffff';
        },
        toggleMenu: (trigger, menu) => {
            const isVisible = (menu.style.display === 'block' && !menu.classList.contains('closing'));
            
            utils.closeAllMenus(); 
            
            if (!isVisible) {
                // Stop any closing animation if user re-clicked fast
                menu.classList.remove('closing');
                
                // --- THE LIFT FIX ---
                // We must find the OUTERMOST shell (the one with data-ezd-type)
                // because that is the one sitting in the Grid/Flow.
                const rootShell = trigger.closest('[data-ezd-type]');
                if (rootShell) rootShell.classList.add('ezd-lift-layer');

                // Fallback: If not found, lift the direct parent
                const directWrapper = trigger.closest('.ezd-select-container, .multiselect-wrapper');
                if (directWrapper) directWrapper.classList.add('ezd-lift-layer');

                // Also lift the UI Section to escape sidebar/header overlapping
                const section = trigger.closest('.ui-section, .ezd-dialog-content');
                if (section) section.style.zIndex = "1000";

                // Show
                menu.style.display = 'block'; 
                menu.style.top = '100%'; // Standard drop position
                
                // Trigger Open Animation
                requestAnimationFrame(() => {
                    menu.classList.add('visible');
                });

                const search = menu.querySelector('input'); 
                if(search) { search.value = ""; search.focus(); }
            }
        },
        lightenColor: (hex, percent) => {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        },
        // VALIDATION & FORMATTING
        validateEmail: (email) => /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/.test(email),
        validateIP: (ip) => /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip),
        formatPhone: (val) => {
            let clean = val.replace(/[^\d+]/g, '');
            if (clean.startsWith('+')) {
                return clean.replace(/(\+\d{2})(\d{4})(\d{6})/, '$1 $2 $3').trim();
            }
            let match = clean.match(/^(\d{0,3})(\d{0,3})(\d{0,4})$/);
            if (!match) return clean;
            return !match[2] ? match[1] : `(${match[1]}) ${match[2]}${match[3] ? '-' + match[3] : ''}`;
        },
        restrictCurrency: (val) => {
            let clean = val.replace(/[^0-9.]/g, '');
            const parts = clean.split('.');
            if (parts.length > 2) {
                clean = parts.shift() + '.' + parts.join('');
            }
            return clean;
        },
        formatCurrency: (val) => {
            if (!val) return '';
            const clean = window.EZD_UI._utils.restrictCurrency(val);
            const num = parseFloat(clean);
            return isNaN(num) ? '' : num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },
        formatHeight: (val) => {
            const clean = val.replace(/[^0-9]/g, ''); if (!clean) return "";
            const ft = clean.substring(0, 1); const inch = clean.substring(1, 3);
            let result = ft + "'"; if (clean.length > 1) result += " " + inch + '"'; return result;
        },
        formatCard: (val) => {
            return val.replace(/\D/g, '').replace(/(.{4})/g, '$1 ').trim().substring(0, 19);
        },
        applyMask: (value, pattern) => {
            let i = 0;
            const v = value.toString().replace(/[^a-zA-Z0-9]/g, "");
            let res = "";
            for (let p = 0; p < pattern.length; p++) {
                if (i >= v.length) break;
                if (pattern[p] === '#') res += v[i++];
                else { res += pattern[p]; if (pattern[p] === v[i]) i++; }
            }
            return res;
        },
        convertUnit: (val, type, toMetric) => {
            if (!val) return '';
            const num = parseFloat(val);
            if (isNaN(num)) return val;
            if (type === 'weight') return toMetric ? (num * 0.453592).toFixed(1) : (num * 2.20462).toFixed(1);
            if (type === 'temp') return toMetric ? ((num - 32) * 5/9).toFixed(1) : ((num * 9/5) + 32).toFixed(1);
            if (type === 'distance') return toMetric ? (num * 1.60934).toFixed(2) : (num / 1.60934).toFixed(2);
            return val;
        },
        debounce: (func, wait) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
    };
    const builders = {
      buildButton: function(el) {
            // If it's just a placeholder <div>, turn it into a real button
            if (el.tagName !== 'BUTTON') {
                var btn = document.createElement('button');
                btn.className = 'ezd-btn ' + (el.className || '');
                // Check if there is REAL content (ignoring spaces/enter keys)
var hasContent = el.innerHTML && el.innerHTML.trim().length > 0;
btn.innerHTML = hasContent ? el.innerHTML : (el.dataset.label || 'Submit');
                
                // Copy ID and clicks
                if (el.id) btn.id = el.id;
                if (el.onclick) btn.onclick = el.onclick;
                if (el.dataset.variant) btn.classList.add(el.dataset.variant); // e.g., 'secondary'

                el.parentNode.replaceChild(btn, el);
                el = btn; // Update reference
            } else {
                el.classList.add('ezd-btn');
            }

            // 1. The "Press" Sound & Feel
            el.addEventListener('mousedown', function() {
                // Audio is handled by the Global Listener now to prevent double-triggering
                el.classList.add('pressing');
            });

            // 2. Release
            var release = function() { el.classList.remove('pressing'); };
            el.addEventListener('mouseup', release);
            el.addEventListener('mouseleave', release);

            // 3. The Ripple Effect
            el.addEventListener('click', function(e) {
                var circle = document.createElement('span');
                var diameter = Math.max(el.clientWidth, el.clientHeight);
                var radius = diameter / 2;

                var rect = el.getBoundingClientRect();
                
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${e.clientX - rect.left - radius}px`;
                circle.style.top = `${e.clientY - rect.top - radius}px`;
                circle.classList.add('ezd-ripple');

                // Remove old ripples to keep DOM clean
                var old = el.getElementsByClassName('ezd-ripple')[0];
                if (old) old.remove();

                el.appendChild(circle);
                
                // Audio is handled by mousedown, so we don't duplicate it here
            });
        },

      buildDrumDateRange: function(el) {
            var id = el.id || 'trange-' + Math.random().toString(36).substr(2,9); 
            el.removeAttribute('id'); // FIX: Removes duplicate ID from wrapper
            var label = el.dataset.label || 'Select Dates';

            el.innerHTML = '<div class="ezd-input-group" style="position:relative;">' +
                '<label class="ezd-label">' + label + '</label>' +
                '<div class="ezd-input-wrapper">' +
                    '<i class="fas fa-calendar-week ezd-fixed-icon"></i>' +
                    '<input type="text" id="' + id + '-disp" class="ezd-smart-input" placeholder="DD/MM/YYYY - DD/MM/YYYY" readonly style="cursor:pointer;">' +
                    '<input type="hidden" id="' + id + '" class="ezd-store">' +
                '</div>' +
                '<div class="ezd-drum-wrapper" style="display:none; flex-direction:column; height:auto;">' +
                    // HEADER: START/END SWITCH (Standard Segmented)
                    '<div style="flex:0 0 auto; display:flex; justify-content:center; padding:12px 15px; border-bottom:1px solid var(--ezd-border); background:transparent;">' +
                        '<div class="ezd-seg-container range-switch" style="width:100%; height:32px; padding:3px; background:var(--ezd-border);">' +
                            '<div class="ezd-seg-glider" style="width:50%;"></div>' +
                            '<div class="ezd-seg-option active" style="font-size:11px; font-weight:700;">START DATE</div>' +
                            '<div class="ezd-seg-option" style="font-size:11px; font-weight:700;">END DATE</div>' +
                        '</div>' +
                    '</div>' +
                    // STAGE
                    '<div class="ezd-drum-stage" style="height:250px; position:relative;">' +
                        '<div class="ezd-drum-highlight" style="top:50%; margin-top:-25px;"></div>' +
                        '<div class="ezd-drum-col" data-type="d"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="m"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="y"><div class="ezd-drum-strip"></div></div>' +
                    '</div>' +
                    // FOOTER
                    '<div class="duration-badge" style="text-align:center; padding:8px; background:transparent; border-top:1px solid var(--ezd-border); font-size:11px; font-weight:700; color:var(--ezd-primary-text);">1 Night</div>' +
                '</div>' +
            '</div>';

            var display = el.querySelector('#' + id + '-disp');
            var hidden = el.querySelector('#' + id);
            var wrapper = el.querySelector('.ezd-drum-wrapper');
            
            // Standardized Selectors
            var rangeSwitch = el.querySelector('.range-switch');
            var rangeGlider = rangeSwitch.querySelector('.ezd-seg-glider');
            var rangeOpts = rangeSwitch.querySelectorAll('.ezd-seg-option');
            
            var badge = el.querySelector('.duration-badge');
            var itemH = 50; 

            var today = new Date();
            var tmrw = new Date(today); tmrw.setDate(today.getDate() + 1);
            
            var state = {
                view: 'start',
                start: { d: today.getDate(), m: today.getMonth()+1, y: today.getFullYear() },
                end:   { d: tmrw.getDate(), m: tmrw.getMonth()+1, y: tmrw.getFullYear() }
            };

            function getDays(m, y) { return new Date(y, m, 0).getDate(); }
            function pad(n) { return String(n).padStart(2, '0'); }
            function toDate(s) { return new Date(s.y, s.m - 1, s.d); }
            function fmt(s) { return s.y + "-" + pad(s.m) + "-" + pad(s.d); }

            var sync = function() {
                var active = state[state.view];
                var max = getDays(active.m, active.y);
                if(active.d > max) active.d = max;
                
                var dCol = el.querySelector('.ezd-drum-col[data-type="d"]');
                if (dCol.querySelectorAll('.ezd-drum-item').length !== max) wheels.d.render(max);

                var dStart = toDate(state.start);
                var dEnd = toDate(state.end);

                // THE PUSH SHIELD: If Start is after End
                if (dStart > dEnd) {
                    if (state.view === 'start') {
                        // Push End to match Start
                        state.end.d = state.start.d; 
                        state.end.m = state.start.m; 
                        state.end.y = state.start.y;
                    } else {
                        // Push Start back to match End
                        state.start.d = state.end.d; 
                        state.start.m = state.end.m; 
                        state.start.y = state.end.y;
                    }
                }

                var diff = Math.round((toDate(state.end) - toDate(state.start)) / (1000 * 60 * 60 * 24));
                badge.innerHTML = diff === 1 ? "1 Night" : diff + " Nights";
                
                display.value = pad(state.start.d) + "/" + pad(state.start.m) + "/" + state.start.y + " - " + pad(state.end.d) + "/" + pad(state.end.m) + "/" + state.end.y;
                hidden.value = fmt(state.start) + ',' + fmt(state.end);
                hidden.dispatchEvent(new Event('change', { bubbles: true }));
            };

            var setupCol = function(type, min, maxInitial) {
                var col = el.querySelector('.ezd-drum-col[data-type="' + type + '"]');
                var strip = col.querySelector('.ezd-drum-strip');
                strip.style.padding = "100px 0"; 
                var isDragging = false, startY, startScroll, lastIdx = -1;

                var render = function(dynamicMax) {
                    var currentMax = dynamicMax || maxInitial;
                    var html = '';
                    for(var i = min; i <= currentMax; i++) {
                        var val = (type === 'y') ? i : pad(i);
                        html += '<div class="ezd-drum-item" data-val="' + i + '">' + val + '</div>';
                    }
                    strip.innerHTML = html;
                };

                var highlight = function(val) {
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    items.forEach(function(item) {
                        if (parseInt(item.dataset.val) === val) item.classList.add('active');
                        else item.classList.remove('active');
                    });
                };

                var update = function(val, doSpin) {
                    var index = val - min;
                    if (doSpin) {
                        col.scrollTo({ top: index * itemH, behavior: 'smooth' });
                    } else {
                        col.scrollTop = index * itemH;
                        highlight(val); 
                    }
                };

                col.addEventListener('mousedown', function(e) { isDragging = true; col.style.cursor = 'grabbing'; startY = e.pageY; startScroll = col.scrollTop; });
                window.addEventListener('mouseup', function() { if (!isDragging) return; isDragging = false; col.style.cursor = 'grab'; col.scrollTo({ top: Math.round(col.scrollTop / itemH) * itemH, behavior: 'smooth' }); });
                window.addEventListener('mousemove', function(e) { if (!isDragging) return; e.preventDefault(); col.scrollTop = startScroll - ((e.pageY - startY) * 0.8); });

                col.addEventListener('scroll', function() {
                    var index = Math.round(col.scrollTop / itemH);
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    if (index !== lastIdx) {
                        items.forEach(function(i) { i.classList.remove('active'); });
                        if(items[index]) {
                            items[index].classList.add('active');
                            var newVal = parseInt(items[index].dataset.val);
                            var active = state[state.view];
                            if(active[type] !== newVal) {
                                active[type] = newVal;
                                state[type] = newVal;
                                if(typeof audio !== 'undefined') audio.play('tick');
                                sync();
                            }
                        }
                        lastIdx = index;
                    }
                });
                return { render: render, update: update, highlight: highlight };
            };

            var wheels = { d: setupCol('d', 1, 31), m: setupCol('m', 1, 12), y: setupCol('y', 2020, 2030) };

            var refreshView = function() {
                wrapper._switching = true;
                
                var isStart = state.view === 'start';
                rangeGlider.style.transform = isStart ? 'translateX(0)' : 'translateX(99%)';
                
                // UPDATE SEGMENTED SWITCH UI
                rangeOpts.forEach((opt, idx) => {
                    var isActive = (idx === 0 && isStart) || (idx === 1 && !isStart);
                    opt.classList.toggle('active', isActive);
                    opt.style.color = isActive ? '#0f172a' : 'var(--ezd-text-light)';
                });

                requestAnimationFrame(function() {
                    var active = state[state.view];
                    var max = getDays(active.m, active.y);
                    wheels.d.render(max);
                    
                    wheels.d.update(active.d, true);
                    wheels.m.update(active.m, true);
                    wheels.y.update(active.y, true);
                    setTimeout(function() { wrapper._switching = false; }, 200);
                });
            };

            // Use the segmented click logic
            rangeSwitch.onclick = function(e) {
                e.stopPropagation();
                state.view = (state.view === 'start') ? 'end' : 'start';
                if(typeof audio !== 'undefined') audio.play('open');
                refreshView();
            };

            hidden._fds_update = function(newVal) {
                if(!newVal || !newVal.includes(',')) return;
                var ranges = newVal.split(',');
                var p1 = ranges[0].split('-').map(Number);
                var p2 = ranges[1].split('-').map(Number);
                state.start = { y: p1[0], m: p1[1], d: p1[2] };
                state.end   = { y: p2[0], m: p2[1], d: p2[2] };
                state.view = 'start';
                sync();
                refreshView();
                if(window.EZD_UI._utils.flashInput) window.EZD_UI._utils.flashInput(display, 'valid');
            };

            // Initial Render
            wheels.d.render(); wheels.m.render(); wheels.y.render();
            refreshView(); 

            display.addEventListener('paste', (e) => {
                window.EZD_UI._utils.smartPaste(e, 'date', (res) => {
                    state[state.view] = { d: res.d, m: res.m, y: res.y };
                    sync();         
                    refreshView();  
                    window.EZD_UI._utils.flashInput(display, 'typing');
                });
            });

            display.addEventListener('copy', (e) => {
                e.preventDefault();
                if (e.clipboardData) {
                    e.clipboardData.setData('text/plain', display.value);
                    window.EZD_UI.notify('success', 'Copied Range', display.value);
                    window.EZD_UI._utils.flashInput(display, 'valid');
                }
            });

            display.onmousedown = function(e) {
                e.stopPropagation(); 
                display.focus({ preventScroll: true });

                if (wrapper.style.display === 'flex') return;
                window.EZD_UI._utils.closeAllMenus();
                
                wrapper.style.display = 'flex';
                el.classList.add('ezd-lift-layer'); 
                
                refreshView(); 

                wrapper.animate([{ opacity: 0, transform: 'translateY(-10px)' }, { opacity: 1, transform: 'translateY(0)' }], { duration: 200 });
            };
            
            wrapper.onmousedown = function(e) { e.stopPropagation(); };
        },
      buildDrumTime: function(el) {
            var id = el.id || 'time-' + Math.random().toString(36).substr(2,9); 
            el.removeAttribute('id'); // Fixes Validation
            var label = el.dataset.label || 'Select Time';
            var is24h = el.dataset.mode === '24h'; 

            el.innerHTML = '<div class="ezd-input-group" style="position:relative;">' +
                '<label class="ezd-label">' + label + '</label>' +
                '<div class="ezd-input-wrapper">' +
                    '<i class="fas fa-clock ezd-fixed-icon"></i>' +
                    '<input type="text" id="' + id + '-disp" class="ezd-smart-input" placeholder="Select Time" readonly style="cursor:pointer;">' +
                    '<input type="hidden" id="' + id + '" class="ezd-store">' +
                '</div>' +
                '<div class="ezd-drum-wrapper" style="display:none; flex-direction:column; height:auto;">' + 
                    // --- NEW INJECT: SAVE / CLEAR HEADER ---
                    '<div style="flex:0 0 auto; height:40px; border-bottom:1px solid var(--ezd-border); display:flex; align-items:center; justify-content:space-between; padding:0 15px; background:var(--bg-color);">' +
                        '<button class="ezd-btn secondary" style="color:#ef4444; border-color:#ef4444; padding:4px 10px; font-size:10px; height:24px; min-height:24px;" id="' + id + '-clear">Clear</button>' +
                        '<span style="font-size:12px; font-weight:700;">Set Time</span>' +
                        '<button class="ezd-btn" style="padding:4px 10px; font-size:10px; height:24px; min-height:24px;" id="' + id + '-save">Save</button>' +
                    '</div>' +
                    // OLD HEADER: FORMAT SWITCH
                    '<div style="flex:0 0 auto; height:40px; border-bottom:1px solid var(--ezd-border); display:flex; align-items:center; justify-content:space-between; padding:0 15px; background:transparent;">' +
                        '<span style="font-size:11px; font-weight:700; color:var(--text-light);">FORMAT</span>' +
                        '<div class="ezd-seg-container format-switch" style="width:80px; height:24px; padding:2px; background:var(--ezd-border);">' +
                            '<div class="ezd-seg-glider" style="width:50%;"></div>' +
                            '<div class="ezd-seg-option active" data-val="12h" style="font-size:10px; font-weight:800;">12H</div>' +
                            '<div class="ezd-seg-option" data-val="24h" style="font-size:10px; font-weight:800;">24H</div>' +
                        '</div>' +
                    '</div>' +
                    // STAGE
                    '<div class="ezd-drum-stage" style="height:250px; position:relative;">' +
                        '<div class="ezd-drum-highlight" style="top:50%; margin-top:-25px;"></div>' +
                        '<div class="ezd-drum-col" data-type="h"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="m"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="p"><div class="ezd-drum-strip"></div></div>' +
                    '</div>' +
                '</div>' +
            '</div>';

            var display = el.querySelector('#' + id + '-disp');
            var hidden = el.querySelector('#' + id);
            var wrapper = el.querySelector('.ezd-drum-wrapper');
            
            var formatSwitch = el.querySelector('.format-switch');
            var formatGlider = formatSwitch.querySelector('.ezd-seg-glider');
            var formatOpts = formatSwitch.querySelectorAll('.ezd-seg-option');

            var itemH = 50; 
            
            // --- INJECT: EMPTY STATE TRACKING ---
            var state = { h24: 8, m: 0, isEmpty: true }; 
            
            // Check if there is initial data passed in
            var rawVal = el.dataset.value || el.getAttribute('value');
            if (rawVal) {
                state.isEmpty = false;
                var parts = rawVal.split(':');
                var h = parseInt(parts[0]);
                var isPM = rawVal.toUpperCase().includes('PM');
                if (isPM && h < 12) h += 12;
                if (!isPM && h === 12) h = 0;
                state.h24 = h;
                state.m = parseInt(parts[1]);
            }

            function pad(n) { return String(n).padStart(2, '0'); }

            var sync = function() {
                // --- INJECT: EMPTY STATE RENDER ---
                if (state.isEmpty) {
                    display.value = '--:--';
                    hidden.value = '';
                } else {
                    var hDisplay, pDisplay = '';
                    if (is24h) {
                        hDisplay = pad(state.h24);
                        display.value = hDisplay + ':' + pad(state.m);
                    } else {
                        var h12 = state.h24 % 12 || 12;
                        pDisplay = state.h24 >= 12 ? 'PM' : 'AM';
                        display.value = pad(h12) + ':' + pad(state.m) + ' ' + pDisplay;
                    }
                    hidden.value = pad(state.h24) + ':' + pad(state.m);
                }
                hidden.dispatchEvent(new Event('change', { bubbles: true }));
            };

            var setupCol = function(type, options) {
                var col = el.querySelector('.ezd-drum-col[data-type="' + type + '"]');
                var strip = col.querySelector('.ezd-drum-strip');
                strip.style.padding = "100px 0"; 
                var isDragging = false, startY, startScroll, lastIdx = -1;

                var render = function(newOpts) {
                    if(newOpts) options = newOpts;
                    var html = '';
                    options.forEach(function(val) {
                        var dVal = (type === 'p') ? val : pad(val);
                        html += '<div class="ezd-drum-item" data-val="' + val + '">' + dVal + '</div>';
                    });
                    strip.innerHTML = html;
                };

                var highlight = function(val) {
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    items.forEach(function(item) {
                        if (item.dataset.val == val) item.classList.add('active');
                        else item.classList.remove('active');
                    });
                };

                var update = function(val, doSpin) {
                    var idx = options.indexOf(val);
                    if(idx !== -1) { 
                        if(doSpin) { 
                            col.scrollTo({ top: idx * itemH, behavior: 'smooth' }); 
                            highlight(val); 
                        } else { 
                            col.scrollTop = idx * itemH; 
                            highlight(val); 
                        }
                        lastIdx = idx; 
                    }
                };

                col.addEventListener('mousedown', function(e) { isDragging=true; col.style.cursor='grabbing'; startY=e.pageY; startScroll=col.scrollTop; });
                window.addEventListener('mouseup', function() { if(!isDragging)return; isDragging=false; col.style.cursor='grab'; col.scrollTo({ top:Math.round(col.scrollTop/itemH)*itemH, behavior:'smooth' }); });
                window.addEventListener('mousemove', function(e) { if(!isDragging)return; e.preventDefault(); col.scrollTop = startScroll - ((e.pageY - startY) * 0.8); });

                col.addEventListener('scroll', function() {
                    var index = Math.round(col.scrollTop / itemH);
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    if (index !== lastIdx) {
                        items.forEach(i => i.classList.remove('active'));
                        if(items[index]) {
                            items[index].classList.add('active');
                            if(typeof audio !== 'undefined' && !wrapper._switching) audio.play('tick');
                            var newVal = items[index].dataset.val;
                            
                            // If they spin the wheel, immediately assume they want to set a time
                            state.isEmpty = false;

                            if(type === 'm') state.m = parseInt(newVal, 10);
                            else if(type === 'h') {
                                var val = parseInt(newVal);
                                if(is24h) state.h24 = val;
                                else { var isPM = state.h24 >= 12; state.h24 = (val % 12) + (isPM ? 12 : 0); }
                            }
                            else if(type === 'p') {
                                var isPM = newVal === 'PM';
                                var h12 = state.h24 % 12;
                                state.h24 = h12 + (isPM ? 12 : 0);
                            }
                            // Note: We DO NOT call sync() here anymore! 
                            // We only save/sync when they click "Save" in the header.
                        }
                        lastIdx = index;
                    }
                });
                return { render: render, update: update };
            };

            var h12Opts = [1,2,3,4,5,6,7,8,9,10,11,12];
            var h24Opts = Array.from({length: 24}, (_, i) => i);
            var minOpts = Array.from({length: 60}, (_, i) => i);

            var wheels = {
                h: setupCol('h', is24h ? h24Opts : h12Opts),
                m: setupCol('m', minOpts),
                p: setupCol('p', ['AM', 'PM'])
            };

            var refreshMode = function() {
                wrapper._switching = true;
                
                formatGlider.style.transform = is24h ? 'translateX(99%)' : 'translateX(0)';
                
                formatOpts.forEach((opt, idx) => {
                    var isActive = (idx === 0 && !is24h) || (idx === 1 && is24h);
                    opt.classList.toggle('active', isActive);
                    opt.style.color = isActive ? '#0f172a' : 'var(--text-light)';
                });

                requestAnimationFrame(function() {
                    var pCol = el.querySelector('.ezd-drum-col[data-type="p"]');
                    if (is24h) {
                        pCol.style.display = 'none';
                        wheels.h.render(h24Opts);
                        wheels.h.update(state.h24, true); 
                    } else {
                        pCol.style.display = 'block';
                        wheels.h.render(h12Opts);
                        wheels.h.update(state.h24 % 12 || 12, true); 
                        wheels.p.update(state.h24 >= 12 ? 'PM' : 'AM', true); 
                    }
                    wheels.m.update(state.m, true); 
                    // No sync() here either, it's just visual layout refresh
                    setTimeout(() => { wrapper._switching = false; }, 200);
                });
            };

            formatSwitch.onclick = function(e) {
                e.stopPropagation();
                is24h = !is24h;
                refreshMode();
                if(typeof audio !== 'undefined') audio.play('open');
            };

            hidden._fds_update = function(newVal, modePref) {
                if(!newVal) { state.isEmpty = true; sync(); return; }
                
                if (modePref === '24h' || modePref === '12h') is24h = (modePref === '24h');
                
                var parts = newVal.split(':');
                var h = parseInt(parts[0]);
                var isPM = newVal.toUpperCase().includes('PM');
                var isAM = newVal.toUpperCase().includes('AM');
                
                state.isEmpty = false;
                if (is24h) state.h24 = h;
                else {
                    if (isPM && h < 12) h += 12;
                    if (isAM && h === 12) h = 0;
                    state.h24 = h;
                }
                state.m = parseInt(parts[1]);
                refreshMode();
                sync();
                if(window.EZD_UI._utils.flashInput) window.EZD_UI._utils.flashInput(display, 'valid');
            };

            wheels.h.render(); wheels.m.render(); wheels.p.render();
            refreshMode(); 
            sync(); // Set initial text

            display.addEventListener('paste', (e) => {
                window.EZD_UI._utils.smartPaste(e, 'time', (timeStr) => {
                    if (display._pasteState && display._pasteState.index > 0) { is24h = !is24h; }
                    else {
                        var rawText = (e.clipboardData || window.clipboardData).getData('text').toUpperCase();
                        if (rawText.includes('PM') || rawText.includes('AM')) is24h = false;
                        else {
                             var h = parseInt(timeStr.split(':')[0]);
                             if (h > 12) is24h = true;
                        }
                    }
                    el._fds_update(timeStr);
                    refreshMode(); 
                    window.EZD_UI._utils.flashInput(display, 'typing');
                });
            });
            
            display.addEventListener('copy', (e) => {
                e.preventDefault();
                if (e.clipboardData) {
                    e.clipboardData.setData('text/plain', display.value);
                    window.EZD_UI.notify('success', 'Copied Time', display.value);
                    window.EZD_UI._utils.flashInput(display, 'valid');
                }
            });

            // --- INJECT: BUTTON LOGIC ---
            el.querySelector('#' + id + '-clear').addEventListener('click', function(e) {
                e.stopPropagation();
                state.isEmpty = true;
                sync();
                wrapper.style.display = 'none';
                el.classList.remove('ezd-lift-layer');
                // UNPAUSE POLLER
                if(window.AttendanceModule) window.AttendanceModule.state.pauseUpdatesUntil = 0;
            });

            el.querySelector('#' + id + '-save').addEventListener('click', function(e) {
                e.stopPropagation();
                if (state.isEmpty) state.isEmpty = false; // Force a time if they hit save
                sync();
                wrapper.style.display = 'none';
                el.classList.remove('ezd-lift-layer');
                // UNPAUSE POLLER
                if(window.AttendanceModule) window.AttendanceModule.state.pauseUpdatesUntil = 0;
            });

            display.onmousedown = function(e) {
                e.stopPropagation(); e.preventDefault();
                display.focus({preventScroll:true});
                if (wrapper.style.display === 'flex') return;
                window.EZD_UI._utils.closeAllMenus();
                
                // --- INJECT: PAUSE POLLER ---
                if(window.AttendanceModule) window.AttendanceModule.state.pauseUpdatesUntil = Date.now() + 3600000; // 1 hour pause
                
                wrapper.style.display = 'flex';
                el.classList.add('ezd-lift-layer'); 
                
                refreshMode(); 
                
                wrapper.animate([{ opacity: 0, transform: 'translateY(-10px)' }, { opacity: 1, transform: 'translateY(0)' }], { duration: 200 });
            };
            wrapper.onmousedown = function(e) { e.stopPropagation(); };
        },
        buildDrumTimeRange: function(el) {
            var id = el.id || 'trange-' + Math.random().toString(36).substr(2,9); 
            el.removeAttribute('id'); // Fixes Validation
            var label = el.dataset.label || 'Select Time Range';
            var is24h = el.dataset.mode === '24h'; // <--- THIS WAS MISSING!

            el.innerHTML = '<div class="ezd-input-group" style="position:relative;">' +
                '<label class="ezd-label">' + label + '</label>' +
                '<div class="ezd-input-wrapper">' +
                    '<i class="fas fa-clock ezd-fixed-icon"></i>' +
                    '<input type="text" id="' + id + '-disp" class="ezd-smart-input" placeholder="Start - End" readonly style="cursor:pointer;">' +
                    '<input type="hidden" id="' + id + '" class="ezd-store">' +
                '</div>' +
                '<div class="ezd-drum-wrapper" style="display:none; flex-direction:column; height:auto;">' +
                    // ROW 1: START/END TOGGLE
                    '<div style="flex:0 0 auto; display:flex; justify-content:center; padding:12px 15px 5px 15px; background:transparent; border-bottom:none;">' +
                        '<div class="ezd-seg-container range-switch" style="width:100%; height:32px; padding:3px; background:var(--ezd-border);">' +
                            '<div class="ezd-seg-glider" style="width:50%;"></div>' +
                            '<div class="ezd-seg-option active" data-val="start" style="font-size:11px; font-weight:700;">START</div>' +
                            '<div class="ezd-seg-option" data-val="end" style="font-size:11px; font-weight:700;">END</div>' +
                        '</div>' +
                    '</div>' +
                    // ROW 2: FORMAT TOGGLE
                    '<div style="flex:0 0 auto; display:flex; align-items:center; justify-content:space-between; padding:0 15px 10px 15px; border-bottom:1px solid var(--ezd-border); background:transparent;">' +
                        '<span style="font-size:11px; font-weight:700; color:var(--ezd-text-light);">FORMAT</span>' +
                        '<div class="ezd-seg-container format-switch" style="width:80px; height:24px; padding:2px; background:var(--ezd-border);">' +
                            '<div class="ezd-seg-glider" style="width:50%;"></div>' +
                            '<div class="ezd-seg-option active" data-val="12h" style="font-size:10px; font-weight:800;">12H</div>' +
                            '<div class="ezd-seg-option" data-val="24h" style="font-size:10px; font-weight:800;">24H</div>' +
                        '</div>' +
                    '</div>' +
                    // STAGE
                    '<div class="ezd-drum-stage" style="height:250px; position:relative;">' +
                        '<div class="ezd-drum-highlight" style="top:50%; margin-top:-25px;"></div>' +
                        '<div class="ezd-drum-col" data-type="h"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="m"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="p"><div class="ezd-drum-strip"></div></div>' +
                    '</div>' +
                    // FOOTER
                    '<div class="duration-badge" style="text-align:center; padding:8px; background:transparent; border-top:1px solid var(--ezd-border); font-size:11px; font-weight:700; color:var(--ezd-primary-text);">0h 0m</div>' +
                '</div>' +
            '</div>';

            var display = el.querySelector('#' + id + '-disp');
            var hidden = el.querySelector('#' + id);
            var wrapper = el.querySelector('.ezd-drum-wrapper');
            
            var rangeSwitch = el.querySelector('.range-switch');
            var rangeGlider = rangeSwitch.querySelector('.ezd-seg-glider');
            var rangeOpts = rangeSwitch.querySelectorAll('.ezd-seg-option');

            var formatSwitch = el.querySelector('.format-switch');
            var formatGlider = formatSwitch.querySelector('.ezd-seg-glider');
            var formatOpts = formatSwitch.querySelectorAll('.ezd-seg-option');

            var badge = el.querySelector('.duration-badge');
            var itemH = 50; 

            var state = { view: 'start', start: { h24: 9, m: 0 }, end: { h24: 17, m: 0 } };
            function pad(n) { return String(n).padStart(2, '0'); }

            var sync = function() {
                var sMins = state.start.h24 * 60 + state.start.m;
                var eMins = state.end.h24 * 60 + state.end.m;
                
                // THE PUSH: If start is after end, move the other one to match
                if (state.view === 'start' && sMins > eMins) {
                    state.end.h24 = state.start.h24;
                    state.end.m = state.start.m;
                    eMins = sMins;
                } else if (state.view === 'end' && eMins < sMins) {
                    state.start.h24 = state.end.h24;
                    state.start.m = state.end.m;
                    sMins = eMins;
                }

                var diff = eMins - sMins;
                var dH = Math.floor(diff / 60);
                var dM = diff % 60;
                badge.innerText = `${dH}h ${dM}m Duration`;

                var fmt = (t) => {
                    if (is24h) return `${pad(t.h24)}:${pad(t.m)}`;
                    var h12 = t.h24 % 12 || 12;
                    var p = t.h24 >= 12 ? 'PM' : 'AM';
                    return `${pad(h12)}:${pad(t.m)} ${p}`;
                };
                display.value = `${fmt(state.start)} - ${fmt(state.end)}`;
                hidden.value = `${pad(state.start.h24)}:${pad(state.start.m)},${pad(state.end.h24)}:${pad(state.end.m)}`;
                hidden.dispatchEvent(new Event('change', { bubbles: true }));
            };

            var setupCol = function(type, options) {
                var col = el.querySelector('.ezd-drum-col[data-type="' + type + '"]');
                var strip = col.querySelector('.ezd-drum-strip');
                strip.style.padding = "100px 0";
                var isDragging = false, startY, startScroll, lastIdx = -1;

                var render = function(newOpts) {
                    if(newOpts) options = newOpts;
                    var html = '';
                    options.forEach(function(val) {
                        var dVal = (type === 'p') ? val : pad(val);
                        html += '<div class="ezd-drum-item" data-val="' + val + '">' + dVal + '</div>';
                    });
                    strip.innerHTML = html;
                };

                var highlight = function(val) {
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    items.forEach(function(item) {
                        if (item.dataset.val == val) item.classList.add('active');
                        else item.classList.remove('active');
                    });
                };

                var update = function(val, doSpin) {
                    var idx = options.indexOf(val);
                    if(idx === -1) return;
                    if(doSpin) {
                        col.scrollTo({ top: idx * itemH, behavior: 'smooth' });
                        highlight(val);
                    } else {
                        col.scrollTop = idx * itemH;
                        highlight(val);
                    }
                };
                
                col.addEventListener('mousedown', function(e) { isDragging=true; col.style.cursor='grabbing'; startY=e.pageY; startScroll=col.scrollTop; });
                window.addEventListener('mouseup', function() { if(!isDragging)return; isDragging=false; col.style.cursor='grab'; col.scrollTo({ top:Math.round(col.scrollTop/itemH)*itemH, behavior:'smooth' }); });
                window.addEventListener('mousemove', function(e) { if(!isDragging)return; e.preventDefault(); col.scrollTop = startScroll - ((e.pageY - startY) * 0.8); });

                col.addEventListener('scroll', function() {
                    var index = Math.round(col.scrollTop / itemH);
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    if (index !== lastIdx) {
                        items.forEach(i => i.classList.remove('active')); // Missed Parenthesis Fix
                        if(items[index]) {
                            items[index].classList.add('active');
                            if(typeof audio !== 'undefined' && !wrapper._switching) audio.play('tick');
                            
                            var val = items[index].dataset.val;
                            var active = state[state.view];
                            
                            if(type === 'm') active.m = parseInt(val);
                            else if(type === 'h') {
                                var v = parseInt(val);
                                if(is24h) active.h24 = v;
                                else {
                                    var isPM = active.h24 >= 12;
                                    active.h24 = (v % 12) + (isPM ? 12 : 0);
                                }
                            }
                            else if(type === 'p') {
                                var isPM = val === 'PM';
                                var h12 = active.h24 % 12;
                                active.h24 = h12 + (isPM ? 12 : 0);
                            }
                            sync();
                        }
                        lastIdx = index;
                    }
                });
                return { render: render, update: update, col: col };
            };

            var h12Opts = [1,2,3,4,5,6,7,8,9,10,11,12];
            var h24Opts = Array.from({length: 24}, (_, i) => i);
            var minOpts = Array.from({length: 60}, (_, i) => i);

            var wheels = {
                h: setupCol('h', is24h ? h24Opts : h12Opts),
                m: setupCol('m', minOpts),
                p: setupCol('p', ['AM', 'PM'])
            };

            var refreshView = function() {
                wrapper._switching = true;
                
                var isStart = state.view === 'start';
                rangeGlider.style.transform = isStart ? 'translateX(0)' : 'translateX(99%)';
                
                rangeOpts.forEach((opt, idx) => {
                    var isActive = (idx === 0 && isStart) || (idx === 1 && !isStart);
                    opt.classList.toggle('active', isActive);
                    opt.style.color = isActive ? '#0f172a' : 'var(--ezd-text-light)'; 
                });

                formatGlider.style.transform = is24h ? 'translateX(99%)' : 'translateX(0)';
                
                formatOpts.forEach((opt, idx) => {
                    var isActive = (idx === 0 && !is24h) || (idx === 1 && is24h);
                    opt.classList.toggle('active', isActive);
                    opt.style.color = isActive ? '#0f172a' : 'var(--ezd-text-light)';
                });

                var active = state[state.view];
                var pCol = el.querySelector('.ezd-drum-col[data-type="p"]');
                if(is24h) {
                    pCol.style.display = 'none';
                    wheels.h.render(h24Opts);
                    wheels.h.update(active.h24, true);
                } else {
                    pCol.style.display = 'block';
                    wheels.h.render(h12Opts);
                    wheels.h.update(active.h24 % 12 || 12, true);
                    wheels.p.update(active.h24 >= 12 ? 'PM' : 'AM', true);
                }
                wheels.m.update(active.m, true); 
                
                sync();
                setTimeout(() => { wrapper._switching = false; }, 200);
            };

            rangeSwitch.onclick = function(e) {
                e.stopPropagation();
                state.view = (state.view === 'start') ? 'end' : 'start';
                if(typeof audio !== 'undefined') audio.play('open');
                refreshView();
            };
            
            formatSwitch.onclick = function(e) {
                e.stopPropagation();
                is24h = !is24h;
                if(typeof audio !== 'undefined') audio.play('open');
                refreshView();
            };

            hidden._fds_update = function(newVal) {
                if(!newVal || !newVal.includes(',')) return;
                var parts = newVal.split(',');
                var parse = (s) => {
                    var t = s.split(':');
                    return { h24: parseInt(t[0]), m: parseInt(t[1]) };
                };
                state.start = parse(parts[0]);
                state.end = parse(parts[1]);
                state.view = 'start';
                refreshView();
                if(window.EZD_UI._utils.flashInput) window.EZD_UI._utils.flashInput(display, 'valid');
            };

            wheels.h.render(); wheels.m.render(); wheels.p.render();
            refreshView(); 

            display.addEventListener('paste', (e) => {
                window.EZD_UI._utils.smartPaste(e, 'time', (timeStr) => {
                    if (display._pasteState && display._pasteState.index > 0) { is24h = !is24h; }
                    var parts = timeStr.split(':');
                    var h = parseInt(parts[0]);
                    var m = parseInt(parts[1]);
                    state[state.view] = { h24: h, m: m };
                    sync();
                    refreshView();
                    window.EZD_UI._utils.flashInput(display, 'typing');
                });
            });

            display.addEventListener('copy', (e) => {
                e.preventDefault();
                if (e.clipboardData) {
                    var active = state[state.view]; 
                    var text = "";
                    if (is24h) {
                        text = `${pad(active.h24)}:${pad(active.m)}`;
                    } else {
                        var h12 = active.h24 % 12 || 12;
                        var p = active.h24 >= 12 ? 'PM' : 'AM';
                        text = `${pad(h12)}:${pad(active.m)} ${p}`;
                    }
                    e.clipboardData.setData('text/plain', text);
                    var tabName = state.view === 'start' ? 'Start Time' : 'End Time';
                    window.EZD_UI.notify('success', `Copied ${tabName}`, text);
                    window.EZD_UI._utils.flashInput(display, 'valid');
                }
            });

            display.onmousedown = function(e) {
                e.stopPropagation(); e.preventDefault();
                display.focus({preventScroll:true});
                if (wrapper.style.display === 'flex') return;
                window.EZD_UI._utils.closeAllMenus();
                
                wrapper.style.display = 'flex';
                el.classList.add('ezd-lift-layer'); 
                
                refreshView(); 
                
                wrapper.animate([{ opacity: 0, transform: 'translateY(-10px)' }, { opacity: 1, transform: 'translateY(0)' }], { duration: 200 });
            };
            
            wrapper.onmousedown = function(e) { e.stopPropagation(); };
        },
      buildDrumDate: function(el) {
            var id = el.id || 'trange-' + Math.random().toString(36).substr(2,9); 
            el.removeAttribute('id'); // FIX: Removes duplicate ID from wrapper
            var label = el.dataset.label || 'Select Date';
            
            // FIX: Re-added height:250px to .ezd-drum-stage to prevent explosion
            // FIX: Re-added display:none to wrapper
            el.innerHTML = '<div class="ezd-input-group" style="position:relative;">' +
                '<label class="ezd-label">' + label + '</label>' +
                '<div class="ezd-input-wrapper">' +
                    '<i class="fas fa-calendar-alt ezd-fixed-icon"></i>' +
                    '<input type="text" id="' + id + '-disp" class="ezd-smart-input" placeholder="DD - MM - YYYY" readonly style="cursor:pointer;">' +
                    '<input type="hidden" id="' + id + '" class="ezd-store">' +
                '</div>' +
                '<div class="ezd-drum-wrapper" style="display:none; height:auto;">' +
                    '<div class="ezd-drum-stage" style="height:250px; position:relative;">' +
                        '<div class="ezd-drum-highlight" style="top:50%; margin-top:-25px;"></div>' +
                        '<div class="ezd-drum-col" data-type="d"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="m"><div class="ezd-drum-strip"></div></div>' +
                        '<div class="ezd-drum-col" data-type="y"><div class="ezd-drum-strip"></div></div>' +
                    '</div>' +
                '</div>' +
            '</div>';

            var display = el.querySelector('#' + id + '-disp');
            var hidden = el.querySelector('#' + id);
            var wrapper = el.querySelector('.ezd-drum-wrapper');
            var itemH = 50; 

            var now = new Date();
            var state = { d: now.getDate(), m: now.getMonth() + 1, y: now.getFullYear() };

            function getDays(m, y) { return new Date(y, m, 0).getDate(); }
            function pad(n) { return String(n).padStart(2, '0'); }

            var sync = function() {
                var max = getDays(state.m, state.y);
                if(state.d > max) state.d = max;
                
                var dCol = el.querySelector('.ezd-drum-col[data-type="d"]');
                var currentCount = dCol.querySelectorAll('.ezd-drum-item').length;
                if (currentCount !== max) {
                    wheels.d.render(max);
                }
                
                wheels.d.highlight(state.d);
                
                wheels.d.update(state.d);
                wheels.m.update(state.m);
                wheels.y.update(state.y);

                display.value = pad(state.d) + ' - ' + pad(state.m) + ' - ' + state.y;
                hidden.value = state.y + '-' + pad(state.m) + '-' + pad(state.d);
                hidden.dispatchEvent(new Event('change', { bubbles: true }));
            };

            var setupCol = function(type, min, maxInitial) {
                var col = el.querySelector('.ezd-drum-col[data-type="' + type + '"]');
                var strip = col.querySelector('.ezd-drum-strip');
                strip.style.padding = "100px 0";
                
                var isDragging = false, startY, startScroll, lastIdx = -1;
                
                var render = function(dynamicMax) {
                    var currentMax = dynamicMax || maxInitial;
                    var html = '';
                    for(var i = min; i <= currentMax; i++) {
                        var isActive = (i === state[type]);
                        var cls = isActive ? 'ezd-drum-item active' : 'ezd-drum-item';
                        var val = (type === 'y') ? i : pad(i);
                        html += '<div class="' + cls + '" data-val="' + i + '">' + val + '</div>';
                    }
                    strip.innerHTML = html;
                };

                var highlight = function(val) {
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    items.forEach(function(item) {
                        var itemVal = parseInt(item.dataset.val);
                        if (itemVal === val) item.classList.add('active');
                        else item.classList.remove('active');
                    });
                };

                var update = function(val) {
                    var index = val - min;
                    col.scrollTop = index * itemH;
                };

                col.addEventListener('mousedown', function(e) { isDragging = true; col.style.cursor = 'grabbing'; startY = e.pageY; startScroll = col.scrollTop; });
                window.addEventListener('mouseup', function() { if (!isDragging) return; isDragging = false; col.style.cursor = 'grab'; col.scrollTo({ top: Math.round(col.scrollTop / itemH) * itemH, behavior: 'smooth' }); });
                window.addEventListener('mousemove', function(e) { if (!isDragging) return; e.preventDefault(); col.scrollTop = startScroll - ((e.pageY - startY) * 0.8); });

                col.addEventListener('scroll', function() {
                    var index = Math.round(col.scrollTop / itemH);
                    var items = strip.querySelectorAll('.ezd-drum-item');
                    if (index !== lastIdx) {
                        items.forEach(function(i) { i.classList.remove('active'); });
                        if(items[index]) {
                            items[index].classList.add('active');
                            var newVal = parseInt(items[index].dataset.val);
                            if(state[type] !== newVal) {
                                state[type] = newVal;
                                if(typeof audio !== 'undefined') audio.play('tick');
                                sync();
                            }
                        }
                        lastIdx = index;
                    }
                });

                return { render: render, update: update, highlight: highlight };
            };

            // FIX: Adjusted years to 1950 - 2050 (Cleaner than 1900)
            var wheels = { d: setupCol('d', 1, 31), m: setupCol('m', 1, 12), y: setupCol('y', 1950, 2050) };

            hidden._fds_update = function(newVal) {
                if(!newVal || !newVal.includes('-')) return;
                var parts = newVal.split('-');
                state.y = parseInt(parts[0]);
                state.m = parseInt(parts[1]);
                state.d = parseInt(parts[2]);
                sync();
                if(window.EZD_UI._utils.flashInput) {
                    window.EZD_UI._utils.flashInput(display, 'valid');
                }
            };

            wheels.d.render(); wheels.m.render(); wheels.y.render();
            sync(); // Initial Sync

            display.addEventListener('paste', (e) => {
                window.EZD_UI._utils.smartPaste(e, 'date', (res) => {
                    state.d = res.d; state.m = res.m; state.y = res.y;
                    sync();
                    window.EZD_UI._utils.flashInput(display, 'typing');
                });
            });

            display.addEventListener('copy', (e) => {
                e.preventDefault();
                if (e.clipboardData) {
                    e.clipboardData.setData('text/plain', display.value);
                    window.EZD_UI.notify('success', 'Copied Date', display.value);
                    window.EZD_UI._utils.flashInput(display, 'valid');
                }
            });

            // FIX: Check for 'block' display instead of 'flex' (Single dates use block)
            display.onmousedown = function(e) {
                e.stopPropagation(); 
                display.focus({ preventScroll: true });

                if (wrapper.style.display === 'block') return;
                window.EZD_UI._utils.closeAllMenus();
                
                wrapper.style.display = 'block';
                el.classList.add('ezd-lift-layer'); 
                
                requestAnimationFrame(function() { 
                    wheels.d.update(state.d); 
                    wheels.m.update(state.m); 
                    wheels.y.update(state.y); 
                });

                wrapper.animate([{ opacity: 0, transform: 'translateY(-10px)' }, { opacity: 1, transform: 'translateY(0)' }], { duration: 200 });
            };
            
            wrapper.onmousedown = function(e) { e.stopPropagation(); };
        },
        
      buildToggle: (el) => {
            const id = el.id; el.removeAttribute('id');
            const label = el.dataset.label || 'Toggle';
            const isOn = el.dataset.checked === 'true' || el.dataset.value === 'true';
            
            el.innerHTML = `
                <div class="ezd-toggle-wrapper ${isOn?'active':''}" id="wrap-${id}">
                    <span class="ezd-label" style="margin:0; cursor:pointer;">${label}</span>
                    <div class="ezd-toggle-track"><div class="ezd-toggle-knob"></div></div>
                    <input type="hidden" id="${id}" value="${isOn}" class="ezd-store">
                </div>`;
            
            const wrapper = el.querySelector('.ezd-toggle-wrapper');
            const hidden = el.querySelector('.ezd-store');
            
            wrapper.onclick = () => {
                const newState = !wrapper.classList.contains('active');
                wrapper.classList.toggle('active', newState);
                hidden.value = newState;
                window.EZD_UI._utils.dispatchChange(hidden);
            };
            hidden.addEventListener('change', () => {
                wrapper.classList.toggle('active', hidden.value === 'true');
            });
        },

        buildAccordion: (el) => {
            const label = el.dataset.label || 'Section';
            const startOpen = el.dataset.open === 'true'; // Default is CLOSED unless specified
            
            // 1. Create Shell
            const wrapper = document.createElement('div');
            wrapper.className = 'ezd-accordion';
            if (startOpen) wrapper.classList.add('open');
            
            const header = document.createElement('div');
            header.className = 'ezd-accordion-header';
            header.innerHTML = `<span>${label}</span><i class="fas fa-chevron-down"></i>`;
            
            const body = document.createElement('div');
            body.className = 'ezd-accordion-body';
            
            const content = document.createElement('div');
            content.className = 'ezd-accordion-content';
            
            // 2. Move Children
            while (el.childNodes.length > 0) {
                content.appendChild(el.childNodes[0]);
            }
            
            // 3. Assemble
            body.appendChild(content);
            wrapper.appendChild(header);
            wrapper.appendChild(body);
            
            // 4. Interaction Logic (The Slide)
            header.onclick = () => {
                const isOpen = wrapper.classList.contains('open');
                
                if (isOpen) {
                    // CLOSE
                    // 1. Lock height to current pixel value (so it can animate down)
                    body.style.maxHeight = body.scrollHeight + "px";
                    
                    // 2. Force reflow
                    void body.offsetWidth; 

                    // 3. Set to 0 to trigger slide
                    wrapper.classList.remove('open');
                    body.style.maxHeight = "0px";
                    
                } else {
                    // OPEN
                    wrapper.classList.add('open');
                    // Set max-height to the scrollHeight (exact size of content)
                    body.style.maxHeight = body.scrollHeight + "px";
                    
                    // Cleanup: After animation, set to 'none' so it can grow if content changes
                    setTimeout(() => {
                        if(wrapper.classList.contains('open')) {
                            body.style.maxHeight = "none";
                            body.style.overflow = "visible"; // Allows dropdowns to spill out
                        }
                    }, 350); // Matches CSS duration
                    
                    if(typeof audio !== 'undefined') audio.play('open');
                }
            };
            
            // Initial State Logic
            if (startOpen) {
                body.style.maxHeight = "none";
                body.style.overflow = "visible";
            } else {
                body.style.maxHeight = "0px";
            }

            // 5. Deploy
            el.innerHTML = ""; // Clear original container
            el.appendChild(wrapper);
            
            // Unwrap: Remove the 'data-ezd-type' wrapper so we don't have double divs
            // We basically just used 'el' as a placeholder in the HTML
            el.style.display = 'block';
            el.style.marginBottom = '15px';
            el.removeAttribute('data-ezd-type');
        },

        // --- NEW: Helper to calculate average RGB from image data ---
        _getRGB: (data) => {
             let r=0, g=0, b=0, count=0;
             // Sample every 4th pixel for speed in local blocks
             for (let i = 0; i < data.length; i += 16) { 
                 r += data[i]; g += data[i+1]; b += data[i+2]; count++;
             }
             return `rgb(${Math.floor(r/count)},${Math.floor(g/count)},${Math.floor(b/count)})`;
        },

        // --- NEW: Extracts both overall average AND a palette of local colors ---
        getImageColors: (imgEl, samples = 16) => {
            try {
                const canvas = document.createElement('canvas');
                // Scale down significantly for faster processing. 
                // 100px is enough to get good color data.
                const scale = Math.min(1, 100 / imgEl.naturalWidth);
                canvas.width = imgEl.naturalWidth * scale;
                canvas.height = imgEl.naturalHeight * scale;
                
                const ctx = canvas.getContext('2d', {willReadFrequently: true});
                ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);
                
                // 1. Overall Average Background Color
                const totalData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                const bgColor = window.EZD_UI._utils._getRGB(totalData);

                // 2. Localized Palette (Grid Sampling)
                const palette = [];
                const cols = Math.ceil(Math.sqrt(samples));
                const rows = Math.ceil(samples / cols);
                const blockW = canvas.width / cols;
                const blockH = canvas.height / rows;

                for(let i=0; i<cols; i++) {
                    for(let j=0; j<rows; j++) {
                        // Grab data for this specific grid cell
                        const blockData = ctx.getImageData(i*blockW, j*blockH, blockW, blockH).data;
                        palette.push(window.EZD_UI._utils._getRGB(blockData));
                    }
                }
                
                return { bg: bgColor, palette: palette };

            } catch(e) { 
                console.warn("Color extraction failed", e);
                return { bg: '#f1f5f9', palette: ['#cbd5e1', '#94a3b8'] }; // Fallbacks
            }
        },

        buildFileUpload: (el) => {
            const id = el.id; el.removeAttribute('id');
            const label = el.dataset.label || 'Upload File';
            // Limit in Bytes (Default 500KB)
            const limitBytes = parseInt(el.dataset.maxKb || 500) * 1024;
            const helpHTML = el.dataset.help ? `<i class="fas fa-question-circle ezd-help-icon" title="${el.dataset.help}"></i>` : '';

            el.innerHTML = `
                <div class="ezd-input-group">
                    <label class="ezd-label">${label}${helpHTML}</label>
                    <div class="ezd-file-zone">
                        <div class="ezd-bubble-container"></div>
                        <div class="ezd-file-content">
                            <i class="fas fa-cloud-upload-alt" style="font-size:24px; color:#cbd5e1; margin-bottom:8px;"></i>
                            <div style="font-size:13px; color:#64748b;">Drop image (Auto-compressed to ${el.dataset.maxKb||500}KB)</div>
                        </div>
                        <div class="ezd-file-preview">
                            <div class="ezd-file-remove" title="Remove File"><i class="fas fa-times"></i></div>
                            <div class="file-icon"><i class="fas fa-file-alt" style="font-size:32px; color:var(--ezd-primary);"></i></div>
                            <span class="fname" style="font-size:13px; font-weight:600; color:#334155; word-break:break-all;"></span>
                            <span class="fstatus" style="font-size:11px; color:#94a3b8; margin-top:4px;"></span>
                        </div>
                        <input type="file" style="display:none;" accept="image/*,.pdf">
                        <input type="hidden" id="${id}" class="ezd-store"> <input type="hidden" id="${id}_data" class="ezd-file-data"> <input type="hidden" id="${id}_mime" class="ezd-file-mime"> 
                    </div>
                </div>`;
                
            const zone = el.querySelector('.ezd-file-zone'); const bubbleContainer = el.querySelector('.ezd-bubble-container');
            const fileInp = el.querySelector('input[type="file"]'); const hiddenName = el.querySelector('.ezd-store');
            const hiddenData = el.querySelector('.ezd-file-data'); const hiddenMime = el.querySelector('.ezd-file-mime');
            const content = el.querySelector('.ezd-file-content'); const preview = el.querySelector('.ezd-file-preview');
            const removeBtn = el.querySelector('.ezd-file-remove'); const iconContainer = preview.querySelector('.file-icon');
            const nameSpan = el.querySelector('.fname'); const statusSpan = el.querySelector('.fstatus');
            let activeProcess = { aborted: false };

            const compressImage = (file) => {
                return new Promise((resolve) => {
                    // Smart Skip: If small, bypass compression
                    if (!file.type.startsWith('image/') || file.size <= limitBytes) {
                        console.log(" Skipped compression"); return resolve({ blob: file, dataUrl: null });
                    }
                    const img = new Image(); const url = URL.createObjectURL(file); img.src = url;
                    img.onload = () => {
                        if(activeProcess.aborted) return resolve(null);
                        URL.revokeObjectURL(url);
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height, MAX_DIM = 1920;
                        if (width > height) { if (width > MAX_DIM) { height *= MAX_DIM / width; width = MAX_DIM; } }
                        else { if (height > MAX_DIM) { width *= MAX_DIM / height; height = MAX_DIM; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        fetch(dataUrl).then(res => res.blob()).then(blob => { resolve({ blob: blob, dataUrl: dataUrl }); });
                    };
                    img.onerror = () => resolve({ blob: file, dataUrl: null });
                });
            };
            const _toRGB = (data) => { let r=0,g=0,b=0,count=0; for (let i = 0; i < data.length; i += 16) { r += data[i]; g += data[i+1]; b += data[i+2]; count++; } return `rgb(${Math.floor(r/count)},${Math.floor(g/count)},${Math.floor(b/count)})`; };
            const rnd = (min, max) => Math.floor(Math.random() * (max - min + 1) + min) + 'px';
            const computeHash = async (blob) => { const buffer = await blob.arrayBuffer(); const hashBuffer = await crypto.subtle.digest('SHA-256', buffer); return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16); };
            const setZoneState = (state) => { zone.classList.remove('scanning', 'uploading', 'success', 'error'); if(state) zone.classList.add(state); };

            zone.onclick = (e) => { if(e.target.closest('.ezd-file-remove') || preview.style.display === 'flex') return; fileInp.click(); };
            removeBtn.onclick = (e) => { e.stopPropagation(); activeProcess.aborted = true; fileInp.value = ""; hiddenName.value = ""; hiddenData.value = ""; hiddenMime.value = ""; preview.style.display = 'none'; content.style.display = 'block'; setZoneState(''); zone.style.removeProperty('--dynamic-bg'); bubbleContainer.innerHTML = ''; statusSpan.innerText = ""; window.EZD_UI._utils.dispatchChange(hiddenName); };
            
            const handleFile = async (rawFile) => {
                if(!rawFile) return;
                activeProcess = { aborted: false };
                content.style.display = 'none'; preview.style.display = 'flex'; nameSpan.innerText = "Processing..."; statusSpan.innerText = "Analyzing..."; nameSpan.style.color = "#64748b"; iconContainer.innerHTML = `<i class="fas fa-cog fa-spin" style="color:#64748b; font-size:32px;"></i>`; setZoneState('scanning'); audio.startProcess(); zone.style.removeProperty('--dynamic-bg'); bubbleContainer.innerHTML = '';
                try {
                    statusSpan.innerText = "Optimizing..."; const result = await compressImage(rawFile); if(activeProcess.aborted || !result) return;
                    const { blob, dataUrl } = result; const finalFile = blob; 
                    statusSpan.innerText = "Fingerprinting..."; const hash = await computeHash(finalFile); if(activeProcess.aborted) return;
                    let ext = rawFile.name.split('.').pop().toLowerCase(); if (dataUrl) ext = 'jpg'; const secureName = `${hash}.${ext}`;
                    hiddenName.value = secureName; hiddenMime.value = finalFile.type;
                    statusSpan.innerText = "Extracting colors..."; 
                    let finalDataUrl = dataUrl; if (!finalDataUrl) { finalDataUrl = await new Promise(r => { const reader = new FileReader(); reader.onload = (e) => r(e.target.result); reader.readAsDataURL(finalFile); }); }
                    if(activeProcess.aborted) return; hiddenData.value = finalDataUrl;
                    let domColor = '#e2e8f0', palette = [];
                    setZoneState('uploading'); nameSpan.innerText = "Verifying..."; nameSpan.style.color = "#f59e0b"; iconContainer.innerHTML = `<i class="fas fa-cloud-upload-alt" style="font-size:32px; color:#f59e0b;"></i>`;
                    if (finalFile.type.startsWith('image/')) {
                        const img = new Image(); img.src = finalDataUrl;
                        img.onload = () => {
                            if(activeProcess.aborted) return;
                            try {
                                const canvas = document.createElement('canvas');
                                const scale = Math.min(1, 100 / img.naturalWidth);
                                canvas.width = img.naturalWidth * scale; 
                                canvas.height = img.naturalHeight * scale;
                                
                                // --- THE FIX: Add { willReadFrequently: true } ---
                                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                                
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                domColor = _toRGB(ctx.getImageData(0, 0, canvas.width, canvas.height).data);
                                
                                const cols = 4, rows = 4;
                                const blockW = canvas.width / cols; 
                                const blockH = canvas.height / rows;
                                
                                for(let i=0; i<cols; i++) { 
                                    for(let j=0; j<rows; j++) { 
                                        palette.push(_toRGB(ctx.getImageData(i*blockW, j*blockH, blockW, blockH).data)); 
                                    } 
                                }
                            } catch(e) { console.warn("Color extract error", e); }
                            
                            iconContainer.innerHTML = ''; 
                            iconContainer.appendChild(img);
                        };
                    } else { iconContainer.innerHTML = `<i class="fas fa-file-pdf" style="font-size:32px; color:#ef4444;"></i>`; }
                    statusSpan.innerText = "Syncing...";
                    window.EZD_UI.uploadData(id).then(response => {
                      audio.stopProcess(true);
                        if(activeProcess.aborted) return;
                        setZoneState('success'); nameSpan.innerText = secureName; statusSpan.innerText = "Complete";
                        zone.style.setProperty('--dynamic-bg', domColor); nameSpan.style.color = "#1e293b";
                        if (!finalFile.type.startsWith('image/')) { iconContainer.innerHTML = `<i class="fas fa-check-circle" style="font-size:32px; color:${domColor};"></i>`; }
                        if(response.status === 'matched') { nameSpan.innerHTML += ` <i class="fas fa-link" title="Duplicate Found"></i>`; statusSpan.innerText = "Storage optimized"; }
                        if(palette.length > 0) {
                            let bubblesHTML = '';
                            for(let i=0; i<15; i++) {
                                const color = palette[Math.floor(Math.random() * palette.length)], size = Math.floor(Math.random() * 80 + 20) + 'px', delay = (Math.random() * -10) + 's';
                                const dx1=rnd(-100,100), dy1=rnd(-80,80), dx2=rnd(-100,100), dy2=rnd(-80,80), dx3=rnd(-100,100), dy3=rnd(-80,80);
                                bubblesHTML += `<div class="ezd-bubble" style="--bubble-color:${color}; --size:${size}; --delay:${delay}; --dx1:${dx1}; --dy1:${dy1}; --dx2:${dx2}; --dy2:${dy2}; --dx3:${dx3}; --dy3:${dy3};"></div>`;
                            }
                            bubbleContainer.innerHTML = bubblesHTML;
                        }
                    }).catch(err => { audio.stopProcess(false); audio.play('error'); if(activeProcess.aborted) return; setZoneState('error'); nameSpan.innerText = "Error"; nameSpan.style.color = "#ef4444"; statusSpan.innerText = "Network Error"; });
                } catch (e) { if(activeProcess.aborted) return; console.error(e); setZoneState('error'); nameSpan.innerText = "Failed"; }
            };
            fileInp.onchange = (e) => handleFile(e.target.files[0]);
            zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
            zone.ondragleave = () => zone.classList.remove('dragover');
            zone.ondrop = (e) => { e.preventDefault(); zone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
            hiddenName.addEventListener('change', () => { if(hiddenName.value && !hiddenName.value.startsWith('http')) { /* Hydration */ } });
        },
        buildTabs: (el) => {
            const id = el.id || 'tabs-' + Math.random().toString(36).substr(2,9);
            let panels = [];
            for (let i = 0; i < el.children.length; i++) {
                if (el.children[i].tagName === 'DIV') panels.push(el.children[i]);
            }
            if (panels.length === 0) return; 

            const variant = el.dataset.variant || 'underline'; 
            const isVertical = el.dataset.vertical === 'true';

            const tabsData = panels.map((child, idx) => ({
                label: child.dataset.tab || `Tab ${idx+1}`,
                icon: child.dataset.icon || '',
                badge: child.dataset.badge || '',
                disabled: child.dataset.disabled === 'true',
                content: child.innerHTML,
                id: `tab-${id}-${idx}`
            }));

            el.removeAttribute('id');
            el.className = 'ezd-tabs-root';
            el.dataset.variant = variant;
            el.dataset.vertical = isVertical;
            
            // --- SURGICAL FIX: Flatten Nested Templates ---
            const listHTML = tabsData.map((t, i) => {
                const iconHTML = t.icon ? `<i class="fas ${t.icon}"></i>` : '';
                const badgeHTML = t.badge ? `<span class="ezd-tab-badge">${t.badge}</span>` : '';
                return `<button class="ezd-tab-btn ${t.disabled ? 'disabled' : ''}" 
                            role="tab" aria-selected="false" aria-controls="panel-${t.id}" 
                            data-target="${t.id}" data-idx="${i}" data-label="${t.label}"
                            type="button" tabindex="${t.disabled ? '-1' : '0'}">
                            ${iconHTML}
                            <span>${t.label}</span>
                            ${badgeHTML}
                        </button>`;
            }).join('');

            const panelsHTML = tabsData.map((t, i) => `
                        <div class="ezd-tab-panel" id="panel-${t.id}" role="tabpanel" aria-labelledby="btn-${t.id}">
                            ${t.content}
                        </div>`).join('');

            el.innerHTML = `
                <div class="ezd-tab-list" role="tablist" aria-orientation="${isVertical?'vertical':'horizontal'}">
                    ${listHTML}
                </div>
                <div class="ezd-tab-panels">
                    ${panelsHTML}
                </div>
                <input type="hidden" id="${id}" class="ezd-store">
            `;
            // ----------------------------------------------

            if (window.EZD_UI && window.EZD_UI.init) {
                setTimeout(() => window.EZD_UI.init(el), 0);
            }

            const buttons = el.querySelectorAll(':scope > .ezd-tab-list > .ezd-tab-btn');
            const contentPanels = el.querySelectorAll(':scope > .ezd-tab-panels > .ezd-tab-panel');
            const hidden = el.querySelector(':scope > .ezd-store');

            const activate = (val) => {
                let targetIdx = parseInt(val);
                if (isNaN(targetIdx)) {
                    targetIdx = tabsData.findIndex(t => t.label === val);
                }
                if (targetIdx < 0 || targetIdx >= buttons.length) return;

                buttons.forEach((btn, i) => {
                    const isActive = (i === targetIdx);
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-selected', isActive);
                    contentPanels[i].classList.toggle('active', isActive);
                });
                
                if(hidden && hidden.value != targetIdx) hidden.value = targetIdx;
            };

            buttons.forEach((btn, idx) => {
                if(btn.classList.contains('disabled')) return;
                btn.addEventListener('click', (e) => { 
                    e.preventDefault(); e.stopPropagation(); 
                    activate(idx);
                    if (window.EZD_UI._utils) window.EZD_UI._utils.dispatchChange(hidden);
                });
            });

            hidden.addEventListener('change', (e) => {
                e.stopPropagation(); activate(hidden.value);
            });

            const firstActive = tabsData.findIndex(t => !t.disabled);
            if(firstActive > -1) activate(firstActive);
        },
        buildSegmented: (el) => {
            const id = el.id || 'seg-' + Math.random().toString(36).substr(2,9);
            el.removeAttribute('id');
            const rawOpts = el.dataset.options || '[]';
            const label = el.dataset.label || '';
            const variant = el.dataset.variant || 'pill';
            const initialVal = el.dataset.value || '';
            
            let options = [];
            try { 
                const parsed = JSON.parse(rawOpts);
                options = parsed.map(o => (typeof o === 'object' ? o : { label: o, val: o }));
            } catch(e) { options = []; }

            if(options.length === 0) return;

            const labelHTML = label ? `<label class="ezd-label" id="lbl-${id}">${label}</label>` : '';
            
            const optionsHTML = options.map((o, i) => {
                const iconHTML = o.icon ? `<i class="fas ${o.icon}"></i>` : '';
                return `<div class="ezd-seg-option" tabindex="${i===0?0:-1}" role="radio" aria-checked="false" data-val="${o.val}" data-idx="${i}">
                            ${iconHTML}
                            <span>${o.label}</span>
                        </div>`;
            }).join('');

            el.innerHTML = `
            <div class="ezd-seg-wrapper" id="wrap-${id}">
                ${labelHTML}
                <div class="ezd-seg-container" data-variant="${variant}" role="radiogroup" aria-labelledby="lbl-${id}">
                    <div class="ezd-seg-glider" style="width: calc(100% / ${options.length});"></div>
                    ${optionsHTML}
                </div>
                <input type="hidden" id="${id}" value="${initialVal}" class="ezd-store">
            </div>`;

            const items = el.querySelectorAll('.ezd-seg-option');
            const glider = el.querySelector('.ezd-seg-glider');
            const hidden = el.querySelector('.ezd-store');

            const updateUI = (val) => {
                // Batch the DOM reads/writes to the next animation frame
                requestAnimationFrame(() => {
                    let idx = -1;
                    items.forEach((item, i) => {
                        const isMatch = String(item.dataset.val) === String(val);
                        // Only touch DOM if changed
                        if (item.classList.contains('active') !== isMatch) {
                            item.classList.toggle('active', isMatch);
                            item.setAttribute('aria-checked', isMatch);
                            item.tabIndex = isMatch ? 0 : -1; 
                        }
                        if(isMatch) idx = i;
                    });
                    
                    if(idx === -1 && items.length > 0) items[0].tabIndex = 0;

                    if(idx > -1) {
                        glider.style.display = 'block';
                        // Use translate3d for GPU acceleration
                        glider.style.transform = "translate3d(" + (idx * 99) + "%, 0, 0)";
                    } else {
                        glider.style.display = 'none';
                    }
                });
            };

            const setValue = (val) => {
                hidden.value = val;
                if (window.EZD_UI._utils) window.EZD_UI._utils.dispatchChange(hidden);
                updateUI(val);
            };

            items.forEach((item, i) => {
                // Click
                item.addEventListener('click', () => {
                    setValue(item.dataset.val);
                    audio.play('click'); // <--- 1. ADD SOUND
                    item.blur();         // <--- 2. FIX STICKY HIGHLIGHT
                });
                
                // Keyboard (Arrows + Enter)
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        setValue(item.dataset.val);
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        const next = items[i + 1] || items[0];
                        next.focus();
                        // Optional: Auto-select on arrow move? Usually standard is manual select.
                        // For segmented controls, manual selection (Enter) is safer.
                    } else if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        const prev = items[i - 1] || items[items.length - 1];
                        prev.focus();
                    }
                });
            });

            hidden.addEventListener('change', () => updateUI(hidden.value));
            updateUI(initialVal);
        },
        
        // REPLACE the existing toggleDarkMode with this:
        toggleDarkMode: function(isDark) {
            const root = document.documentElement;
            // Get the current base color
            const baseColor = getComputedStyle(root).getPropertyValue('--ezd-primary').trim();

            if (isDark) {
                document.body.classList.add('ezd-dark-mode');
                
                // 1. Dark Mode Base Palette
                root.style.setProperty('--ezd-bg', '#0f172a');      
                root.style.setProperty('--ezd-text', '#f1f5f9');    
                root.style.setProperty('--ezd-text-light', '#94a3b8'); 
                root.style.setProperty('--ezd-border', '#334155');
                
                // 2. THE FIX: Make text 40% brighter than the brand color
                // If Base is Dark Red (#8B0000) -> Text becomes Bright Red (#dd5555)
                const brightColor = window.EZD_UI._utils.lightenColor(baseColor, 40);
                root.style.setProperty('--ezd-primary-text', brightColor);

            } else {
                document.body.classList.remove('ezd-dark-mode');
                
                // 1. Light Mode Base Palette
                root.style.setProperty('--ezd-bg', '#ffffff');
                root.style.setProperty('--ezd-text', '#334155');
                root.style.setProperty('--ezd-text-light', '#64748b');
                root.style.setProperty('--ezd-border', '#e2e8f0');
                
                // 2. Reset text to match the brand color exactly
                root.style.setProperty('--ezd-primary-text', baseColor);
            }
        },

        buildPhone: (el) => {
            const id = el.id || 'phone-' + Math.random().toString(36).substr(2,9);
            el.removeAttribute('id');
            const label = el.dataset.label || 'Phone Number';
            const helpHTML = el.dataset.help ? `<i class="fas fa-question-circle ezd-help-icon" title="${el.dataset.help}"></i>` : '';
            
            // A11Y FIX: 'for' attribute links label to the main input
            el.innerHTML = `
                <div class="ezd-input-group">
                    <label class="ezd-label" for="${id}">${label}${helpHTML}</label>
                    <div class="ezd-phone-wrapper">
                        <input type="text" class="ezd-phone-code" value="+1" placeholder="+1" aria-label="Country Code">
                        <input type="tel" id="${id}" class="ezd-phone-number" placeholder="(555) 123-4567">
                    </div>
                </div>`;
                
            const wrapper = el.querySelector('.ezd-phone-wrapper');
            const codeInput = el.querySelector('.ezd-phone-code');
            const numInput = el.querySelector('.ezd-phone-number');
            
            const toggleFocus = () => wrapper.classList.toggle('focused');
            codeInput.onfocus = toggleFocus; codeInput.onblur = toggleFocus;
            numInput.onfocus = toggleFocus; numInput.onblur = toggleFocus;
            
            // Format Logic
            numInput.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 10) v = v.substring(0, 10); 
                const match = v.match(/^(\d{0,3})(\d{0,3})(\d{0,4})$/);
                if (match) {
                    e.target.value = !match[2] ? match[1] : `(${match[1]}) ${match[2]}${match[3] ? '-' + match[3] : ''}`;
                }
            });
            codeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9+]/g, '');
            });
        },
        buildSmartInput: function(el) {
            var id = el.id || 'input-' + Math.random().toString(36).substr(2,9); el.removeAttribute('id');
            var type = el.dataset.type || 'text'; var label = el.dataset.label || ''; var placeholder = el.dataset.placeholder || '';
            var context = el.dataset.context; 

            // 1. HTML Gen
            var helpHTML = el.dataset.help ? `<i class="fas fa-question-circle ezd-help-icon" title="${el.dataset.help}"></i>` : '';
            var labelHTML = label ? `<label class="ezd-label" for="${id}">` + label + helpHTML + '</label>' : '';
            
            var icon = el.dataset.icon || 'fa-pen';
            if(type === 'email') icon = 'fa-envelope';
            else if(type === 'search' || context === 'location') icon = 'fa-search';
            // ... (Add back other icons if you wish) ...

            var inputHTML = type === 'textarea' ? `<textarea id="${id}" class="ezd-smart-input" placeholder="${placeholder}"></textarea>` : `<input type="text" id="${id}" class="ezd-smart-input" placeholder="${placeholder}">`;
            var locHTML = context === 'location' ? '<div class="ezd-search-results"></div>' : '';

            el.innerHTML = '<div class="ezd-input-group">' + labelHTML + '<div class="ezd-input-wrapper"><i class="fas ' + icon + ' ezd-fixed-icon"></i>' + inputHTML + locHTML + '</div></div>';
            
            var input = document.getElementById(id);
            var wrapper = el.querySelector('.ezd-input-group'); // For Z-Index lifting

            // 2. Validation / Flash Logic
            input.addEventListener('input', function() { window.EZD_UI._utils.flashInput(input, 'typing'); });
            input.addEventListener('blur', function(e) {
                // Remove Z-Index Lift on blur
                if(wrapper) wrapper.classList.remove('ezd-lift-layer');
                if(wrapper.closest('.ui-section')) wrapper.closest('.ui-section').style.zIndex = "";

                var v = e.target.value; if (!v) { input.classList.remove('invalid', 'valid'); return; }
                // ... (Existing validation logic) ...
                input.classList.add('valid');
            });

            // ===============================================
            // 3. REAL-WORLD API LOCATION ENGINE (Fix: Mousedown)
            // ===============================================
            if (context === 'location') {
                const results = el.querySelector('.ezd-search-results');
                let debounceTimer;

                input.addEventListener('input', (e) => {
                    const query = e.target.value;
                    
                    // Lift Layer logic...
                    if(wrapper) wrapper.classList.add('ezd-lift-layer');
                    if(wrapper.closest('.ui-section')) wrapper.closest('.ui-section').style.zIndex = "10000";

                    clearTimeout(debounceTimer);
                    
                    if (query.length < 3) { results.style.display = 'none'; return; }

                    debounceTimer = setTimeout(() => {
                        results.style.display = 'block';
                        results.innerHTML = `<div class="ezd-search-item" style="cursor:wait; color:#94a3b8;"><i class="fas fa-satellite-dish fa-spin"></i> Searching planet...</div>`;

                        fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.length > 0) {
                                    results.innerHTML = data.map((place, idx) => 
                                        `<div class="ezd-search-item" role="button" data-idx="${idx}">
                                            <i class="fas fa-map-marker-alt" style="color:#94a3b8;"></i> 
                                            <div style="display:flex; flex-direction:column; line-height:1.2;">
                                                <span style="font-weight:600;">${place.name || place.address.city || "Unknown"}</span>
                                                <span style="font-size:11px; opacity:0.7;">${place.display_name}</span>
                                            </div>
                                        </div>`
                                    ).join('');

                                    // --- THE FIX: Use onmousedown instead of onclick ---
                                    // Mousedown fires BEFORE the input blurs, ensuring the click registers.
                                    results.querySelectorAll('.ezd-search-item').forEach((item) => {
                                        item.onmousedown = (e) => {
                                            e.preventDefault(); // Stop focus from leaving the input immediately
                                            
                                            const idx = item.dataset.idx;
                                            const place = data[idx];
                                            const addr = place.address;

                                            input.value = place.display_name;
                                            window.EZD_UI._utils.flashInput(input, 'valid');
                                            if(typeof audio !== 'undefined') audio.play('success');

                                            // Smart Fill Logic
                                            const container = el.closest('.ui-section') || document.body;
                                            const fill = (type, val) => {
                                                const target = container.querySelector(`[data-ezd-type="input"][data-type="${type}"] input`);
                                                if(target && val) {
                                                    target.value = val;
                                                    window.EZD_UI._utils.flashInput(target, 'valid');
                                                }
                                            };

                                            fill('city', addr.city || addr.town || addr.village);
                                            fill('state', addr.state || addr.region);
                                            fill('zip', addr.postcode);
                                            fill('country', addr.country);
                                            fill('gps', `${parseFloat(place.lat).toFixed(4)}, ${parseFloat(place.lon).toFixed(4)}`);
                                            
                                            if(addr.house_number && addr.road) fill('address', `${addr.house_number} ${addr.road}`);
                                            else if (addr.road) fill('address', addr.road);

                                            results.style.display = 'none';
                                            
                                            // Reset Z-Index immediately
                                            if(wrapper) wrapper.classList.remove('ezd-lift-layer');
                                            if(wrapper && wrapper.closest('.ui-section')) wrapper.closest('.ui-section').style.zIndex = "";
                                        };
                                    });
                                } else {
                                    results.innerHTML = `<div class="ezd-search-item" style="color:#ef4444;">No locations found</div>`;
                                }
                            })
                            .catch(err => {
                                results.innerHTML = `<div class="ezd-search-item" style="color:#ef4444;">Network Error</div>`;
                            });
                    }, 500);
                });

                // Keep blur for clicking *outside*
                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        results.style.display = 'none';
                        if(wrapper) wrapper.classList.remove('ezd-lift-layer');
                        if(wrapper && wrapper.closest('.ui-section')) wrapper.closest('.ui-section').style.zIndex = "";
                    }, 200);
                });
            }
        },
        buildUnitInput: function(el) {
            var id = el.id || 'unit-' + Math.random().toString(36).substr(2,9);
            el.removeAttribute('id');
            var type = el.dataset.unitType || 'weight';
            var label = el.dataset.label || type;
            var unitMap = { weight: ['LBS','KG'], temp: ['F','C'], distance: ['MI','KM'], height: ['FT/IN','CM'] };
            var iconMap = { weight: 'fa-weight-hanging', temp: 'fa-thermometer-half', distance: 'fa-road', height: 'fa-ruler-vertical' };
            var isMetric = el.dataset.defaultMetric === 'true';
            var units = unitMap[type];
            
            el.innerHTML = '<div class="ezd-input-group"><label class="ezd-label">'+label+'</label>' +
                '<div class="ezd-input-wrapper" style="position:relative;">' +
                    '<i class="fas '+iconMap[type]+' ezd-fixed-icon"></i>' +
                    '<div class="ezd-hugging-container" style="z-index:1;">' +
                        '<span class="ezd-ghost-span"></span><span class="ezd-unit-suffix">'+(isMetric?units[1]:units[0])+'</span>' +
                    '</div>' +
                    '<input type="text" id="'+id+'" class="ezd-smart-input" style="background:transparent; z-index:2; padding-right:60px !important;">' +
                    '<button class="ezd-unit-toggle" style="z-index:3;">'+(isMetric?units[1]:units[0])+'</button>' +
                '</div></div>';
            
            var input = el.querySelector('input');
            var ghost = el.querySelector('.ezd-ghost-span');
            var suffix = el.querySelector('.ezd-unit-suffix');
            var btn = el.querySelector('.ezd-unit-toggle');
            
            var sync = function() { ghost.textContent = input.value; };
            input.addEventListener('input', sync);
            
            // --- NEW: Typing Flash ---
            input.addEventListener('input', function() {
                utils.flashInput(input, 'typing');
            });

            btn.onclick = function() {
                var oldVal = input.value;
                isMetric = !isMetric;
                var u = isMetric ? units[1] : units[0];
                if(oldVal) input.value = utils.convertUnit(oldVal, type, !isMetric);
                btn.innerText = u; suffix.innerText = u; sync();
                
                // --- NEW: Green Button Flash ---
                utils.flashInput(input, 'valid');
            };
        },


        buildSlider: (el) => {
            const id = el.id || 'slider-' + Math.random().toString(36).substr(2,9);
            el.removeAttribute('id');
            const min = parseFloat(el.dataset.min || 0);
            const max = parseFloat(el.dataset.max || 100);
            const step = parseFloat(el.dataset.step || 1);
            const unit = el.dataset.unit || '';
            const unitName = unit === '%' ? 'percent' : unit === '$' ? 'dollars' : unit; // Speakable units
            const label = el.dataset.label || 'Value';
            const isRange = el.dataset.range === 'true';
            const variant = el.dataset.color || 'primary';
            const showTicks = el.dataset.ticks === 'true';
            let rawVal = el.dataset.value || (isRange ? `${min},${max}` : `${min}`);
            let values = rawVal.toString().split(',').map(v => parseFloat(v));
            if(isRange && values.length < 2) values = [min, max];
            if(!isRange) values = [values[0]];

            el.innerHTML = `
            <div class="ezd-slider-container" data-variant="${variant}" id="wrap-${id}">
                <div class="ezd-slider-header">
                    <span class="ezd-label" id="lbl-${id}">${label}</span>
                    <div class="ezd-slider-display">
                        <input type="text" class="val-input" style="width:80px;" aria-label="${label} manual entry">
                        <span style="color:#94a3b8; font-size:12px; margin-left:2px;" aria-hidden="true">${unit}</span>
                    </div>
                </div>
                <div class="ezd-track-wrap">
                    <div class="ezd-track">
                        <div class="ezd-track-fill"></div>
                        <div class="ezd-ticks"></div>
                    </div>
                    ${values.map((v, i) => `
                        <div class="ezd-handle" tabindex="0" data-idx="${i}" 
                             role="slider" 
                             aria-labelledby="lbl-${id}"
                             aria-valuemin="${min}" aria-valuemax="${max}" 
                             aria-valuenow="${v}"
                             aria-valuetext="${v} ${unitName}">
                        </div>`).join('')}
                </div>
                <input type="hidden" id="${id}" value="${rawVal}" class="ezd-store">
            </div>`;

            const fill = el.querySelector('.ezd-track-fill');
            const handles = el.querySelectorAll('.ezd-handle');
            const hidden = el.querySelector('.ezd-store');
            const valInput = el.querySelector('.val-input');
            const track = el.querySelector('.ezd-track-wrap');

            if (showTicks && step > 0) {
                const count = Math.floor((max - min) / step);
                if (count < 50) {
                    let ticksHTML = '';
                    for (let i = 0; i <= count; i++) {
                        const pct = ((i * step) / (max - min)) * 100;
                        ticksHTML += `<div class="ezd-tick" style="left:${pct}%"></div>`;
                    }
                    el.querySelector('.ezd-ticks').innerHTML = ticksHTML;
                }
            }

            const updateUI = () => {
                const range = max - min;
                const pct = values.map(v => Math.max(0, Math.min(100, ((v - min) / range) * 100)));
                if (isRange) {
                    fill.style.left = Math.min(pct[0], pct[1]) + '%';
                    fill.style.width = Math.abs(pct[1] - pct[0]) + '%';
                    handles[0].style.left = pct[0] + '%';
                    handles[1].style.left = pct[1] + '%';
                    if (document.activeElement !== valInput) valInput.value = `${values[0]} - ${values[1]}`;
                } else {
                    fill.style.left = '0%';
                    fill.style.width = pct[0] + '%';
                    handles[0].style.left = pct[0] + '%';
                    if (document.activeElement !== valInput) valInput.value = values[0];
                }
                
                // A11Y UPDATE: Announce values live
                handles.forEach((h, i) => {
                    h.setAttribute('aria-valuenow', values[i]);
                    h.setAttribute('aria-valuetext', `${values[i]} ${unitName}`);
                });
            };

            const setVal = (newVal, handleIdx, commit) => {
                if(step > 0) newVal = Math.round(newVal / step) * step;
                newVal = Math.max(min, Math.min(max, newVal));
                newVal = parseFloat(newVal.toFixed(2));
                
                if (isRange) {
                    if (handleIdx === 0) values[0] = Math.min(newVal, values[1]);
                    else values[1] = Math.max(newVal, values[0]);
                } else {
                    values[0] = newVal;
                }
                updateUI(); 
                if (commit) {
                    hidden.value = values.join(',');
                    if (window.EZD_UI._utils) window.EZD_UI._utils.dispatchChange(hidden);
                }
            };

            // Mouse Interaction
            const onPointerDown = (e) => {
                const rect = track.getBoundingClientRect();
                const getVal = (cX) => min + (((cX - rect.left) / rect.width) * (max - min));
                const cX = e.clientX || e.touches[0].clientX;
                const clickVal = getVal(cX);
                let idx = 0;
                if (isRange) {
                    const d0 = Math.abs(values[0] - clickVal);
                    const d1 = Math.abs(values[1] - clickVal);
                    idx = d0 < d1 ? 0 : 1;
                }
                setVal(clickVal, idx, false);
                handles[idx].focus(); // A11Y: Move focus to handle so arrows work immediately

                const onMove = (mv) => {
                    mv.preventDefault();
                    const mcX = mv.clientX || mv.touches[0].clientX;
                    setVal(getVal(mcX), idx, false);
                };
                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    document.removeEventListener('touchend', onUp);
                    setVal(values[idx], idx, true);
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onUp);
                document.addEventListener('touchend', onUp);
            };

            track.addEventListener('mousedown', onPointerDown);
            track.addEventListener('touchstart', onPointerDown, { passive: false });

            // Keyboard Interaction (A11y)
            handles.forEach((h, i) => {
                h.addEventListener('keydown', (e) => {
                    let v = values[i];
                    if (['ArrowRight','ArrowUp'].includes(e.key)) v += step;
                    else if (['ArrowLeft','ArrowDown'].includes(e.key)) v -= step;
                    else if (e.key === 'Home') v = min;
                    else if (e.key === 'End') v = max;
                    else return;
                    
                    e.preventDefault();
                    setVal(v, i, true);
                });
            });

            // Input Box
            valInput.addEventListener('change', (e) => {
                const txt = e.target.value;
                if (isRange) {
                    const parts = txt.split(/[\s,-]+/).map(parseFloat).filter(n => !isNaN(n));
                    if (parts.length >= 2) {
                        const snap = (v) => (step > 0) ? Math.round(v / step) * step : v;
                        values = [Math.min(snap(parts[0]), snap(parts[1])), Math.max(snap(parts[0]), snap(parts[1]))];
                        hidden.value = values.join(',');
                        if (window.EZD_UI._utils) window.EZD_UI._utils.dispatchChange(hidden);
                        updateUI();
                        valInput.blur();
                    } else { updateUI(); }
                } else {
                    const val = parseFloat(txt);
                    if (!isNaN(val)) {
                        setVal(val, 0, true);
                        valInput.blur();
                    } else { updateUI(); }
                }
            });
            valInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') valInput.blur(); });
            
            // External Update Listener
            hidden.addEventListener('change', () => {
                const ext = hidden.value.split(',').map(parseFloat);
                if(!ext.some(isNaN) && ext.join(',') !== values.join(',')) {
                    values = ext; updateUI();
                }
            });

            updateUI();
        },
        buildSelect: (el) => {
            const id = el.id; if(!id) return;
            const listKey = el.dataset.fdsList; 
            const label = el.dataset.label || '';
            let options = [];

            // 1. Data Loading
            if(el.dataset.fdsOptions) {
                try { options = JSON.parse(el.dataset.fdsOptions); } catch(e) { options = []; }
            } 
            else if(window.EZD_STORE?.settings?.custom_lists && listKey) {
                let lists = window.EZD_STORE.settings.custom_lists;
                if (typeof lists === 'string') { try { lists = JSON.parse(lists); } catch(e) { lists = {}; } }
                
                const listData = lists[listKey] || [];
                options = listData.map(item => {
                    if (typeof item === 'string' && item.trim().startsWith('{')) { try { item = JSON.parse(item); } catch(e) {} }
                    if (typeof item === 'object' && item !== null) {
                        return item["Character Name"] || item["Name"] || item.name || item.val || item.label || item["Group Name"] || item["Role Name"];
                    }
                    return item;
                });
            }
            else if(window.FDS_CACHE?.settings?.custom_lists && listKey) {
                let lists = window.FDS_CACHE.settings.custom_lists;
                if (typeof lists === 'string') { try { lists = JSON.parse(lists); } catch(e) { lists = {}; } }
                options = (lists[listKey] || []).map(item => {
                     if (typeof item === 'object') return item["Character Name"] || item.name;
                     return item;
                });
            }

            utils.cleanZombies(id); el.removeAttribute('id');
            const lblId = `lbl-${id}`;
            
            el.innerHTML = `<div class="ezd-select-container" id="wrap-${id}">
                ${label ? `<label id="${lblId}" class="ezd-label">${label}</label>` : ''}
                <div class="ezd-select-trigger" tabindex="0" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="${lblId}">
                    <i class="fas fa-list-ul ezd-fixed-icon"></i>
                    <span class="ezd-select-text placeholder">Select...</span>
                    <i class="fas fa-chevron-down" style="font-size:10px; color:#94a3b8; margin-left:auto;"></i>
                </div>
                <input type="hidden" id="${id}" value="" class="ezd-store">
            </div>`;
            
            const menu = document.createElement('div'); 
            menu.className = 'ezd-select-menu'; 
            menu.id = 'menu-'+id; 
            menu.setAttribute('role', 'listbox');
            
            const genOptions = (filter = "") => {
                const safeFilter = String(filter).toLowerCase();
                const filtered = options.filter(o => String(o).toLowerCase().includes(safeFilter));
                if(filtered.length === 0) return '<div style="padding:15px; color:#94a3b8; text-align:center;">No results</div>';
                return filtered.map((o) => 
                    `<div class="ezd-select-option" role="option" tabindex="-1" data-val="${o}">${o}</div>`
                ).join('');
            };
            
            menu.innerHTML = `<input type="text" class="ezd-smart-input" placeholder="Search..." aria-label="Search options" style="margin:10px; width:calc(100% - 20px) !important; height:40px !important;">
                              <div class="ezd-select-options">${genOptions()}</div>`;
            el.appendChild(menu);
            
            const trigger = el.querySelector('.ezd-select-trigger'); 
            const hidden = document.getElementById(id);
            const search = menu.querySelector('input');
            const optContainer = menu.querySelector('.ezd-select-options');

            const toggle = () => {
                const visible = (menu.style.display === 'block' && !menu.classList.contains('closing'));
                if(visible) { utils.closeAllMenus(); } 
                else {
                    utils.toggleMenu(trigger, menu); 
                    trigger.setAttribute('aria-expanded', 'true');
                    setTimeout(() => search.focus(), 50); 
                    requestAnimationFrame(() => { menu.classList.add('visible'); });
                }
            };

            trigger.onclick = (e) => { e.stopPropagation(); toggle(); };
            trigger.addEventListener('keydown', (e) => { if (['Enter', ' ', 'ArrowDown'].includes(e.key)) { e.preventDefault(); toggle(); } });

            const attachOptionListeners = () => {
                const opts = menu.querySelectorAll('.ezd-select-option');
                opts.forEach((opt, i) => {
                    const doSelect = () => {
                        window.EZD_UI.setValue(id, opt.dataset.val);
                        if(typeof audio !== 'undefined') audio.play('click');
                        utils.closeAllMenus(); 
                    };
                    opt.onclick = (e) => { e.stopPropagation(); doSelect(); };
                    opt.addEventListener('keydown', (e) => {
                        if (['Enter', ' '].includes(e.key)) { e.preventDefault(); doSelect(); }
                        else if (e.key === 'ArrowDown') { e.preventDefault(); (opts[i+1] || opts[0]).focus(); }
                        else if (e.key === 'ArrowUp') { e.preventDefault(); if(i === 0) search.focus(); else opts[i-1].focus(); }
                        else if (e.key === 'Escape') toggle();
                    });
                });
            };
            attachOptionListeners();

            search.oninput = (e) => { 
                optContainer.innerHTML = genOptions(e.target.value); 
                attachOptionListeners(); 
            };
            search.addEventListener('keydown', (e) => {
                if(e.key === 'ArrowDown') { 
                    e.preventDefault(); const first = menu.querySelector('.ezd-select-option'); if(first) first.focus(); 
                } else if(e.key === 'Escape') toggle();
            });

            hidden.addEventListener('change', () => { 
                const text = el.querySelector('.ezd-select-text'); 
                text.classList.remove('liquid-enter'); void text.offsetWidth; 
                if(hidden.value) { 
                    text.innerText = hidden.value; text.classList.remove('placeholder'); 
                } else { 
                    text.innerText = "Select..."; text.classList.add('placeholder'); 
                } 
                text.classList.add('liquid-enter'); 
            });
        },
        buildMultiselect: (el) => {
            const id = el.id; if(!id) return;
            const listKey = el.dataset.fdsList; 
            const label = el.dataset.label || '';
            
            // Helper to fetch latest options (Always fresh)
            const loadOptions = () => {
                let opts = [];
                if(el.dataset.fdsOptions) {
                    try { opts = JSON.parse(el.dataset.fdsOptions); } catch(e) { opts = []; }
                } 
                else if(window.EZD_STORE?.settings?.custom_lists && listKey) {
                    let lists = window.EZD_STORE.settings.custom_lists;
                    if (typeof lists === 'string') { try { lists = JSON.parse(lists); } catch(e) { lists = {}; } }
                    opts = (lists[listKey] || []).map(item => {
                        if (typeof item === 'string' && item.trim().startsWith('{')) { try { item = JSON.parse(item); } catch(e) {} }
                        if (typeof item === 'object' && item !== null) return item["Character Name"] || item["Name"] || item.name || item.val || item.label || item["Group Name"] || item["Role Name"];
                        return item;
                    });
                }
                if(listKey === 'people' && window.EZD_STORE?.people) { 
                    opts = window.EZD_STORE.people.map(p => `${p.FirstName} ${p.LastName}`); 
                }
                return opts;
            };

            let options = loadOptions();
            
            utils.cleanZombies(id); el.removeAttribute('id');
            const lblId = `lbl-${id}`;

            // HTML Structure
            el.innerHTML = `<div class="multiselect-wrapper" id="wrap-${id}">
                ${label ? `<label id="${lblId}" class="ezd-label">${label}</label>` : ''}
                <div class="multiselect-trigger" tabindex="0" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="${lblId}">
                    <i class="fas fa-layer-group ezd-fixed-icon"></i>
                    <div class="multiselect-content"><span>Select...</span></div>
                    <i class="fas fa-chevron-down" style="font-size:10px; color:#94a3b8; margin-left:auto;"></i>
                </div>
                <input type="hidden" id="${id}" value="[]" class="ezd-store">
            </div>`;
            
            const menu = document.createElement('div'); 
            menu.className = 'multiselect-menu'; 
            menu.id = 'menu-'+id; 
            menu.setAttribute('role', 'listbox');
            
            const genOptions = (filter = "") => {
                const safeFilter = String(filter).toLowerCase();
                const filtered = options.filter(o => String(o).toLowerCase().includes(safeFilter));
                if (filtered.length === 0) return '<div style="padding:10px 15px; color:#94a3b8; font-style:italic; font-size:12px;">No results</div>';
                return filtered.map((o) => `<div class="multiselect-option" role="option" tabindex="-1" aria-selected="false" data-val="${o}">${o}</div>`).join('');
            };
            
            menu.innerHTML = `<input type="text" class="ezd-smart-input" placeholder="Search..." aria-label="Search tags" style="margin:10px; width:calc(100% - 20px) !important; height:40px !important;"><div class="multiselect-options">${genOptions()}</div>`;
            el.appendChild(menu);
            
            menu.onmousedown = (e) => e.stopPropagation();
            const search = menu.querySelector('input');
            const trigger = el.querySelector('.multiselect-trigger'); 
            const hidden = document.getElementById(id);
            const content = el.querySelector('.multiselect-content');
            const optContainer = menu.querySelector('.multiselect-options');

            const syncVisuals = () => {
                const selected = JSON.parse(hidden.value || "[]");
                menu.querySelectorAll('.multiselect-option').forEach(opt => {
                    const isSelected = selected.includes(opt.dataset.val);
                    opt.classList.toggle('selected', isSelected);
                    opt.setAttribute('aria-selected', isSelected);
                });
            };

            const attachOptionListeners = () => {
                const allOpts = Array.from(menu.querySelectorAll('.multiselect-option'));
                allOpts.forEach((opt, i) => {
                    const doSelect = () => {
                        const val = opt.dataset.val; 
                        let current = [];
                        try { current = JSON.parse(hidden.value || "[]"); } catch(err) { current = []; }
                        if (current.includes(val)) current = current.filter(x => x !== val); else current.push(val); 
                        window.EZD_UI.setValue(id, current); 
                        if(typeof audio !== 'undefined') audio.play('click');
                        syncVisuals();
                        opt.focus();
                    };
                    opt.onclick = (e) => { e.stopPropagation(); doSelect(); };
                    opt.addEventListener('keydown', (e) => {
                        if(['Enter',' '].includes(e.key)) { e.preventDefault(); doSelect(); }
                        else if (e.key === 'ArrowDown') { e.preventDefault(); (allOpts[i+1] || allOpts[0]).focus(); }
                        else if (e.key === 'ArrowUp') { e.preventDefault(); if(i===0) search.focus(); else allOpts[i-1].focus(); }
                        else if (e.key === 'Escape') toggle();
                    });
                });
            };

            search.oninput = (e) => { optContainer.innerHTML = genOptions(e.target.value); attachOptionListeners(); };
            search.addEventListener('keydown', (e) => {
                if(e.key === 'ArrowDown') { e.preventDefault(); const first = menu.querySelector('.multiselect-option'); if(first) first.focus(); }
                else if(e.key === 'Enter') { e.preventDefault(); const first = menu.querySelector('.multiselect-option'); if(first) first.click(); }
                else if(e.key === 'Escape') toggle();
            });

            const toggle = () => {
                const visible = (menu.style.display === 'block' && !menu.classList.contains('closing'));
                if(visible) { 
                    utils.closeAllMenus(); 
                    setTimeout(() => { search.value = ""; }, 200); // Clear search on close
                } 
                else {
                    if(options.length === 0) options = loadOptions();

                    // AUTO-SORT SELECTED TO TOP
                    const currentSelected = JSON.parse(hidden.value || "[]");
                    if (currentSelected.length > 0) {
                        options.sort((a, b) => {
                            const aSel = currentSelected.includes(a);
                            const bSel = currentSelected.includes(b);
                            if (aSel && !bSel) return -1; 
                            if (!aSel && bSel) return 1;  
                            return String(a).localeCompare(String(b)); 
                        });
                    }
                    
                    optContainer.innerHTML = genOptions(); 
                    attachOptionListeners();
                    syncVisuals();

                    utils.toggleMenu(trigger, menu); 
                    trigger.setAttribute('aria-expanded', 'true');
                    setTimeout(() => search.focus(), 50); 
                    requestAnimationFrame(() => { menu.classList.add('visible'); });
                }
            };
            trigger.onclick = (e) => { e.stopPropagation(); toggle(); };
            trigger.addEventListener('keydown', (e) => { if(['Enter',' ','ArrowDown'].includes(e.key)) { e.preventDefault(); toggle(); } });

            // --- TAG RENDERER (With Resurrection Logic) ---
            const renderTags = () => {
                let selected = [];
                try { selected = JSON.parse(hidden.value || "[]"); } catch(e) {}
                
                trigger.title = selected.length > 0 ? selected.join(', ') : "Select options...";
                const currentTags = Array.from(content.querySelectorAll('.selected-tag:not(.exiting)'));
                
                const span = content.querySelector('span');
                if(selected.length > 0 && span) span.remove();
                if(selected.length === 0 && !span && !content.querySelector('.exiting')) {
                     if(content.children.length === 0) content.innerHTML = '<span>Select...</span>'; 
                }

                // REMOVE
                currentTags.forEach(tag => {
                    if (!selected.includes(tag.dataset.val)) {
                        tag.classList.add('exiting'); 
                        // Attach timer to element so we can cancel it if needed
                        tag._deathTimer = setTimeout(() => tag.remove(), 340); 
                    }
                });

                // ADD (With Resurrection)
                selected.forEach(val => {
                    // Check for Dying Tag first
                    const dyingTag = content.querySelector(`.selected-tag.exiting[data-val="${val}"]`);
                    
                    if (dyingTag) {
                        // RESURRECT!
                        dyingTag.classList.remove('exiting');
                        clearTimeout(dyingTag._deathTimer);
                    } 
                    else if (!content.querySelector(`.selected-tag[data-val="${val}"]`)) {
                        // CREATE NEW
                        const div = createTag(val);
                        div.classList.add('entering'); 
                        content.appendChild(div);
                    }
                });
                
                if(menu.style.display === 'block') syncVisuals();
            };

            // --- STABILIZER ---
            let stableCount = 0;
            const stabilize = setInterval(() => {
                if(options.length === 0) {
                     options = loadOptions();
                     if(options.length > 0 && menu.style.display === 'block') {
                         optContainer.innerHTML = genOptions();
                         attachOptionListeners();
                     }
                }
                renderTags();
                stableCount++;
                if(stableCount > 30) clearInterval(stabilize); 
            }, 100);

            hidden.addEventListener('change', renderTags);
            renderTags();

            function createTag(val) {
                const div = document.createElement('div');
                div.className = 'selected-tag';
                div.dataset.val = val;
                div.innerHTML = `${val}<i class="fas fa-times tag-remove"></i>`;
                div.querySelector('.tag-remove').onclick = (e) => {
                    e.stopPropagation();
                    const fresh = JSON.parse(hidden.value).filter(x => x !== val);
                    window.EZD_UI.setValue(id, fresh);
                };
                return div;
            }
        },
        buildColorPicker: (el) => {
            const id = el.id; el.removeAttribute('id'); 
            const label = el.dataset.label || 'Avatar Color';
            const colors = ['#8B0000', '#D946EF', '#3B82F6', '#10B981', '#F59E0B', '#6366F1', '#EC4899', '#14B8A6', '#F43F5E', '#64748B'];
            const initial = el.dataset.value || colors[0];
            
            el.innerHTML = `
                <div class="ezd-input-group">
                    <label class="ezd-label">${label}</label>
                    <div class="ezd-color-picker-wrapper" role="radiogroup" aria-label="${label}">
                        ${colors.map(c => `
                            <div class="color-dot" tabindex="0" role="radio" aria-checked="false" aria-label="Color ${c}" 
                                 data-color="${c}" style="background:${c};" title="${c}">
                            </div>`).join('')}
                        
                        <div class="color-dot custom-trigger" tabindex="0" role="button" aria-label="Custom Color Picker"
                             style="background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border:1px solid #cbd5e1;" title="Custom Color">
                            <input type="color" class="ezd-hidden-picker" style="opacity:0; width:100%; height:100%; cursor:pointer;" tabindex="-1">
                        </div>
                    </div>
                    <input type="hidden" id="${id}" value="${initial}" class="ezd-store">
                </div>`;
                
            const hidden = el.querySelector('.ezd-store');
            const picker = el.querySelector('.ezd-hidden-picker');
            const customDot = el.querySelector('.custom-trigger');
            
            const selectColor = (val, isCustom = false) => {
                hidden.value = val;
                window.EZD_UI._utils.dispatchChange(hidden);
                
                requestAnimationFrame(() => {
                    el.querySelectorAll('.color-dot').forEach(d => {
                        d.classList.remove('active');
                        d.setAttribute('aria-checked', 'false');
                        d.style.borderColor = 'transparent';
                    });

                    if (isCustom) {
                        customDot.classList.add('active');
                        customDot.style.borderColor = '#cbd5e1';
                    } else {
                        const match = el.querySelector(`.color-dot[data-color="${val}"]`);
                        if(match) {
                            match.classList.add('active');
                            match.setAttribute('aria-checked', 'true');
                            match.style.borderColor = '#cbd5e1';
                        }
                    }
                });
            };

            // 1. Handle Presets (Click + Enter)
            el.querySelectorAll('.color-dot:not(.custom-trigger)').forEach(d => {
                d.onclick = () => selectColor(d.dataset.color);
                d.onkeydown = (e) => {
                    if(e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault(); selectColor(d.dataset.color);
                    }
                };
            });

            // 2. Handle Custom Wheel (Click + Enter to trigger hidden input)
            customDot.onclick = () => picker.click();
            customDot.onkeydown = (e) => {
                if(e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault(); picker.click();
                }
            };
            
            picker.oninput = (e) => selectColor(e.target.value, true);

            // Initial State
            selectColor(initial, !colors.includes(initial));
        },
        buildSaveButton: (el) => {
            const id = el.id || 'save-' + Math.random().toString(36).substr(2,9);
            const label = el.dataset.label || "Save Changes";
            
            // 1. Capture the original onclick BEFORE we clear the innerHTML
            const originalOnClick = el.onclick;

            // 2. Create the internal button
            el.innerHTML = `<button id="${id}" class="ezd-save-btn idle" data-original-label="${label}">
                                <i class="fas fa-save"></i> ${label}
                            </button>`;
            
            // Remove ID from wrapper to prevent duplicate ID issues
            el.removeAttribute('id'); 
            
            const btn = el.querySelector('button');
            
            // 3. Robust Event Forwarding
            if (originalOnClick) {
                btn.onclick = function(e) {
                    e.stopPropagation();
                    if(typeof audio !== 'undefined') audio.play('click');
                    originalOnClick.call(this, e);
                };
                el.onclick = null;
            }

            // --- 4. THE AUTOMATIC FORM WATCHER (Your Idea) ---
            // Find the closest modal, form, or section this button belongs to
            const container = el.closest('.ezd-dialog-box, .ui-section, form') || document.body;
            
            const markDirty = (e) => {
                // Ignore if they are clicking the save button itself
                if (e.target.closest('.ezd-save-btn')) return;
                
                // Only react to actual data inputs
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'SELECT') return;
                
                window.EZD_UI.setButtonState(id, 'dirty');
            };

            // Listen for any typing or UI component changes within this specific form
            container.addEventListener('input', markDirty);
            container.addEventListener('change', markDirty);
        },
        buildNotificationTester: (el) => {
            el.innerHTML = `
                <div class="ezd-input-group">
                    <label class="ezd-label">System Checks</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="ezd-btn-test success" style="background:#10b981; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer; flex:1;">
                            <i class="fas fa-bell"></i> Notify
                        </button>
                        <button class="ezd-btn-test modal-danger" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer; flex:1;">
                            <i class="fas fa-trash"></i> Delete?
                        </button>
                        <button class="ezd-btn-test module-trigger" style="background:#6366f1; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer; flex:1;">
                            <i class="fas fa-database"></i> Test Module Data
                        </button>
                    </div>
                </div>
            `;

            // 1. Standard Tests
            el.querySelector('.success').onclick = () => window.EZD_UI.notify('success', 'Changes Saved', 'Your configuration has been updated.');
            
            el.querySelector('.modal-danger').onclick = async () => {
                const confirmed = await window.EZD_UI.confirm({
                    type: 'danger', title: 'Delete Database?', message: 'This will permanently delete all records.', confirmText: 'Yes, Delete'
                });
                if(confirmed) window.EZD_UI.notify('error', 'Deleted', 'Database wiped.');
            };

            // 2. THE PROOF: Consuming "FDS_MODULE_DATA"
            el.querySelector('.module-trigger').onclick = async () => {
                // Fetch data from the "Module" (Global Variable)
                const data = window.FDS_MODULE_DATA.modalScenarios;
                
                // Pick a random config from the module
                const config = data[Math.floor(Math.random() * data.length)];
                
                console.log(" Loading Module Config:", config); // Proof in console

                // Pass the raw module object to the library
                const result = await window.EZD_UI.confirm(config);

                if(result) window.EZD_UI.notify('success', 'Module Accepted', `You clicked: ${config.confirmText}`);
                else window.EZD_UI.notify('info', 'Module Rejected', 'Action cancelled.');
            };
        },
        buildSearch: (el) => {
            const id = el.id;
            el.innerHTML = `<div class="ezd-input-group" style="margin-bottom:0;"><div style="position:relative;"><i class="fas fa-search ezd-fixed-icon"></i><input type="text" id="${id}-input" class="ezd-smart-input" placeholder="${el.dataset.placeholder||'Search...'}" style="padding-left:42px !important;"></div></div><input type="hidden" id="${id}" value="" class="ezd-store">`;
            el.querySelector('input').oninput = (e) => { document.getElementById(id).value = e.target.value; el.dispatchEvent(new Event('change')); };
        }
    };

    // =========================================
    // --- AUDIO ENGINE v9 (Ultra-Soft & Uniform) ---
    const audio = {
        ctx: null,
        enabled: true,
        processLoop: null,

        init: function() {
            if (!this.ctx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if(AudioContext) this.ctx = new AudioContext({ latencyHint: 'interactive' });
            }
        },
        
        toggle: function(state) {
            this.enabled = (state !== undefined) ? state : !this.enabled;
            return this.enabled;
        },

        startProcess: function() {
            if(!this.enabled || this.processLoop) return;
            const that = this;
            this.processLoop = setInterval(() => { that.play('tick'); }, 150);
        },

        stopProcess: function(success) {
            if(this.processLoop) { clearInterval(this.processLoop); this.processLoop = null; }
            if(success && this.enabled) this.play('success');
        },

        play: function(type) {
            if (!this.enabled) return; 
            if (!this.ctx) this.init();
            if (this.ctx.state === 'suspended') return;

            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            // --- MASTER VOLUME (Global Limit) ---
            // Dropped from 0.2 to 0.05 (Very Soft)
            const VOL = 0.05; 

            osc.connect(gain);
            gain.connect(this.ctx.destination);
            gain.gain.setValueAtTime(0, t);

            // 1. UNIFIED CLICK (Used for Buttons, Modals, Edits)
            // This forces "Add Person" (Open) and "Edit" (Click) to sound IDENTICAL.
            if (type === 'click' || type === 'grab' || type === 'open') {
                osc.type = 'triangle'; // The "Thud" wave you liked
                
                // Low Pitch Drop (150Hz -> 50Hz)
                // This gives it that physical "keyboard switch" feel
                osc.frequency.setValueAtTime(150, t); 
                osc.frequency.exponentialRampToValueAtTime(50, t + 0.1); 

                // Soft Envelope
                gain.gain.linearRampToValueAtTime(VOL, t + 0.01); 
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                
                osc.start(t); osc.stop(t + 0.1);
            }
            
            // 2. TOGGLES (Slightly Higher to indicate state change)
            else if (type === 'toggleOn' || type === 'toggleOff') {
                osc.type = 'sine'; // Sine is smoother/quieter than triangle
                
                const freq = (type === 'toggleOn') ? 250 : 200;
                osc.frequency.setValueAtTime(freq, t);
                
                gain.gain.linearRampToValueAtTime(VOL, t + 0.02);
                gain.gain.linearRampToValueAtTime(0.001, t + 0.15);
                
                osc.start(t); osc.stop(t + 0.15);
            }
            
            // 3. UPLOAD TICK (The Data Bubble)
            else if (type === 'tick') { 
                osc.type = 'sine'; 
                // Random pitch 200-300Hz (Lowered to be less piercing)
                const flow = 200 + (Math.random() * 100); 
                osc.frequency.setValueAtTime(flow, t);
                
                gain.gain.linearRampToValueAtTime(VOL * 0.8, t + 0.02); // Even quieter
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                
                osc.start(t); osc.stop(t + 0.1);
            }
            
            // 4. SUCCESS / DELETE / ERROR
            else { 
                osc.type = 'sine';
                
                let startF = 300, endF = 600, dur = 0.3;
                if(type === 'delete') { startF = 150; endF = 50; } // Drop
                if(type === 'error')  { startF = 100; endF = 50; } // Low Drop
                
                osc.frequency.setValueAtTime(startF, t);
                osc.frequency.exponentialRampToValueAtTime(endF, t + dur);
                
                gain.gain.linearRampToValueAtTime(VOL, t + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, t + dur);
                
                osc.start(t); osc.stop(t + dur);
            }
        }
    };
    // =========================================
    return {
      // --- 6. NEWTONIAN NOTIFICATIONS (A11y Edition) ---
        notify: function(typeOrConfig, title, message, duration = 4000) {
            // 1. Ensure Container with Live Region
            let container = document.querySelector('.ezd-toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'ezd-toast-container';
                // "polite" means: Finish reading what you are reading, then read this.
                // "assertive" would interrupt. Polite is usually better for stacking.
                container.setAttribute('aria-live', 'polite'); 
                container.setAttribute('role', 'region');
                container.setAttribute('aria-label', 'Notifications');
                document.body.appendChild(container);
            }

            // 2. Resolve Config
            let config = {};
            if (typeof typeOrConfig === 'string') {
                const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle', warning: 'fa-exclamation-triangle' };
                config.type = typeOrConfig; config.title = title; config.message = message; config.icon = icons[typeOrConfig] || 'fa-bell';
            } else {
                config = typeOrConfig; config.type = 'custom';
                if(!config.icon) config.icon = 'fa-bell';
                if(!config.duration) config.duration = duration;
            }

            // 3. Build Toast
            const toast = document.createElement('div');
            toast.className = `ezd-toast ${config.type}`;
            // Important: Individual errors get 'alert' role for higher priority
            if(config.type === 'error') toast.setAttribute('role', 'alert'); 
            
            if (config.color) toast.style.borderLeftColor = config.color;

            toast.innerHTML = `
                <div class="ezd-toast-content">
                    <i class="fas ${config.icon} ezd-toast-icon" style="${config.color ? 'color:'+config.color : ''}" aria-hidden="true"></i>
                    <div class="ezd-toast-text">
                        <div class="ezd-toast-title">${config.title}</div>
                        <div class="ezd-toast-msg">${config.message}</div>
                    </div>
                </div>
                <div class="ezd-toast-close" role="button" aria-label="Close notification"><i class="fas fa-times"></i></div>
                <div class="ezd-toast-progress"></div>
            `;

            // 4. Inject
            container.insertBefore(toast, container.firstChild);

            // 5. Sound
            if(config.type === 'success') audio.play('success');
            else if(config.type === 'error') audio.play('error');
            else audio.play('open');

            // 6. Animation (Entry)
            toast.animate([{ opacity: 0, transform: 'translateY(-20px) scale(0.9)' }, { opacity: 1, transform: 'translateY(0) scale(1)' }], { duration: 400, easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' });

            // 7. Timer & Exit Logic
            const progress = toast.querySelector('.ezd-toast-progress');
            progress.style.color = config.color || getComputedStyle(toast).borderLeftColor;
            const timerAnim = progress.animate([{ transform: 'scaleX(1)' }, { transform: 'scaleX(0)' }], { duration: config.duration || duration, easing: 'linear' });

            toast.onmouseenter = () => timerAnim.pause();
            toast.onmouseleave = () => timerAnim.play();

            const close = (e) => {
                if(e) e.stopPropagation();
                if(toast.classList.contains('closing')) return;
                toast.classList.add('closing');
                const exit = toast.animate([{ opacity: 1, transform: 'translateX(0)', maxHeight: toast.offsetHeight + 'px', marginBottom: '10px' }, { opacity: 0, transform: 'translateX(50px)', maxHeight: '0px', marginBottom: '0px' }], { duration: 300, easing: 'ease-in' });
                exit.onfinish = () => toast.remove();
            };

            timerAnim.onfinish = close;
            toast.querySelector('.ezd-toast-close').onclick = close;
            toast.onclick = close; 
            toast.style.cursor = 'pointer';
        },
        // --- 7. PROMISE MODAL (Isolation & Focus Fix) ---
        confirm: function(config) {
            return new Promise((resolve) => {
                // 1. Capture Previous Focus
                const lastFocus = document.activeElement;

                // 2. Configuration
                const settings = Object.assign({
                    type: 'danger', title: 'Are you sure?', message: 'This action cannot be undone.',
                    confirmText: 'Confirm', cancelText: 'Cancel', hasCancel: true 
                }, config);

                const icons = { danger: 'fa-exclamation-triangle', warning: 'fa-exclamation-circle', info: 'fa-info' };

                // 3. Create Overlay
                const overlay = document.createElement('div');
                overlay.className = 'ezd-modal-overlay';
                overlay.setAttribute('role', 'alertdialog');
                overlay.setAttribute('aria-modal', 'true');
                overlay.setAttribute('aria-labelledby', 'ezd-modal-title');
                overlay.setAttribute('aria-describedby', 'ezd-modal-desc');
                
                const cancelBtnHTML = settings.hasCancel ? `<button class="ezd-btn-cancel" style="height:36px;">${settings.cancelText}</button>` : '';
                const confirmColor = settings.type === 'danger' ? '#ef4444' : '#3b82f6';

                overlay.innerHTML = `
                    <div class="ezd-modal-box">
                        <div class="ezd-modal-header">
                            <div class="ezd-modal-icon ${settings.type}"><i class="fas ${icons[settings.type]}" aria-hidden="true"></i></div>
                            <div class="ezd-modal-title" id="ezd-modal-title" tabindex="-1" style="outline:none;">${settings.title}</div>
                        </div>
                        <div class="ezd-modal-body" id="ezd-modal-desc">${settings.message}</div>
                        <div class="ezd-modal-footer">
                            ${cancelBtnHTML}
                            <button class="ezd-btn-confirm" style="height:36px; background:${confirmColor};">${settings.confirmText}</button>
                        </div>
                    </div>`;
                
                // 4. ISOLATION PROTOCOL (The Fix for "Reading Everything")
                // We hide everything else in the body from screen readers
                const siblings = Array.from(document.body.children);
                siblings.forEach(el => {
                    if (el !== overlay && el.tagName !== 'SCRIPT' && el.tagName !== 'STYLE') {
                        el.setAttribute('aria-hidden', 'true');
                        el.dataset.wasHidden = 'true'; // Mark it so we know to restore it
                    }
                });

                document.body.appendChild(overlay);

                // 5. Animation
                overlay.style.display = 'flex';
                const box = overlay.querySelector('.ezd-modal-box');
                overlay.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 200, fill: 'forwards' });
                box.animate([{ opacity: 0, transform: 'scale(0.9) translateY(20px)' }, { opacity: 1, transform: 'scale(1) translateY(0)' }], { duration: 300, easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' });

                if(settings.type === 'danger') audio.play('error'); else audio.play('open');

                // 6. Focus the TITLE (Not the button)
                // This makes the VoiceOver read "Delete Database?" immediately, then stop.
                const titleEl = overlay.querySelector('#ezd-modal-title');
                if(titleEl) titleEl.focus();

                // 7. Handlers
                const close = (result) => {
                    audio.play('click');
                    document.removeEventListener('keydown', keyHandler);
                    
                    const fade = overlay.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 200, fill: 'forwards' });
                    box.animate([{ transform: 'scale(1)' }, { transform: 'scale(0.9) translateY(10px)' }], { duration: 200 });

                    fade.onfinish = () => {
                        overlay.remove();
                        
                        // RESTORE ISOLATION
                        // Unhide everything we hid
                        siblings.forEach(el => {
                            if (el.dataset.wasHidden) {
                                el.removeAttribute('aria-hidden');
                                delete el.dataset.wasHidden;
                            }
                        });

                        if(lastFocus) lastFocus.focus();
                        resolve(result); 
                    };
                };

                const confirmBtn = overlay.querySelector('.ezd-btn-confirm');
                const cancelBtn = overlay.querySelector('.ezd-btn-cancel');

                const keyHandler = (e) => {
                    if (e.key === 'Escape' && settings.hasCancel) {
                        e.preventDefault(); close(false);
                    }
                    else if (e.key === 'Tab') {
                        // Focus Trap
                        const focusable = overlay.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
                        const first = focusable[0];
                        const last = focusable[focusable.length - 1];

                        if (e.shiftKey) { 
                            if (document.activeElement === first) { e.preventDefault(); last.focus(); }
                        } else { 
                            if (document.activeElement === last) { e.preventDefault(); first.focus(); }
                        }
                    }
                };
                document.addEventListener('keydown', keyHandler);

                confirmBtn.onclick = () => close(true);
                if (settings.hasCancel) {
                    cancelBtn.onclick = () => close(false);
                    overlay.onclick = (e) => { if(e.target === overlay) close(false); };
                }
            });
        },
      configure: function(settings) {
        Object.assign(CONFIG, settings);
        console.log(" System Configured:", CONFIG);
    },
    toggleSound: function() { return audio.toggle(); },
      // 1. SET THEME (Runs when you pick a color)
        setTheme: function(hexColor) {
            const root = document.documentElement;
            // Set the main "Brand Color" (Used for Buttons/Borders)
            root.style.setProperty('--ezd-primary', hexColor);
            
            // Calculate faint background (Light Mode)
            const rgba = this._utils.hexToRgba(hexColor, 0.1); 
            root.style.setProperty('--ezd-primary-light', rgba);
            
            // Calculate button text (Black vs White)
            const contrast = this._utils.getContrastColor(hexColor);
            root.style.setProperty('--ezd-contrast-text', contrast);

            // --- SMART TEXT CALCULATION ---
            // If Dark Mode is active, make the text 40% brighter than the brand color
            if (document.body.classList.contains('ezd-dark-mode')) {
                // Ensure lightenColor exists, if not fallback to hex
                const bright = this._utils.lightenColor ? this._utils.lightenColor(hexColor, 40) : hexColor;
                root.style.setProperty('--ezd-primary-text', bright);
            } else {
                // Light Mode: Text matches brand color exactly
                root.style.setProperty('--ezd-primary-text', hexColor);
            }
            
            console.log(` Theme: ${hexColor}`);
        },

        // 2. TOGGLE DARK MODE (Runs when you click Moon icon)
        toggleDarkMode: function(isDark) {
            const root = document.documentElement;
            // Grab the current Brand Color
            const baseColor = getComputedStyle(root).getPropertyValue('--ezd-primary').trim();

            if (isDark) {
                document.body.classList.add('ezd-dark-mode');
                // Set Dark Backgrounds
                root.style.setProperty('--ezd-bg', '#0f172a');      
                root.style.setProperty('--ezd-text', '#f1f5f9');    
                root.style.setProperty('--ezd-text-light', '#94a3b8'); 
                root.style.setProperty('--ezd-border', '#334155');
                
                // LIGHTEN THE TEXT (Luminosity Shift)
                const bright = this._utils.lightenColor ? this._utils.lightenColor(baseColor, 40) : baseColor;
                root.style.setProperty('--ezd-primary-text', bright);

            } else {
                document.body.classList.remove('ezd-dark-mode');
                // Set Light Backgrounds
                root.style.setProperty('--ezd-bg', '#ffffff');
                root.style.setProperty('--ezd-text', '#334155');
                root.style.setProperty('--ezd-text-light', '#64748b');
                root.style.setProperty('--ezd-border', '#e2e8f0');
                
                // RESET TEXT (Brand Match)
                root.style.setProperty('--ezd-primary-text', baseColor);
            }
        },
        _utils: utils,

        // Add this to your 'return' block
    register: function(name, builderFn) {
        // Automatically prefix with 'build' if missing, for internal consistency
        const key = name.startsWith('build') ? name : 'build' + name.charAt(0).toUpperCase() + name.slice(1);
        builders[key] = builderFn;
        console.log(` Plugin Loaded: ${name}`);
    },

    init: function(container) {
            const root = container || document;
            
            // 1. Audio Warmup (Resume Context on first interaction)
            const enableAudio = () => { 
                if(audio.ctx) audio.ctx.resume();
                else audio.init();
                // Remove listeners once unlocked
                document.removeEventListener('click', enableAudio); 
                document.removeEventListener('keydown', enableAudio); 
                document.removeEventListener('touchstart', enableAudio); 
            };
            
            document.addEventListener('click', enableAudio);
            document.addEventListener('keydown', enableAudio);
            document.addEventListener('touchstart', enableAudio);
            
            // 0. Change Logger (Restored)
            root.querySelectorAll('.ezd-smart-input, .ezd-store').forEach(function(el) {
                el.addEventListener('change', function(e) {
                    if (window.UIViewer && UIViewer.log) {
                        var id = e.target.id || "unknown";
                        UIViewer.log("Change [" + id + "]: " + e.target.value);
                    }
                });
            });

            // 2. MASTER INTERACTION LISTENER
            root.addEventListener('mousedown', (e) => {
                const target = e.target;

                // A. TOGGLES (Exclusive Logic - High/Low Pitch)
                const toggle = target.closest('.ezd-toggle-wrapper');
                if (toggle) {
                    // Mousedown happens BEFORE the class changes. 
                    // So if it currently has 'active', we are turning it OFF.
                    if(toggle.classList.contains('active')) audio.play('toggleOff');
                    else audio.play('toggleOn');
                    return; // Stop here. Don't play generic click.
                }

                // B. SLIDERS (Grab Sound)
                if (target.closest('.ezd-handle')) {
                    audio.play('grab');
                    return;
                }

                // C. DESTRUCTIVE
                if (target.closest('.ezd-icon-btn.delete, .ezd-file-remove, .ezd-btn-confirm')) {
                    audio.play('delete');
                    return;
                }

                // D. OPENING
                if (target.closest('.ezd-select-trigger, .multiselect-trigger, .ezd-accordion-header')) {
                    audio.play('open');
                    return;
                }

                // Catches: Standard buttons, Tabs, Options, Icons, and your new Haptic Buttons
                if (target.closest('button, .ezd-btn, .ezd-tab-btn, .color-dot, .ezd-select-option, .multiselect-option, .ezd-icon-btn, .ezd-add-btn-large')) {
                    audio.play('click');
                }
            }, true);

            // 1. Core: List Managers
            root.querySelectorAll('[data-ezd-type="list"]').forEach(el => {
                if(el.classList.contains('ezd-list-manager')) return;
                var config = { id: el.id, label: el.dataset.label, columns: el.dataset.columns ? el.dataset.columns.split(',') : null, value: el.dataset.value };
                el.parentNode.replaceChild(this.buildListManager(config), el);
            });

            // 2. Standard Builders
            const types = ['input', 'select', 'multiselect', 'slider', 'unit-input', 'phone', 'color-picker', 'save-button', 'search', 'segmented', 'tabs', 'toggle', 'file-upload', 'accordion', 'notification-tester', 'drum-date', 'drum-time', 'drum-date-range', 'drum-time-range', 'button'];
            types.forEach(type => {
                const fnName = 'build' + (type === 'input' ? 'SmartInput' : type.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(''));
                if(builders[fnName]) {
                    root.querySelectorAll(`[data-ezd-type="${type}"]`).forEach(el => {
                        if(!el.dataset.fdsReady) { builders[fnName](el); el.dataset.fdsReady = "true"; }
                    });
                }
            });
        },

    help: function() {
        console.group(" FDS UI Library Manual");
        console.table([
            { Type: 'input', Attrs: 'data-label, data-type (email/phone/etc), data-icon' },
            { Type: 'select', Attrs: 'data-ezd-options (JSON array), data-ezd-list (key)' },
            { Type: 'file-upload', Attrs: 'data-max-kb (default 500), data-label' },
            { Type: 'list', Attrs: 'data-columns (comma sep), data-placeholder' },
            { Type: 'slider', Attrs: 'data-min, data-max, data-step, data-range="true"' }
        ]);
        console.log(" Tip: Use EZD_UI.setTheme('#hex') to rebrand.");
        console.groupEnd();
    },

        // 2. THE LIST MANAGER (v26 - With Empty State & Auto-Fill Fix)
        buildListManager: function(config) {
            var wrapper = document.createElement('div');
            wrapper.className = 'ezd-list-manager';

            // Add this after wrapper.className = 'ezd-list-manager';
if(config.label) wrapper.setAttribute('aria-labelledby', `title-${originalID}`);
wrapper.setAttribute('role', 'region'); // Tells reader "This is a region"
            
            var originalID = config.id || 'list_' + new Date().getTime();
            wrapper.id = 'wrap_' + originalID;

            // --- THE FIX: TRIM SPACES FROM COLUMNS ---
            var rawCols = config.columns || ['Value'];
            var cols = rawCols.map(function(c) { return c.trim(); }); // <--- Trims " Device ID" to "Device ID"
            
            wrapper.style.setProperty('--col-count', cols.length);

            // Hidden Store
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = originalID; 
            hiddenInput.className = 'ezd-list-input ezd-store';
            hiddenInput.value = '[]';
            wrapper.appendChild(hiddenInput);

            // SEARCH TOOLBAR
            var toolbar = document.createElement('div');
            toolbar.className = 'ezd-list-toolbar';
            
            // Check if label exists, if so, add it
            var titleHTML = config.label ? `<div class="ezd-list-title" id="title-${originalID}">${config.label}</div>` : '';

            toolbar.innerHTML = `
                ${titleHTML}
                <div class="ezd-list-search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" class="ezd-list-search-input" placeholder="Search...">
                </div>
            `;
            
            var searchInp = toolbar.querySelector('input');
            searchInp.addEventListener('input', function(e) {
                var term = e.target.value.toLowerCase();
                var rows = listContainer.querySelectorAll('.ezd-list-item');
                rows.forEach(function(row) {
                    var text = "";
                    row.querySelectorAll('input').forEach(function(i) { text += i.value.toLowerCase() + " "; });
                    row.style.display = text.includes(term) ? 'grid' : 'none';
                });
            });
            wrapper.appendChild(toolbar);

            // HEADER
            var headerRow = document.createElement('div');
            headerRow.className = 'ezd-list-header-row ezd-grid-layout-data';
            cols.forEach(function(name) {
                var h = document.createElement('div');
                h.className = 'ezd-col-header';
                h.innerText = name;
                headerRow.appendChild(h);
            });
            headerRow.appendChild(document.createElement('div')); 
            wrapper.appendChild(headerRow);

            // BODY
            var listContainer = document.createElement('div');
            listContainer.className = 'ezd-list-items';
            listContainer.style.maxHeight = '400px'; 
            listContainer.style.overflowY = 'auto';
            wrapper.appendChild(listContainer);

            // --- EMPTY STATE LOGIC (NEW) ---
            var emptyState = document.createElement('div');
            emptyState.className = 'ezd-empty-state';
            emptyState.innerText = "No entries yet";
            listContainer.appendChild(emptyState);
            
            function toggleEmptyState() {
                // Check if there are visible rows
                var hasRows = listContainer.querySelectorAll('.ezd-list-item:not(.deleting)').length > 0;
                emptyState.style.display = hasRows ? 'none' : 'block';
            }
            // -------------------------------

            // FOOTER
            var addSection = document.createElement('div');
            addSection.className = 'ezd-add-section';
            var addGrid = document.createElement('div');
            addGrid.className = 'ezd-add-grid ezd-grid-layout-footer';
            var addInputs = [];
            // Find this loop:
cols.forEach(function(colName) {
    var input = document.createElement('input');
    input.placeholder = colName; 

    // REPLACE the event listener line with this:
    input.addEventListener('keydown', function(e) { 
        if (e.key === 'Enter') { 
            handleAdd(); 
            audio.play('click'); // <--- ADDED SOUND
        } 
    });

    addGrid.appendChild(input);
    addInputs.push(input);
});
            addGrid.appendChild(document.createElement('div')); 
            addSection.appendChild(addGrid);
            // Find the addBtn definition:
var addBtn = document.createElement('button');
addBtn.className = 'ezd-add-btn-large';
addBtn.innerHTML = `<i class="fas fa-plus"></i> Add Entry`;

addSection.appendChild(addBtn);
            addBtn.className = 'ezd-add-btn-large';
            addBtn.innerHTML = `<i class="fas fa-plus"></i> Add Entry`;
            // Ensure sound plays, then add
            addBtn.onclick = (e) => { 
                audio.play('click'); 
                handleAdd(); 
            };
            addSection.appendChild(addBtn);
            wrapper.appendChild(addSection);

            // AUTO-FILL LISTENER (NEW)
            hiddenInput.addEventListener('change', function(e) {
                if(e.detail && e.detail.internal) return; // Ignore internal updates
                
                var newData = [];
                try { newData = JSON.parse(hiddenInput.value); } catch(err) { return; }
                
                // Clear existing items
                var oldItems = listContainer.querySelectorAll('.ezd-list-item');
                oldItems.forEach(i => i.remove());

                if(Array.isArray(newData)) {
                    // Reverse loop to keep order correct (since we usually insertBefore)
                    // Or actually, standard loop + insertBefore works to put them at top stack
                    // But usually for loading data, we want top-down. 
                    // Let's just use standard renderRow which puts at top.
                    // If you want precise order, we should loop backwards.
                    for (var i = newData.length - 1; i >= 0; i--) {
                        var item = newData[i];
                        if(typeof item !== 'object') { var obj = {}; obj[cols[0]] = item; renderRow(obj); } 
                        else { renderRow(item); }
                    }
                }
                toggleEmptyState();
            });

            function handleAdd() {
                var rowData = {};
                var allEmpty = true;
                cols.forEach((col, idx) => {
                    var val = addInputs[idx].value.trim();
                    if(val) allEmpty = false;
                    rowData[col] = val;
                });
                if(allEmpty) return;

                // Duplicate Guard
                var currentList = [];
                try { currentList = JSON.parse(hiddenInput.value); } catch(e) {}
                var isDuplicate = currentList.some(function(existingItem) {
                    return cols.every(function(col) { return (existingItem[col] || "") === (rowData[col] || ""); });
                });

                if (isDuplicate) {
                    addInputs.forEach(function(input) {
                        input.classList.remove('invalid'); void input.offsetWidth; input.classList.add('invalid');
                        setTimeout(function() { input.classList.remove('invalid'); }, 400);
                    });
                    return; 
                }

                renderRow(rowData);
                updateJSON();
                addInputs.forEach(i => i.value = '');
                addInputs[0].focus();
            }

            function renderRow(dataObj) {
                var row = document.createElement('div');
                row.className = 'ezd-list-item ezd-grid-layout-data'; 
                var currentRowData = dataObj;
                var mode = 'VIEW'; 

                function updateView() {
                    row.innerHTML = ''; 
                    row.className = 'ezd-list-item ezd-grid-layout-data';

                    if (mode === 'EDIT') {
                        row.classList.add('editing');
                        var editInputs = [];
                        cols.forEach(col => {
                            var val = typeof currentRowData === 'object' ? (currentRowData[col] || '') : currentRowData;
                            var input = document.createElement('input');
                            input.value = val;
                            input.addEventListener('keydown', function(e) { 
                if (e.key === 'Enter') { 
                    audio.play('click'); // Play sound
                    handleAdd(); 
                } 
            });
                            row.appendChild(input);
                            editInputs.push({input: input, key: col});
                        });
                        var actions = document.createElement('div');
                        actions.className = 'ezd-action-col';
                        actions.innerHTML = `<div class="ezd-icon-btn save" title="Save"><i class="fas fa-check"></i></div><div class="ezd-icon-btn cancel" title="Cancel"><i class="fas fa-times"></i></div>`;
                        row.appendChild(actions);
                        actions.querySelector('.save').onclick = save;
                        actions.querySelector('.cancel').onclick = () => { mode = 'VIEW'; updateView(); };
                        setTimeout(() => editInputs[0].input.focus(), 50);

                        function save() {
                            var newData = {};
                            editInputs.forEach(item => newData[item.key] = item.input.value);
                            currentRowData = newData; mode = 'VIEW'; updateView(); updateJSON();
                        }

                    } else if (mode === 'DANGER') {
                        row.classList.add('danger-mode');
                        cols.forEach(col => {
                            var val = typeof currentRowData === 'object' ? (currentRowData[col] || '') : currentRowData;
                            var input = document.createElement('input');
                            input.value = val; input.disabled = true; input.style.opacity = '0.5';
                            row.appendChild(input);
                        });
                        var actions = document.createElement('div');
                        actions.className = 'ezd-action-col';
                        actions.innerHTML = `<button class="ezd-btn-confirm">DELETE</button><button class="ezd-btn-cancel">CANCEL</button>`;
                        row.appendChild(actions);
                        actions.querySelector('.ezd-btn-confirm').onclick = () => {
                            row.classList.add('deleting');
                            setTimeout(() => { 
                                row.remove(); 
                                updateJSON(); 
                                // toggleEmptyState called inside updateJSON
                            }, 400);
                        };
                        actions.querySelector('.ezd-btn-cancel').onclick = () => { mode = 'VIEW'; updateView(); };

                    } else {
                        cols.forEach(col => {
                            var val = typeof currentRowData === 'object' ? (currentRowData[col] || '') : currentRowData;
                            var input = document.createElement('input');
                            input.value = val; input.readOnly = true; 
                            row.appendChild(input);
                        });
                        var actions = document.createElement('div');
                        actions.className = 'ezd-action-col';
                        actions.innerHTML = `<div class="ezd-icon-btn edit" title="Edit"><i class="fas fa-pen"></i></div><div class="ezd-icon-btn delete" title="Delete"><i class="fas fa-trash"></i></div>`;
                        row.appendChild(actions);
                        actions.querySelector('.edit').onclick = () => { mode = 'EDIT'; updateView(); };
                        actions.querySelector('.delete').onclick = () => { mode = 'DANGER'; updateView(); };
                    }
                }
                updateView();
                // Insert before first child (which might be the empty state div)
                listContainer.insertBefore(row, listContainer.firstChild);
                toggleEmptyState();
            }

            function updateJSON() {
                var allData = [];
                // Filter out deleting rows or invisible ones
                listContainer.querySelectorAll('.ezd-list-item').forEach(row => {
                    if(row.style.opacity === '0' || row.classList.contains('deleting')) return;
                    var rowObj = {};
                    var inputs = row.querySelectorAll('input');
                    if(inputs.length >= cols.length) {
                         cols.forEach((col, idx) => { rowObj[col] = inputs[idx].value; });
                         allData.push(rowObj);
                    }
                });
                hiddenInput.value = JSON.stringify(allData);
                var event = new CustomEvent('change', { bubbles: true, detail: { internal: true } });
                hiddenInput.dispatchEvent(event);
                
                toggleEmptyState();
            }

            // Init Check
            if(config.value) {
                try {
                    var initialItems = typeof config.value === 'string' ? JSON.parse(config.value) : config.value;
                    if(Array.isArray(initialItems) && initialItems.length > 0) {
                        // Loop backward for insertBefore order
                        for(var i = initialItems.length - 1; i >= 0; i--) {
                            var item = initialItems[i];
                            if(typeof item !== 'object') { var obj = {}; obj[cols[0]] = item; renderRow(obj); } 
                            else { renderRow(item); }
                        }
                        updateJSON();
                    } else {
                        toggleEmptyState();
                    }
                } catch(e) { console.error("Bad List JSON", e); toggleEmptyState(); }
            } else {
                toggleEmptyState(); // Ensure empty state shows if no value provided
            }
            return wrapper;
        },

        // UPDATED setValue to accept 'extra' (Mode Preference)
        setValue: function(id, val, extra) {
            var el = document.getElementById(id);
            if (!el) return;

            // 1. COMPONENT HOOK (Now passes 'extra' param)
            if (typeof el._fds_update === 'function') {
                el._fds_update(val, extra);
            } 
            
            // 2. LIST MANAGER 
            else if (el.classList.contains('ezd-list-input')) {
                el.value = (typeof val === 'object') ? JSON.stringify(val) : val;
            }
            // 3. RANGE SLIDERS
            else if (el.type === 'range') {
                el.value = val;
                var track = el.previousElementSibling ? el.previousElementSibling.querySelector('.ezd-track-fill') : null;
                var min = parseFloat(el.min) || 0; 
                var max = parseFloat(el.max) || 100;
                var perc = ((val - min) * 100) / (max - min);
                if (track) track.style.width = perc + '%';
                
                var container = el.closest('.ezd-slider-container');
                var display = container ? container.querySelector('.val-input') : null;
                if (display) display.value = val;
            }
            // 4. UNIT INPUTS
            else if (el.closest('.ezd-input-wrapper') && el.closest('.ezd-input-wrapper').querySelector('.ezd-unit-suffix')) {
                el.value = val;
                var ghost = el.closest('.ezd-input-wrapper').querySelector('.ezd-ghost-span');
                if (ghost) ghost.textContent = val;
            }
            // 5. STANDARD INPUTS
            else {
                el.value = (typeof val === 'object' && val !== null) ? JSON.stringify(val) : val;
            }

            // 6. EVENTS
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            
            if (this._utils && this._utils.flashInput) {
                this._utils.flashInput(el, 'valid');
            }
        },

        // 4. PERMISSION SYSTEM (RBAC) - Final Polish
        setRole: function(role, container) {
            const root = container || document.body;
            const isViewer = (role === 'viewer' || role === 'volunteer');
            
            // 1. Toggle Visuals
            if (isViewer) {
                root.classList.add('ezd-mode-viewer');
                // Redact Passwords
                root.querySelectorAll('[data-type="password"] input').forEach(inp => {
                    if (!inp.dataset.realValue) inp.dataset.realValue = inp.value;
                    const randomLen = Math.floor(Math.random() * 16) + 8; 
                    inp.type = "text"; inp.value = "".repeat(randomLen);
                    inp.style.fontFamily = "monospace"; inp.style.letterSpacing = "-1px"; inp.style.color = "#cbd5e1";
                });
            } else {
                root.classList.remove('ezd-mode-viewer');
                // Restore Passwords
                root.querySelectorAll('[data-type="password"] input').forEach(inp => {
                    if (inp.dataset.realValue !== undefined) {
                        inp.value = inp.dataset.realValue; delete inp.dataset.realValue;
                    }
                    inp.type = "password"; inp.style.fontFamily = ""; inp.style.letterSpacing = ""; inp.style.color = "";
                });
            }

            // 2. Physical Toggle (Smart Filter)
            const inputs = root.querySelectorAll('input, select, textarea, button');
            inputs.forEach(el => {
                // EXCLUSION LIST: Things that must stay active in Viewer Mode
                if(el.classList.contains('ezd-list-search-input')) return; // Search
                if(el.classList.contains('ezd-tab-btn')) return;           // Tabs (Navigation)
                
                el.disabled = isViewer;
            });

            console.log(` System Permission set to: ${role.toUpperCase()}`);
        },

        // 5. UPLOAD HELPER (Updated with Local Mock Mode)
        uploadData: function(id) {
            const hiddenData = document.getElementById(id + '_data'); 
            const hiddenName = document.getElementById(id);           
            const hiddenMime = document.getElementById(id + '_mime'); 
            
            if(!hiddenData || !hiddenData.value) {
                console.log(" No file data pending upload.");
                return Promise.resolve(null);
            }

            return new Promise((resolve, reject) => {
                // A. Local Testing Mode (Safety Net)
                if (typeof google === 'undefined') {
                    console.warn(" Google Env not found. Simulating Upload...");
                    setTimeout(() => {
                        const mockUrl = "https://drive.google.com/uc?id=MOCK_ID_123";
                        console.log(" Mock Upload Success:", hiddenName.value);
                        
                        // Simulate receiving a Drive URL back
                        hiddenName.value = mockUrl; 
                        hiddenData.value = ""; // Clear heavy data
                        window.EZD_UI._utils.dispatchChange(hiddenName);
                        resolve({ status: 'mock_success', url: mockUrl });
                    }, 1500);
                    return;
                }

                // B. Real Google Production Mode
                google.script.run
                    .withSuccessHandler(function(response) {
                        console.log(" Upload Success:", response);
                        hiddenName.value = response.url; 
                        hiddenData.value = ""; // Clear data to free memory
                        window.EZD_UI._utils.dispatchChange(hiddenName);
                        resolve(response);
                    })
                    .withFailureHandler(function(err) {
                        console.error(" Upload Failed", err);
                        reject(err);
                    })
                    .uploadFileToDrive(hiddenData.value, hiddenName.value, hiddenMime.value);
            });
        },

        setButtonState: (id, state, customLabel) => {
            // Find the actual button inside the wrapper (or the element itself)
            let btn = document.getElementById(id);
            if (!btn) return;
            
            // If it's a wrapper div, find the inner button
            if (btn.tagName !== 'BUTTON') {
                const inner = btn.querySelector('button');
                if (inner) btn = inner;
            }

            // Remove all state classes
            btn.classList.remove('idle', 'dirty', 'saving', 'success', 'error');
            btn.classList.add(state);

            // STATE MACHINE
            let icon = 'fa-save';
            let text = customLabel || btn.dataset.originalLabel || 'Save Changes';

            if (state === 'idle') {
                // Keep original text
                btn.disabled = true; // Optional: Prevent clicking empty saves
            } 
            else if (state === 'dirty') {
                icon = 'fa-save';
                // REMOVED: if (!customLabel) text = ... + '*'; 
                // FIXED: Just use the label. The "Purple Color" is enough indication.
                if (!customLabel) text = (btn.dataset.originalLabel || 'Save Changes'); 
                btn.disabled = false;
            }
            else if (state === 'saving') {
                icon = 'fa-circle-notch fa-spin'; // Spinner
                text = 'Saving...';
                btn.disabled = true;
            } 
            else if (state === 'success') {
                icon = 'fa-check';
                text = 'Saved!';
                if (typeof audio !== 'undefined') audio.play('success');
                
                // Auto-Reset to Idle after 2s
                setTimeout(() => {
                    EZD_UI.setButtonState(id, 'idle');
                }, 2000);
            } 
            else if (state === 'error') {
                icon = 'fa-exclamation-triangle';
                text = 'Failed';
                if (typeof audio !== 'undefined') audio.play('error'); // The soft bonk
                
                // Auto-Reset to Dirty (let them try again)
                setTimeout(() => {
                    EZD_UI.setButtonState(id, 'dirty', 'Retry Save');
                }, 2000);
            }

            // Apply HTML
            btn.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        },

        getComponentValue: (id) => { const el = document.getElementById(id); return el ? el.value : null; },

        resetForm: (container) => {
            if(!container) return;
            container.querySelectorAll('.ezd-store').forEach(h => { h.value = ""; window.EZD_UI.setValue(h.id, ""); });
            container.querySelectorAll('input:not([type="hidden"])').forEach(i => { if(i.id !== 'SystemID') i.value = ""; });
        }
    };
})();
// --- GLOBAL HANDLERS (Fixed Scroll & Click) ---

// --- GLOBAL HANDLERS ---
document.addEventListener('mousedown', function(e) {
    if (!window.EZD_UI || !window.EZD_UI._utils) return;
    
    // Check if we clicked inside ANY valid menu system
    const isMenu = e.target.closest('.ezd-select-menu, .multiselect-menu, .ezd-search-results, .ezd-drum-wrapper');
    const isTrigger = e.target.closest('.ezd-select-trigger, .multiselect-trigger, .ezd-smart-input');
    
    // If we clicked strictly outside, close everything
    if (!isMenu && !isTrigger) {
        window.EZD_UI._utils.closeAllMenus();
    }
}, true);
window.EZD_UI_READY = true;
window.dispatchEvent(new CustomEvent('fdsLibraryReady'));
console.log(" FDS UI Library v4.0 (Direct Mode)");
</script>
